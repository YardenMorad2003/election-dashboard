<!-- Updated: Wed Jan 29 2026 - Added K21 and K22 party data -->
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>השוואת בחירות: כנסת 14 עד כנסת 25</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ========== BASE STYLES ========== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #070d18;
    --bg-secondary: #0a1628;
    --bg-card: rgba(15, 31, 61, 0.6);
    --bg-card-hover: rgba(20, 40, 80, 0.8);
    --border-color: rgba(74, 158, 255, 0.2);
    --text-primary: #ffffff;
    --text-secondary: #8ba3c7;
    --text-muted: #5a7194;
    
    --color-right: #4a9eff;
    --color-haredi: #9b59b6;
    --color-center: #2ecc71;
    --color-left: #e74c3c;
    --color-arab: #f39c12;
    --color-opposition-right: #00bcd4;
    --color-right-haredi: #4a9eff;
    --color-center-left-arab: #ff6b6b;
    
    --color-positive: #2ecc71;
    --color-negative: #e74c3c;
}

body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
}

/* ========== HEADER ========== */
.header {
    text-align: center;
    padding: 2rem 1rem;
    background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    border-bottom: 1px solid var(--border-color);
}

.header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #fff 0%, #8ba3c7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header .subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

/* ========== NAVIGATION ========== */
.nav {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
}

.nav-btn {
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.nav-btn.active {
    background: var(--color-right-haredi);
    color: white;
    border-color: var(--color-right-haredi);
}

/* ========== SECTIONS ========== */
.section {
    display: none;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.section.active {
    display: block;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
}

/* ========== ELECTION SELECTOR ========== */
.election-selector {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.selector-title {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    text-align: right;
}

.selector-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
}

.selector-label {
    color: var(--text-muted);
    min-width: 30px;
}

.election-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.election-btn:hover {
    background: var(--bg-card-hover);
}

.election-btn.selected {
    background: var(--color-right-haredi);
    color: white;
    border-color: var(--color-right-haredi);
}

/* ========== METRIC CARDS ========== */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
}

.metric-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.metric-value.blue { color: var(--color-right-haredi); }
.metric-value.red { color: var(--color-center-left-arab); }

.metric-change {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.metric-change.positive {
    background: rgba(46, 204, 113, 0.2);
    color: var(--color-positive);
}

.metric-change.negative {
    background: rgba(231, 76, 60, 0.2);
    color: var(--color-negative);
}

/* ========== SUB-GROUPS ========== */
.subgroups-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

@media (max-width: 900px) {
    .subgroups-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 600px) {
    .subgroups-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.subgroup-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
}

.subgroup-title {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    text-align: center;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

.subgroup-title.right { border-color: var(--color-right); }
.subgroup-title.haredi { border-color: var(--color-haredi); }
.subgroup-title.center { border-color: var(--color-center); }
.subgroup-title.opposition_right { border-color: var(--color-opposition-right); }
.subgroup-title.left { border-color: var(--color-left); }
.subgroup-title.arab { border-color: var(--color-arab); }

.subgroup-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
}

.subgroup-election {
    color: var(--text-muted);
}

.subgroup-value {
    font-weight: 600;
}

.subgroup-value.right { color: var(--color-right); }
.subgroup-value.haredi { color: var(--color-haredi); }
.subgroup-value.center { color: var(--color-center); }
.subgroup-value.opposition_right { color: var(--color-opposition-right); }
.subgroup-value.left { color: var(--color-left); }
.subgroup-value.arab { color: var(--color-arab); }

/* Large bloc summary boxes */
.large-bloc-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
    grid-column: 1 / -1;
}

.large-bloc-card {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    border: 2px solid;
}

.large-bloc-card.right-haredi {
    border-color: var(--color-right);
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(155, 89, 182, 0.1));
}

.large-bloc-card.center-left-arab {
    border-color: var(--color-left);
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(46, 204, 113, 0.1));
}

.large-bloc-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.large-bloc-values {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 0.75rem;
}

.large-bloc-row {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.large-bloc-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.large-bloc-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.large-bloc-change {
    margin-top: 0.5rem;
}

.large-bloc-change .metric-change {
    font-size: 1.1rem;
    padding: 0.4rem 1rem;
}

/* Party cards */
.parties-section {
    grid-column: 1 / -1;
    margin-top: 1rem;
}

/* K17 Party Table */
.party-table-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.party-table-title {
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.party-table {
    width: 100%;
    border-collapse: collapse;
}

.party-table th,
.party-table td {
    padding: 0.6rem 1rem;
    text-align: right;
    border-bottom: 1px solid var(--border-color);
}

.party-table th {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.85rem;
}

.party-table tbody tr:hover {
    background: var(--bg-card-hover);
}

.party-table .bloc-right { color: var(--color-right); }
.party-table .bloc-haredi { color: var(--color-haredi); }
.party-table .bloc-center { color: var(--color-center); }
.party-table .bloc-opposition_right { color: var(--color-opposition-right); }
.party-table .bloc-left { color: var(--color-left); }
.party-table .bloc-arab { color: var(--color-arab); }

.parties-title {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.parties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
}

.party-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.8rem;
}

.party-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.party-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.2rem;
}

.party-election {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.party-value {
    font-weight: 500;
    color: var(--text-primary);
}

/* ========== CHARTS ========== */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 500px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

.chart-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.chart-title {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    text-align: center;
}

.chart-wrapper {
    position: relative;
    height: 300px;
}

/* ========== LOCALITY TABLE ========== */
.table-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    gap: 1rem;
}

.table-title {
    font-size: 1.1rem;
    color: var(--text-primary);
}

.table-filters {
    display: flex;
    gap: 0.5rem;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn:hover {
    background: var(--bg-card-hover);
}

.filter-btn.active {
    background: var(--color-right-haredi);
    color: white;
    border-color: var(--color-right-haredi);
}

.search-box {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 1rem;
    width: 100%;
    max-width: 300px;
}

.search-box::placeholder {
    color: var(--text-muted);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem 1rem;
    text-align: right;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.85rem;
    position: sticky;
    top: 0;
}

.data-table th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
}

.data-table th.sortable:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.data-table th.sortable.active {
    background: var(--bg-card-hover);
    color: var(--accent-blue);
}

.sort-indicator {
    margin-right: 0.3rem;
    font-size: 0.7rem;
}

.sort-indicator::after {
    content: '⇅';
    opacity: 0.4;
}

.data-table th.sortable.asc .sort-indicator::after {
    content: '▲';
    opacity: 1;
}

.data-table th.sortable.desc .sort-indicator::after {
    content: '▼';
    opacity: 1;
}

.data-table tbody tr {
    cursor: pointer;
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: var(--bg-card-hover);
}

.data-table td {
    font-size: 0.9rem;
}

.table-scroll {
    max-height: 500px;
    overflow-y: auto;
}

/* ========== LOCALITY DETAIL ========== */
.locality-detail {
    display: none;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.locality-detail.active {
    display: block;
}

.locality-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.locality-name {
    font-size: 1.5rem;
    font-weight: 700;
}

.close-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-secondary);
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: var(--color-negative);
    color: white;
    border-color: var(--color-negative);
}

/* ========== TREND SECTION ========== */
.trend-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
}

.trend-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.trend-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
}

.trend-item {
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-card);
    border-radius: 6px;
}

.trend-election {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.trend-value {
    font-size: 1rem;
    font-weight: 600;
}

.trend-value.positive { color: var(--color-negative); } /* Left trend = red */
.trend-value.negative { color: var(--color-right); } /* Right trend = blue */
.trend-value.neutral { color: var(--text-secondary); }

.trend-summary {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.trend-total {
    font-size: 1.2rem;
    font-weight: 700;
}

.trend-label {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* ========== REGRESSION MODEL ========== */
.model-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--border-color);
}

.model-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.model-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #4a9eff 0%, #9b59b6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.model-header .badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    background: rgba(74, 158, 255, 0.15);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 20px;
    color: var(--color-right);
    font-weight: 600;
    letter-spacing: 0.05em;
}

.model-subtitle {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 2rem;
}

.model-tabs {
    display: flex;
    gap: 0.35rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.model-tab {
    padding: 0.6rem 1.2rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.model-tab:hover {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.model-tab.active {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.25), rgba(155, 89, 182, 0.25));
    color: white;
    border-color: rgba(74, 158, 255, 0.5);
}

.model-panel {
    display: none;
}

.model-panel.active {
    display: block;
}

/* Feature Importance */
.importance-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.importance-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.importance-card h3 {
    font-size: 1.05rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.feature-bar-item {
    margin-bottom: 0.75rem;
}

.feature-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    margin-bottom: 0.3rem;
    color: var(--text-secondary);
}

.feature-bar-label .val {
    font-weight: 600;
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
}

.feature-bar-track {
    height: 8px;
    background: rgba(255, 255, 255, 0.06);
    border-radius: 4px;
    overflow: hidden;
}

.feature-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
}

.model-r2-box {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.r2-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 1rem 1.5rem;
    text-align: center;
    flex: 1;
    min-width: 140px;
}

.r2-card .label {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
}

.r2-card .value {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, #4a9eff, #2ecc71);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.r2-card .sub {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

/* Outliers */
.outlier-table-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.outlier-table-container h3 {
    padding: 1rem 1.5rem;
    font-size: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.outlier-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.outlier-table th {
    text-align: right;
    padding: 0.75rem 1rem;
    color: var(--text-muted);
    font-weight: 500;
    border-bottom: 1px solid var(--border-color);
    white-space: nowrap;
}

.outlier-table td {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid rgba(74, 158, 255, 0.07);
}

.outlier-table tr:hover {
    background: rgba(74, 158, 255, 0.05);
}

.residual-positive {
    color: var(--color-right);
    font-weight: 600;
}

.residual-negative {
    color: var(--color-negative);
    font-weight: 600;
}

/* Prediction */
.predictor-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.predictor-inputs {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.predictor-inputs h3 {
    font-size: 1rem;
    margin-bottom: 1rem;
}

.pred-input-group {
    margin-bottom: 1rem;
}

.pred-input-group label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.3rem;
}

.pred-input-group input[type="range"] {
    width: 100%;
    direction: ltr;
    accent-color: var(--color-right);
}

.pred-input-group .range-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.2rem;
}

.pred-input-group .range-info .current {
    color: var(--color-right);
    font-weight: 600;
}

.predictor-result {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.prediction-gauge {
    width: 200px;
    height: 200px;
    position: relative;
    margin-bottom: 1rem;
}

.prediction-value {
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(135deg, #4a9eff, #9b59b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
}

.prediction-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 0.5rem;
}

.prediction-bar {
    width: 100%;
    max-width: 280px;
    margin-top: 1rem;
}

.prediction-bar-track {
    height: 28px;
    background: linear-gradient(to right, var(--color-negative), var(--color-right));
    border-radius: 14px;
    position: relative;
    overflow: visible;
}

.prediction-bar-marker {
    position: absolute;
    top: -4px;
    width: 4px;
    height: 36px;
    background: white;
    border-radius: 2px;
    transform: translateX(-50%);
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    transition: left 0.4s ease;
}

.prediction-bar-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.3rem;
}

.pred-compare-note {
    margin-top: 1rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    text-align: center;
}

/* Time trends */
.trends-explanation {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .importance-grid, .predictor-container {
        grid-template-columns: 1fr;
    }
}

/* ========== SOCIOECONOMIC SCATTER ========== */
.scatter-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 900px) {
    .scatter-grid {
        grid-template-columns: 1fr;
    }
}

/* ========== LEGEND ========== */
.legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-card);
    border-radius: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* ========== TOP MOVERS ========== */
.movers-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

@media (max-width: 700px) {
    .movers-grid {
        grid-template-columns: 1fr;
    }
}

.movers-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.movers-header {
    padding: 1rem;
    font-weight: 600;
    font-size: 0.9rem;
    border-bottom: 1px solid var(--border-color);
}

.movers-header.blue {
    background: rgba(74, 158, 255, 0.1);
    color: var(--color-right-haredi);
}

.movers-header.red {
    background: rgba(255, 107, 107, 0.1);
    color: var(--color-center-left-arab);
}

.mover-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.mover-row:last-child {
    border-bottom: none;
}

.mover-name {
    color: var(--text-primary);
}

.mover-change {
    font-weight: 600;
}

.mover-change.positive { color: var(--color-positive); }
.mover-change.negative { color: var(--color-negative); }

/* ========== LOADING ========== */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: var(--text-secondary);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--color-right-haredi);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ========== UTILITIES ========== */
.text-center { text-align: center; }

/* ========== MAP SECTION ========== */
#mapview {
    padding: 1rem;
    max-width: none;
}

.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }

/* ========== CORRELATION MATRIX ========== */
.correlation-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
}

.correlation-matrices-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1rem;
}

@media (max-width: 1200px) {
    .correlation-matrices-grid {
        grid-template-columns: 1fr;
    }
}

.correlation-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.correlation-matrix {
    display: grid;
    gap: 2px;
    overflow-x: auto;
    margin-bottom: 1rem;
}

.correlation-cell {
    min-width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.correlation-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10;
}

.correlation-cell.header {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 0.6rem;
    font-weight: 500;
    cursor: default;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    min-height: 70px;
    height: auto;
    padding: 0.5rem 0.25rem;
}

.correlation-cell.header:hover {
    transform: rotate(180deg);
    box-shadow: none;
}

.correlation-cell.row-header {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 0.6rem;
    font-weight: 500;
    cursor: default;
    writing-mode: horizontal-tb;
    justify-content: flex-end;
    padding-right: 0.5rem;
    min-width: 80px;
}

.correlation-cell.row-header:hover {
    transform: none;
    box-shadow: none;
}

.correlation-cell.diagonal {
    background: var(--bg-secondary);
    color: var(--text-muted);
}

.correlation-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.correlation-scale {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.correlation-gradient {
    width: 150px;
    height: 16px;
    border-radius: 4px;
    background: linear-gradient(to right, #e74c3c, #f5f5f5, #2ecc71);
}

.correlation-note {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.correlation-tooltip {
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    max-width: 280px;
    display: none;
}

.correlation-tooltip.active {
    display: block;
}

.correlation-tooltip h4 {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.correlation-tooltip p {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.correlation-tooltip .value {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    margin: 0.5rem 0;
}

.correlation-tooltip .value.positive { color: #2ecc71; }
.correlation-tooltip .value.negative { color: #e74c3c; }
.correlation-tooltip .value.neutral { color: var(--text-muted); }

/* ========== COALITION BUILDER ========== */
.national-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
}

@media (max-width: 1200px) {
    .national-layout {
        grid-template-columns: 1fr;
    }
}

.national-main {
    min-width: 0;
}

.coalition-builder {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    position: sticky;
    top: 80px;
    height: fit-content;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

.coalition-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.coalition-title {
    font-size: 1.1rem;
    font-weight: 600;
}

.coalition-select {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.85rem;
    cursor: pointer;
}

.coalition-counter {
    text-align: center;
    margin-bottom: 0.75rem;
}

.coalition-seats {
    font-size: 2rem;
    font-weight: 700;
}

#coalition-count {
    color: var(--text-primary);
}

.coalition-target {
    color: var(--text-muted);
}

.coalition-status {
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

.coalition-status.success {
    color: var(--color-positive);
}

.coalition-status.pending {
    color: var(--text-muted);
}

.coalition-progress {
    height: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
}

.coalition-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--color-right) 0%, var(--color-positive) 100%);
    border-radius: 6px;
    transition: width 0.3s ease;
    width: 0%;
}

.coalition-progress-bar.success {
    background: var(--color-positive);
}

.coalition-threshold {
    position: absolute;
    left: 50.83%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--color-negative);
}

.coalition-parties {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.coalition-party {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.75rem;
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.coalition-party:hover {
    background: var(--bg-card-hover);
}

.coalition-party.selected {
    border-color: var(--color-positive);
    background: rgba(46, 204, 113, 0.1);
}

.coalition-party-color {
    width: 8px;
    height: 100%;
    min-height: 24px;
    border-radius: 4px;
}

.coalition-party-info {
    flex: 1;
    min-width: 0;
}

.coalition-party-name {
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.coalition-party-seats {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-secondary);
}

.coalition-reset {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: transparent;
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.coalition-reset:hover {
    background: var(--color-negative);
    border-color: var(--color-negative);
    color: white;
}

/* ========== MOBILE RESPONSIVE ========== */
@media (max-width: 768px) {
    .header {
        padding: 1rem 0.75rem;
    }
    .header h1 {
        font-size: 1.4rem;
    }
    .header .subtitle {
        font-size: 0.85rem;
    }
    
    /* Nav becomes scrollable horizontal strip */
    .nav {
        gap: 0.3rem;
        padding: 0.6rem;
        overflow-x: auto;
        justify-content: flex-start;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .nav::-webkit-scrollbar { display: none; }
    .nav-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.75rem;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    /* Sections */
    .section {
        padding: 1rem 0.75rem;
    }
    .section-title {
        font-size: 1.2rem;
    }
    
    /* Election selector */
    .election-selector {
        padding: 1rem;
    }
    .selector-row {
        gap: 0.4rem;
    }
    .election-btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
    }
    
    /* Metric cards */
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.6rem;
    }
    .metric-card {
        padding: 0.8rem;
    }
    .metric-value {
        font-size: 1.4rem;
    }
    .metric-label {
        font-size: 0.75rem;
    }
    
    /* Sub-groups */
    .subgroups-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
    }
    
    /* Charts */
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    .chart-container {
        padding: 1rem;
    }
    .chart-wrapper {
        height: 220px;
    }
    
    /* Tables */
    .table-container {
        overflow-x: auto;
    }
    .table-container table {
        min-width: 600px;
    }
    
    /* Scatter plots */
    .scatter-grid {
        grid-template-columns: 1fr;
    }
    
    /* Movers */
    .movers-grid {
        grid-template-columns: 1fr;
    }
    
    /* Correlation matrices */
    .correlation-matrices-grid {
        grid-template-columns: 1fr;
    }
    .correlation-cell {
        min-width: 36px;
        height: 36px;
        font-size: 0.6rem;
    }
    .correlation-cell.row-header {
        min-width: 60px;
        font-size: 0.55rem;
    }
    
    /* National layout (coalition builder) */
    .national-layout {
        grid-template-columns: 1fr;
    }
    
    /* Coalition parties grid */
    .coalition-parties {
        grid-template-columns: 1fr !important;
    }
    
    /* Legend */
    .legend {
        gap: 0.75rem;
        padding: 0.75rem;
    }
    .legend-item {
        font-size: 0.75rem;
    }
    
    /* Disclosures */
    .disclosures-container {
        padding: 1rem !important;
    }
    
    /* Map iframe */
    #mapview {
        padding: 0.5rem;
    }
    #mapview > div {
        height: calc(100vh - 100px) !important;
        border-radius: 8px;
    }
}
    </style>
</head>
<body>
    <!-- ========== HEADER ========== -->
    <header class="header">
        <h1>השוואת בחירות: כנסת 14 עד כנסת 25</h1>
        <p class="subtitle">תוצאות ארציות | 12 מערכות בחירות (1996-2022)</p>
    </header>

    <!-- ========== NAVIGATION ========== -->
    <nav class="nav">
        <button class="nav-btn" data-section="disclosures">אודות ומתודולוגיה</button>
        <button class="nav-btn active" data-section="national">תוצאות ארציות</button>
        <button class="nav-btn" data-section="localities">ניתוח לפי ישובים (1,391)</button>
        <button class="nav-btn" data-section="socioeconomic">ניתוח סוציו-אקונומי (<span id="socio-count">201</span>)</button>
        <button class="nav-btn" data-section="mapview">🗺️ מפה אינטראקטיבית</button>
    </nav>

    <!-- ==================== SECTION: DISCLOSURES ==================== -->
    <section id="disclosures" class="section">
        <div class="disclosures-container" style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
            
            <h2 style="color: var(--text-primary); margin-bottom: 2rem; text-align: center;">אודות הדשבורד ומתודולוגיה</h2>
            
            <!-- Data Sources -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">📊 מקורות המידע</h3>
                <ul style="color: var(--text-secondary); line-height: 2;">
                    <li><strong>תוצאות בחירות:</strong> ועדת הבחירות המרכזית</li>
                    <li><strong>אחוזי הצבעה:</strong> ועדת הבחירות המרכזית</li>
                    <li><strong>נתונים סוציו-אקונומיים:</strong> הלשכה המרכזית לסטטיסטיקה (הלמ"ס)</li>
                    <li><strong>נתוני דת ו"רוסים":</strong> הלמ"ס - נתוני אוכלוסייה 2019</li>
                </ul>
            </div>

            <!-- Bloc Definitions -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">🏛️ הגדרת הגושים</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">המפלגות מחולקות ל-5 קבוצות משנה שמתאגדות ל-2 גושים עיקריים:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 0.75rem; background: rgba(74, 158, 255, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-right); font-weight: 600;">ימין</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">ליכוד, ימינה, הבית היהודי...</div>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(155, 89, 182, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-haredi); font-weight: 600;">חרדים</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">ש"ס, יהדות התורה</div>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(0, 188, 212, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-opposition-right); font-weight: 600;">ימין אופוזיציוני</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">ישראל ביתנו (כ21-25), ימינה ותקווה חדשה (כ24)</div>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(46, 204, 113, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-center); font-weight: 600;">מרכז</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">יש עתיד, כחול לבן, קדימה...</div>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(231, 76, 60, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-left); font-weight: 600;">שמאל</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">העבודה, מרצ</div>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(243, 156, 18, 0.2); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-arab); font-weight: 600;">ערבים</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">רע"מ, חד"ש, בל"ד...</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div style="padding: 1rem; background: rgba(74, 158, 255, 0.1); border: 2px solid var(--color-right); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-right); font-weight: 700; font-size: 1.1rem;">ימין-חרדים</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">ימין + חרדים</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(255, 107, 107, 0.1); border: 2px solid var(--color-center-left-arab); border-radius: 8px; text-align: center;">
                        <div style="color: var(--color-center-left-arab); font-weight: 700; font-size: 1.1rem;">מרכז-שמאל-ערבים</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">מרכז + שמאל + ערבים</div>
                    </div>
                </div>
                
                <details style="margin-top: 1.5rem;">
                    <summary style="color: var(--text-primary); cursor: pointer; font-weight: 500;">📋 פירוט מפלגות לפי בחירות (לחץ להרחבה)</summary>
                    <div id="bloc-details" style="margin-top: 1rem; max-height: 400px; overflow-y: auto; font-size: 0.85rem;"></div>
                </details>
            </div>

            <!-- Russians Definition -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">🇷🇺 הגדרת "רוסים"</h3>
                <p style="color: var(--text-secondary); line-height: 1.8;">
                    המונח <strong>"רוסים"</strong> בדשבורד מתייחס לתושבים <strong>ללא סיווג דת</strong> בנתוני הלמ"ס. 
                    קבוצה זו כוללת בעיקר עולים מברית המועצות לשעבר ומדינות חבר העמים שאינם מוגדרים כיהודים על פי ההלכה, 
                    אך עלו לישראל מכוח חוק השבות (נכדי יהודים, בני זוג וכו').
                </p>
                <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.9rem;">
                    נתוני הדת זמינים רק מ-2019, ולכן ניתוח "רוסים" מוצג רק עבור כנסת 21 ואילך.
                </p>
            </div>

            <!-- Demographic Year Mapping -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">📅 התאמת נתונים דמוגרפיים לבחירות</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    הנתונים הסוציו-אקונומיים (הכנסה, השכלה, אשכול וכו') מותאמים לתקופת הבחירות:
                </p>
                <table style="width: 100%; border-collapse: collapse; color: var(--text-secondary);">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 0.5rem; text-align: right;">בחירות</th>
                            <th style="padding: 0.5rem; text-align: right;">שנת נתונים</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 0.5rem;">כנסת 24-25 (2021-2022)</td><td style="padding: 0.5rem;">2021</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 21-23 (2019-2020)</td><td style="padding: 0.5rem;">2019</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 20 (2015)</td><td style="padding: 0.5rem;">2015</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 19 (2013)</td><td style="padding: 0.5rem;">2013</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 18 (2009)</td><td style="padding: 0.5rem;">2008</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 17 (2006)</td><td style="padding: 0.5rem;">2006 (אשכול) + 2008 (שאר)</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 16 (2003)</td><td style="padding: 0.5rem;">2003 (אשכול) + 2008 (שאר)</td></tr>
                        <tr><td style="padding: 0.5rem;">כנסת 14-15 (1996-1999)</td><td style="padding: 0.5rem;">1999 (אשכול) + 2008 (שאר)</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Correlation Methodology -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">📈 חישוב מתאמים</h3>
                <p style="color: var(--text-secondary); line-height: 1.8;">
                    המתאמים (correlations) מחושבים באמצעות <strong>מתאם פירסון משוקלל</strong>, 
                    כאשר המשקל הוא <strong>מספר בעלי זכות הבחירה</strong> בכל יישוב.
                </p>
                <p style="color: var(--text-secondary); line-height: 1.8; margin-top: 0.5rem;">
                    שיטה זו מבטיחה שיישובים גדולים (כמו תל אביב או ירושלים) משפיעים יותר על המתאם מאשר יישובים קטנים, 
                    מה שמשקף טוב יותר את התמונה הארצית.
                </p>
            </div>

            <!-- Geographic Sorting -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">🗺️ מיון גיאוגרפי - הגדרת "משכילים"</h3>
                <p style="color: var(--text-secondary); line-height: 1.8;">
                    בגרף המיון הגיאוגרפי, יישוב מוגדר כ<strong>"משכיל"</strong> אם אחוז בעלי התואר האקדמי בו 
                    גבוה ב-<strong>0.5 סטיות תקן</strong> מעל הממוצע של כלל היישובים באותה תקופה.
                </p>
                <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.9rem;">
                    הסף הדינמי מאפשר השוואה הוגנת בין תקופות, למרות שאחוז האקדמאים עלה משמעותית לאורך השנים.
                </p>
            </div>

            <!-- Limitations -->
            <div class="disclosure-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: var(--color-center); margin-bottom: 1rem;">⚠️ מגבלות</h3>
                <ul style="color: var(--text-secondary); line-height: 2;">
                    <li>נתונים סוציו-אקונומיים זמינים רק עבור <strong>201 רשויות מקומיות</strong> (לא כולל מועצות אזוריות)</li>
                    <li>נתוני דת ו"רוסים" זמינים רק מ-<strong>2019</strong></li>
                    <li>חלק מהמפלגות התמזגו או התפצלו בין בחירות, מה שמקשה על השוואה ישירה</li>
                    <li>סיווג המפלגות לגושים הוא סובייקטיבי במידה מסוימת, במיוחד עבור מפלגות מרכז</li>
                </ul>
            </div>

        </div>
    </section>

    <!-- ==================== SECTION: NATIONAL ==================== -->
    <section id="national" class="section active">
        
        <!-- Election Selector -->
        <div class="election-selector">
            <div class="selector-title">בחר בחירות להשוואה</div>
            <div class="selector-row">
                <span class="selector-label">מ:</span>
                <div id="from-selector"></div>
            </div>
            <div class="selector-row">
                <span class="selector-label">עד:</span>
                <div id="to-selector"></div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="national-layout">
            <!-- Left Column: Existing Content -->
            <div class="national-main">
                <!-- Main Metrics -->
                <div class="section-title">נושאים ראשיים</div>
                <div class="metrics-grid" id="national-metrics"></div>

                <!-- Sub-groups -->
                <div class="section-title">תת-קבוצות</div>
                <div class="subgroups-grid" id="national-subgroups"></div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item"><span class="legend-color" style="background: var(--color-right)"></span> ימין (ליכוד, ימינה וכו׳)</div>
                    <div class="legend-item"><span class="legend-color" style="background: var(--color-haredi)"></span> חרדים (ש״ס, יהדות התורה)</div>
                    <div class="legend-item"><span class="legend-color" style="background: var(--color-center)"></span> מרכז (כחול לבן, יש עתיד וכו׳)</div>
                    <div class="legend-item"><span class="legend-color" style="background: var(--color-left)"></span> שמאל (עבודה, מרצ)</div>
                    <div class="legend-item"><span class="legend-color" style="background: var(--color-arab)"></span> ערבים (רע״מ, חד״ש, בל״ד)</div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">מגמות היסטוריות - תת-קבוצות</div>
                        <div class="chart-wrapper">
                            <canvas id="national-trends-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">השוואה בין הבחירות הנבחרות</div>
                        <div class="chart-wrapper">
                            <canvas id="national-comparison-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <div class="chart-title">מגמת הצבעה ארצית</div>
                        <div class="chart-wrapper" style="height: 250px;">
                            <canvas id="national-turnout-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Coalition Builder -->
            <div class="coalition-builder">
                <div class="coalition-header">
                    <div class="coalition-title">בניית קואליציה</div>
                    <select id="coalition-election-select" class="coalition-select">
                        <option value="14">כנסת 14 (1996)</option>
                        <option value="15">כנסת 15 (1999)</option>
                        <option value="16">כנסת 16 (2003)</option>
                        <option value="17">כנסת 17 (2006)</option>
                        <option value="18">כנסת 18 (2009)</option>
                        <option value="19">כנסת 19 (2013)</option>
                        <option value="20">כנסת 20 (2015)</option>
                        <option value="21">כנסת 21 (2019א)</option>
                        <option value="22">כנסת 22 (2019ב)</option>
                        <option value="23">כנסת 23 (2020)</option>
                        <option value="24">כנסת 24 (2021)</option>
                        <option value="25" selected>כנסת 25 (2022)</option>
                    </select>
                </div>
                <div class="coalition-counter">
                    <div class="coalition-seats">
                        <span id="coalition-count">0</span>
                        <span class="coalition-target">/ 61</span>
                    </div>
                    <div class="coalition-status" id="coalition-status">בחר מפלגות</div>
                </div>
                <div class="coalition-progress">
                    <div class="coalition-progress-bar" id="coalition-progress-bar"></div>
                    <div class="coalition-threshold"></div>
                </div>
                <div class="coalition-parties" id="coalition-parties"></div>
                <button class="coalition-reset" onclick="resetCoalition()">אפס בחירה</button>
            </div>
        </div>
    </section>

    <!-- ==================== SECTION: LOCALITIES ==================== -->
    <section id="localities" class="section">
        
        <!-- Election Selector -->
        <div class="election-selector">
            <div class="selector-title">בחר בחירות להשוואה</div>
            <div class="selector-row">
                <span class="selector-label">מ:</span>
                <div id="loc-from-selector"></div>
            </div>
            <div class="selector-row">
                <span class="selector-label">עד:</span>
                <div id="loc-to-selector"></div>
            </div>
        </div>

        <!-- Locality Detail (hidden by default) -->
        <div id="locality-detail" class="locality-detail">
            <div class="locality-header">
                <span class="locality-name" id="locality-name"></span>
                <button class="close-btn" onclick="closeLocalityDetail()">נקה בחירה</button>
            </div>
            <div class="subgroups-grid" id="locality-subgroups"></div>
            <!-- K17 Party Table (shows only when K17 is selected) -->
            <div id="party-table-container" class="party-table-container" style="display: none;">
                <div class="party-table-title">תוצאות לפי מפלגה - כנסת 17</div>
                <table class="party-table">
                    <thead>
                        <tr>
                            <th>מפלגה</th>
                            <th>גוש</th>
                            <th>אחוז</th>
                        </tr>
                    </thead>
                    <tbody id="party-table-body"></tbody>
                </table>
            </div>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">מגמות היסטוריות - גושים</div>
                    <div class="chart-wrapper">
                        <canvas id="locality-blocs-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">מגמות היסטוריות - תת-קבוצות</div>
                    <div class="chart-wrapper">
                        <canvas id="locality-trends-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="charts-grid" style="margin-top: 1.5rem;">
                <div class="chart-container">
                    <div class="chart-title">מגמה: פער מהארץ (מרכז-שמאל-ערבים)</div>
                    <div class="chart-wrapper">
                        <canvas id="locality-trend-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">מגמה: פער הצבעה מהארץ</div>
                    <div class="chart-wrapper">
                        <canvas id="locality-turnout-gap-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <div class="table-header">
                <span class="table-title">נתוני כנסת <span id="loc-selected-election">25</span> (<span id="localities-count">0</span> ישובים)</span>
                <div class="table-filters">
                    <button class="filter-btn active" data-filter="all">הכל (<span id="count-all">0</span>)</button>
                    <button class="filter-btn" data-filter="full">12 בחירות מלאות (<span id="count-full">0</span>)</button>
                    <button class="filter-btn" data-filter="partial">נתונים חלקיים (<span id="count-partial">0</span>)</button>
                </div>
            </div>
            <div style="padding: 1rem;">
                <input type="text" class="search-box" id="locality-search" placeholder="חיפוש ישוב...">
            </div>
            <div class="table-scroll">
                <table class="data-table" id="localities-table">
                    <thead>
                        <tr>
                            <th>ישוב</th>
                            <th>בחירות</th>
                            <th class="sortable" data-sort="kosher_votes">כשרים <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="turnout_pct">שיעור ההצבעה <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="right_haredi_pct">ימין+חרדים <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="right_pct">ימין <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="haredi_pct">חרדים <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="center_left_arab_pct">מרכז-שמאל-ערבים <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="center_pct">מרכז <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="opposition_right_pct">ימין אופוזיציוני <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="left_pct">שמאל <span class="sort-indicator"></span></th>
                            <th class="sortable" data-sort="arab_pct">ערבים <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="localities-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Top Movers -->
        <div class="section-title">שינויים גדולים בין הבחירות הנבחרות (ישובים מעל 10,000 בוחרים)</div>
        <div class="movers-grid">
            <div class="movers-card">
                <div class="movers-header red">עלייה במרכז-שמאל-ערבים</div>
                <div id="movers-center-left"></div>
            </div>
            <div class="movers-card">
                <div class="movers-header blue">עלייה בימין-חרדים</div>
                <div id="movers-right-haredi"></div>
            </div>
        </div>
    </section>

    <!-- ==================== SECTION: SOCIOECONOMIC ==================== -->
    <section id="socioeconomic" class="section">
        
        <!-- Election Selector -->
        <div class="election-selector">
            <div class="selector-title">בחירות:</div>
            <div class="selector-row" id="socio-election-selector"></div>
            <div id="demo-year-label" style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item"><span class="legend-color" style="background: #e74c3c"></span> אשכול 1-3 (נמוך)</div>
            <div class="legend-item"><span class="legend-color" style="background: #f1c40f"></span> אשכול 4-6 (בינוני)</div>
            <div class="legend-item"><span class="legend-color" style="background: #2ecc71"></span> אשכול 7-10 (גבוה)</div>
            <div class="legend-item"><span class="legend-color" style="background: transparent; border: 2px solid #fff; box-sizing: border-box;"></span> יישוב ערבי (60%+)</div>
            <div class="legend-item"><span class="legend-color" style="background: transparent; border: 2px solid #888; box-sizing: border-box;"></span> יישוב דרוזי (55%+)</div>
            <div class="legend-item" style="color: var(--text-muted)">גודל העיגול לפי מספר המצביעים</div>
        </div>

        <!-- Scatter Charts -->
        <div class="scatter-grid">
            <div class="chart-container">
                <div class="chart-title">הכנסה חודשית לנפש מול % ימין-חרדים</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-income"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">% אקדמאים מול % ימין-חרדים</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-academic"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">ממוצע הצבעה לפי אשכול סוציו-אקונומי</div>
                <div class="chart-wrapper">
                    <canvas id="cluster-bar-chart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">ימי שהייה בחו״ל מול % ימין-חרדים</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-abroad"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">% משפחות עם 4 ילדים ומעלה מול % ימין-חרדים</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-children"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">% משפחות עם 4 ילדים ומעלה מול % ימין-חרדים (עד 20% - ללא חרדים)</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-children-capped"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">% "רוסים" (ללא סיווג דת) מול % ימין-חרדים</div>
                <div class="chart-wrapper">
                    <canvas id="scatter-russians"></canvas>
                </div>
            </div>
        </div>

        <!-- Correlation Matrices -->
        <div class="section-title">מטריצות מתאמים (משוקלל לפי מספר מצביעים)</div>
        <div class="correlation-matrices-grid">
            <div class="correlation-container">
                <div class="correlation-title">כל הרשויות</div>
                <div class="correlation-matrix" id="correlation-matrix"></div>
            </div>
            <div class="correlation-container">
                <div class="correlation-title">רוב יהודי (כולל ערים מעורבות)</div>
                <div class="correlation-matrix" id="correlation-matrix-jewish"></div>
            </div>
        </div>
        <div class="correlation-legend">
            <div class="correlation-scale">
                <span>-1</span>
                <div class="correlation-gradient"></div>
                <span>+1</span>
            </div>
            <div class="correlation-note">* לחץ על תא לפרטים</div>
        </div>

        <!-- Correlation Trends Over Time -->
        <div class="section-title">מתאמים לאורך זמן - מרכז-שמאל</div>
        <div class="correlation-matrices-grid">
            <div class="chart-container">
                <div class="correlation-title">כל הרשויות</div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="correlation-trends-all"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="correlation-title">רוב יהודי (כולל ערים מעורבות)</div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="correlation-trends-jewish"></canvas>
                </div>
            </div>
        </div>

        <!-- Geographic Sorting Analysis -->
        <div class="section-title">מיון גיאוגרפי - הפער בין רשויות משכילות לפחות משכילות</div>
        <div class="correlation-matrices-grid">
            <div class="chart-container">
                <div class="correlation-title">כל הרשויות</div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="sorting-all"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="correlation-title">רוב יהודי (כולל ערים מעורבות)</div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="sorting-jewish"></canvas>
                </div>
            </div>
        </div>

        <!-- ==================== REGRESSION MODEL ==================== -->
        <div class="model-section">
            <div class="model-header">
                <h2>🔬 מודל רגרסיה סוציו-אקונומי</h2>
                <span class="badge">BETA</span>
            </div>
            <div class="model-subtitle">
                רגרסיה לוגיסטית (logit) עם רגולריזציית <strong>Ridge (L2)</strong>, משוקללת לפי מספר בוחרים — מנבאת את שיעור ההצבעה לגוש ימין-חרדים (0%-100%).
                Ridge מטפל בקורלציה גבוהה בין משתנים (כגון הכנסה ↔ אחוז אקדמאים) ומונע מקדמים לא יציבים. פרמטר הענישה (λ) נבחר אוטומטית ב-Cross-Validation.
                המודל רץ בנפרד על <strong>כל הרשויות</strong> ועל <strong>רשויות עם רוב יהודי</strong> (ללא רשויות ערביות/דרוזיות, אבל כולל ערים מעורבות כמו ירושלים, חיפה ולוד — משתנה % ערבים מאפשר למודל לתקן עבור ההשפעה של האוכלוסייה הערבית).
            </div>
            <div style="background: rgba(230, 126, 34, 0.08); border: 1px solid rgba(230, 126, 34, 0.25); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary);">
                <strong style="color: #e67e22;">💡 למה "שנות לימוד ממוצע" לא נכלל במודל?</strong><br>
                המשתנה דחוס מדי ומטעה: הטווח הוא רק 12–15 שנים, כך שהפער בין חדרה (12.9) לרמת השרון (14.6) נראה קטן — 1.7 שנים בלבד.
                אבל ב-% אקדמאים ההבדל הוא <strong>30 נקודות</strong> (29.7% מול 60.4%), ובהצבעה — <strong>35 נקודות</strong>.
                בנוסף, לימודי ישיבה נספרים כ"שנות לימוד" ע״י הלמ״ס, כך שמודיעין עילית (12.4, אבל 6% אקדמאים) נראית דומה לאילת (11.9, אבל 20% אקדמאים).
                המשתנה <strong>% אקדמאים</strong> מבטא את ההבדלים בהשכלה בצורה הרבה יותר מדויקת.
            </div>

            <div style="background: rgba(74, 158, 255, 0.06); border: 1px solid rgba(74, 158, 255, 0.2); border-radius: 10px; padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary);">
                <strong style="color: #4a9eff;">📐 כיצד לקרוא את המקדמים?</strong><br>
                המקדמים מוצגים כ-<em>Beta מתוקנן</em> על סולם לוגיט — מספרים כמו 0.176 או -0.148 שקשה לפרש ישירות.
                הטבלה הבאה מתרגמת אותם: מה קורה להצבעה כשמשתנה עולה ב-<strong>סטיית תקן אחת</strong> (1 SD), עבור רשות יהודית טיפוסית (~59% ימין-חרדים):
                <table style="width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 0.82rem; table-layout: fixed;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.2);">
                            <th style="text-align: right; padding: 0.4rem 0.5rem; color: var(--text-muted); font-weight: 500; width: 22%;">משתנה</th>
                            <th style="text-align: center; padding: 0.4rem 0.5rem; color: var(--text-muted); font-weight: 500; width: 12%;">Beta</th>
                            <th style="text-align: center; padding: 0.4rem 0.5rem; color: var(--text-muted); font-weight: 500; width: 14%;">1 SD בעולם האמיתי</th>
                            <th style="text-align: center; padding: 0.4rem 0.5rem; color: var(--text-muted); font-weight: 500; width: 22%;">השפעה על הצבעה (±1 SD)</th>
                            <th style="text-align: right; padding: 0.4rem 0.5rem; color: var(--text-muted); font-weight: 500; width: 30%;">דוגמה</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">% משפחות 4+ ילדים</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+0.176</td>
                            <td style="text-align: center;">13 נק׳</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+6.3 נק׳ ימינה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">רמה״ש 6% → בני ברק 46%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">יחס תלות</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+0.154</td>
                            <td style="text-align: center;">22 נק׳</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+5.5 נק׳ ימינה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">ילדים+קשישים ביחס לעובדים</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">% אקדמאים</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.148</td>
                            <td style="text-align: center;">17 נק׳</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−5.5 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">נתיבות 21% → רמה״ש 60%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">גיל חציוני</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.137</td>
                            <td style="text-align: center;">6.6 שנים</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−5.1 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">בית שמש 25 → רמה״ש 39</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">ימי שהייה בחו״ל</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.133</td>
                            <td style="text-align: center;">2 ימים</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−5.0 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">חדרה 2.2 → רמה״ש 5.9</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">רכבים ל-100 תושבים</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.108</td>
                            <td style="text-align: center;">14.5</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−4.0 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">אשדוד 41 → רמה״ש 71</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">% מתחת לשכר מינימום</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+0.090</td>
                            <td style="text-align: center;">7.9 נק׳</td>
                            <td style="text-align: center; color: var(--color-right); font-weight: 600;">+3.3 נק׳ ימינה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">רמה״ש 32% → אשדוד 43%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(74, 158, 255, 0.07);">
                            <td style="padding: 0.35rem 0.5rem;">הכנסה חודשית לנפש</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.090</td>
                            <td style="text-align: center;">₪2,632</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−3.3 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">נתיבות ₪4.5K → רמה״ש ₪12K</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.35rem 0.5rem;">% הבטחת הכנסה</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−0.079</td>
                            <td style="text-align: center;">3.5 נק׳</td>
                            <td style="text-align: center; color: var(--color-negative); font-weight: 600;">−2.9 נק׳ שמאלה</td>
                            <td style="padding: 0.35rem 0.5rem; color: var(--text-muted); font-size: 0.78rem;">רמה״ש 1.3% → אשדוד 9.4%</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted);">
                    <strong>חישוב:</strong> sigmoid( logit(59%) + Beta × SD(logit_y) ) − 59%. למשל עבור % משפחות 4+ ילדים: sigmoid(0.354 + 0.176×1.52) − 58.8% = 65.1% − 58.8% = <strong>+6.3 נק׳</strong>.<br>
                    <strong>דוגמה:</strong> המעבר מפרופיל של חדרה לפרופיל של רמת השרון כולל ~+1.8 SD באקדמאים, ~+1.8 SD בהכנסה, ~+1.2 SD בגיל ועוד — שמצטברים ל-~35 נקודות הפרש בהצבעה, קרוב להפרש בפועל (59% מול 25%).
                    ההשפעות חושבו עבור רשות חציונית (~59% ימין-חרדים); בקצוות (ליד 0% או 100%) ההשפעה קטנה יותר בגלל טרנספורמציית הלוגיט.
                </div>
            </div>

            <div class="model-tabs">
                <button class="model-tab active" data-panel="importance" onclick="showModelPanel('importance')">📊 חשיבות משתנים</button>
                <button class="model-tab" data-panel="outliers" onclick="showModelPanel('outliers')">🎯 חריגים</button>
                <button class="model-tab" data-panel="predictor" onclick="showModelPanel('predictor')">🔮 מנבא</button>
                <button class="model-tab" data-panel="timetrends" onclick="showModelPanel('timetrends')">📈 מגמות לאורך זמן</button>
            </div>

            <!-- Panel: Feature Importance -->
            <div class="model-panel active" id="panel-importance">
                <div class="model-r2-box" id="model-r2-box"></div>
                <div class="importance-grid">
                    <div class="importance-card">
                        <h3>כל הרשויות (201)</h3>
                        <div id="importance-all"></div>
                    </div>
                    <div class="importance-card">
                        <h3>רשויות עם רוב יהודי (כולל ערים מעורבות)</h3>
                        <div id="importance-jewish"></div>
                    </div>
                </div>
                <div class="correlation-matrices-grid">
                    <div class="chart-container">
                        <div class="chart-title">צפוי מול בפועל — % ימין-חרדים (כל הרשויות)</div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="model-predicted-vs-actual"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">צפוי מול בפועל — % ימין-חרדים (רוב יהודי)</div>
                        <div class="chart-wrapper" style="height: 350px;">
                            <canvas id="model-predicted-vs-actual-jewish"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel: Outliers -->
            <div class="model-panel" id="panel-outliers">
                <div class="outlier-table-container">
                    <h3>🔵 מצביעים ימין-חרדים יותר מהצפוי (בהתחשב בנתונים הסוציו-אקונומיים)</h3>
                    <div style="overflow-x: auto;">
                        <table class="outlier-table" id="outlier-table-positive"></table>
                    </div>
                </div>
                <div class="outlier-table-container">
                    <h3>🔴 מצביעים ימין-חרדים פחות מהצפוי</h3>
                    <div style="overflow-x: auto;">
                        <table class="outlier-table" id="outlier-table-negative"></table>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">שאריות (Residuals) — לפי רשות</div>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="model-residuals-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Panel: Predictor -->
            <div class="model-panel" id="panel-predictor">
                <div class="predictor-container">
                    <div class="predictor-inputs">
                        <h3>הזן ערכים סוציו-אקונומיים ודמוגרפיים</h3>
                        <div id="predictor-sliders"></div>
                    </div>
                    <div class="predictor-result">
                        <div class="prediction-label">תחזית: % הצבעה ימין-חרדים</div>
                        <div class="prediction-value" id="prediction-value">—</div>
                        <div class="prediction-bar">
                            <div class="prediction-bar-track">
                                <div class="prediction-bar-marker" id="prediction-marker"></div>
                            </div>
                            <div class="prediction-bar-labels">
                                <span>100% ימין-חרדים</span>
                                <span>100% מרכז-שמאל</span>
                            </div>
                        </div>
                        <div class="pred-compare-note" id="pred-compare-note"></div>
                    </div>
                </div>
            </div>

            <!-- Panel: Time Trends -->
            <div class="model-panel" id="panel-timetrends">
                <div class="trends-explanation">
                    כיצד כוח ההסבר (R²) של כל משתנה משתנה לאורך הבחירות — עד כמה כל גורם מנבא את ההצבעה בכל מערכת בחירות?
                </div>
                <div class="chart-container">
                    <div class="chart-title">R² של כל משתנה בנפרד לאורך בחירות — כל הרשויות</div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="model-time-trends-all"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 1.5rem;">
                    <div class="chart-title">R² של כל משתנה בנפרד לאורך בחירות — רוב יהודי</div>
                    <div class="chart-wrapper" style="height: 380px;">
                        <canvas id="model-time-trends-jewish"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="margin-top: 1.5rem;">
                    <div class="chart-title">R² של המודל המלא לאורך הבחירות</div>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="model-r2-over-time"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- ==================== SECTION: MAP ==================== -->
    <section id="mapview" class="section">
        <div style="position: relative; width: 100%; height: calc(100vh - 140px); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);">
            <iframe 
                id="mapIframe"
                src="election_map.html" 
                style="width: 100%; height: 100%; border: none; border-radius: 12px;"
                loading="lazy"
                title="מפת בחירות אינטראקטיבית"
            ></iframe>
        </div>
    </section>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
// ==================== GLOBAL STATE ====================
let DATA = null;
let state = {
    fromElection: 14,
    toElection: 25,
    locFromElection: 14,
    locToElection: 25,
    socioElection: 25,
    localityFilter: 'all',
    selectedLocality: null,
    sortColumn: 'kosher_votes',
    sortDirection: 'desc'
};

// Chart instances (for cleanup)
let charts = {};

// ==================== DEMOGRAPHIC YEAR HELPER ====================
// Determines which demographic data year to use based on election
function getDemoYear(election) {
    const k = parseInt(election);
    if (k >= 24) return '2021';
    if (k >= 21) return '2019';
    if (k === 20) return '2015';
    if (k === 19) return '2013';
    if (k === 18) return '2008';
    if (k === 17) return '2006';
    if (k === 16) return '2003';
    return '1999';  // K14-K15
}

// Get demographic value with appropriate year suffix
// For fields that exist in the year, returns the value; otherwise null
function getDemoValue(m, field, year) {
    // Fields available by year:
    // 2021 (base): all fields
    // 2019: all fields
    // 2017: all fields
    // 2015: all fields
    // 2013: all fields
    // 2008: missing pct_families_4plus_children, vehicles_per_100_residents, avg_vehicle_license_fee, avg_days_abroad
    // 2006: only socio_cluster available; other fields fall back to 2008
    // 2003: only socio_cluster available; other fields fall back to 2008
    
    const fieldsNotIn2008 = ['pct_families_4plus_children', 'vehicles_per_100_residents', 'avg_vehicle_license_fee', 'avg_days_abroad'];
    
    if (year === '1999' || year === '2003' || year === '2006') {
        if (field === 'socio_cluster') {
            const val = m['socio_cluster_' + year];
            if (val !== undefined && val !== null) return val;
            return null;
        }
        // Fall back to 2008 for all other fields
        if (fieldsNotIn2008.includes(field)) return null;
        return m[field + '_2008'];
    }
    
    if (year === '2008' && fieldsNotIn2008.includes(field)) {
        return null;
    }
    
    // For 2021, check both the base field and _2021 suffix
    if (year === '2021') {
        const val2021 = m[field + '_2021'];
        if (val2021 !== undefined && val2021 !== null) return val2021;
        // Fallback to base field (original 2021 data)
        return m[field];
    }
    
    // For other years, use the suffix
    return m[field + '_' + year];
}

// Get socio cluster with appropriate year
function getSocioCluster(m, year) {
    if (year === '2021') {
        return m.socio_cluster_2021 || m.socio_cluster;
    }
    const val = m['socio_cluster_' + year];
    if (val !== undefined && val !== null) return val;
    // Fallback chain: try 2008 for older years
    if (year === '1999' || year === '2003' || year === '2006') {
        return m.socio_cluster_2008 || m.socio_cluster;
    }
    return m.socio_cluster;
}

// ==================== INITIALIZATION ====================
async function init() {
    try {
        const [core, parties, localities, socio, partiesLocality] = await Promise.all([
            fetch('data/core.json').then(r => r.json()),
            fetch('data/parties_national.json').then(r => r.json()),
            fetch('data/localities.json').then(r => r.json()),
            fetch('data/socioeconomic.json').then(r => r.json()),
            fetch('data/parties_by_locality.json').then(r => r.json())
        ]);
        // Reassemble into the same DATA structure the dashboard expects
        // Merge by_locality back into parties
        for (const k of Object.keys(parties)) {
            if (partiesLocality[k]) parties[k].by_locality = partiesLocality[k];
        }
        DATA = {
            ...core,
            localities: localities,
            socioeconomic: socio,
            parties: parties
        };
        console.log('Data loaded:', DATA.metadata);
        
        renderElectionSelectors();
        renderNationalSection();
        renderLocalitiesSection();
        renderSocioeconomicSection();
        renderDisclosures();
        initCoalitionBuilder();
        
        setupEventListeners();
    } catch (error) {
        console.error('Failed to load data:', error);
        document.body.innerHTML = '<div class="loading">שגיאה בטעינת הנתונים</div>';
    }
}

// ==================== EVENT LISTENERS ====================
function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(btn.dataset.section).classList.add('active');
            
            // When map tab is shown, tell the iframe's Leaflet map to recalculate its size
            if (btn.dataset.section === 'mapview') {
                const iframe = document.getElementById('mapIframe');
                if (iframe && iframe.contentWindow) {
                    setTimeout(() => {
                        try { iframe.contentWindow.map.invalidateSize(); } catch(e) {}
                    }, 200);
                }
            }
            
            // Re-render socio charts when section becomes visible (Chart.js needs visible canvas)
            if (btn.dataset.section === 'socioeconomic' && DATA) {
                setTimeout(() => { renderSocioeconomicSection(); }, 100);
            }
        });
    });

    // Locality search
    document.getElementById('locality-search').addEventListener('input', (e) => {
        renderLocalitiesTable(e.target.value);
    });

    // Locality filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.localityFilter = btn.dataset.filter;
            renderLocalitiesTable();
        });
    });

    // Sortable table headers
    document.querySelectorAll('#localities-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const sortCol = th.dataset.sort;
            if (state.sortColumn === sortCol) {
                // Toggle direction
                state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                // New column, default to desc (highest first)
                state.sortColumn = sortCol;
                state.sortDirection = 'desc';
            }
            const searchTerm = document.getElementById('locality-search').value;
            renderLocalitiesTable(searchTerm);
        });
    });
}

// ==================== ELECTION SELECTORS ====================
function renderElectionSelectors() {
    const elections = Object.keys(DATA.national.elections).map(Number).sort((a, b) => a - b);
    
    // National section
    renderSelectorButtons('from-selector', elections, state.fromElection, (k) => {
        state.fromElection = k;
        renderNationalSection();
    });
    renderSelectorButtons('to-selector', elections, state.toElection, (k) => {
        state.toElection = k;
        renderNationalSection();
    });

    // Localities section
    renderSelectorButtons('loc-from-selector', elections, state.locFromElection, (k) => {
        state.locFromElection = k;
        renderLocalitiesSection();
    });
    renderSelectorButtons('loc-to-selector', elections, state.locToElection, (k) => {
        state.locToElection = k;
        renderLocalitiesSection();
    });

    // Socioeconomic section (single selector)
    renderSelectorButtons('socio-election-selector', elections, state.socioElection, (k) => {
        state.socioElection = k;
        renderSocioeconomicSection();
    });
}

function renderSelectorButtons(containerId, elections, selected, onClick) {
    const container = document.getElementById(containerId);
    container.innerHTML = elections.map(k => {
        const year = DATA.metadata.knesset_years[k];
        const isSelected = k === selected;
        return `<button class="election-btn ${isSelected ? 'selected' : ''}" data-knesset="${k}">${k} (${year})</button>`;
    }).join('');

    container.querySelectorAll('.election-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            container.querySelectorAll('.election-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            onClick(parseInt(btn.dataset.knesset));
        });
    });
}

// ==================== NATIONAL SECTION ====================
function renderNationalSection() {
    const from = DATA.national.elections[state.fromElection];
    const to = DATA.national.elections[state.toElection];
    
    // Main metrics
    const metricsHtml = `
        <div class="metric-card">
            <div class="metric-label">כשרים - כנסת ${state.fromElection}</div>
            <div class="metric-value">${from.total_eligible.toLocaleString()}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">כשרים - כנסת ${state.toElection}</div>
            <div class="metric-value">${to.total_eligible.toLocaleString()}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">ימין-חרדים - כנסת ${state.fromElection}</div>
            <div class="metric-value blue">${from.right_haredi_pct}%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">ימין-חרדים - כנסת ${state.toElection}</div>
            <div class="metric-value blue">${to.right_haredi_pct}%</div>
            ${renderChange(to.right_haredi_pct - from.right_haredi_pct)}
        </div>
        <div class="metric-card">
            <div class="metric-label">מרכז-שמאל-ערבים - כנסת ${state.fromElection}</div>
            <div class="metric-value red">${from.center_left_arab_pct}%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">מרכז-שמאל-ערבים - כנסת ${state.toElection}</div>
            <div class="metric-value red">${to.center_left_arab_pct}%</div>
            ${renderChange(to.center_left_arab_pct - from.center_left_arab_pct)}
        </div>
    `;
    document.getElementById('national-metrics').innerHTML = metricsHtml;

    // Sub-groups
    renderSubgroups('national-subgroups', from, to, state.fromElection, state.toElection);

    // Charts
    renderNationalTrendsChart();
    renderNationalComparisonChart();
    renderNationalTurnoutTrendChart();
}

function renderSubgroups(containerId, from, to, fromK, toK, localityName) {
    const groups = [
        { key: 'right', label: 'ימין', class: 'right' },
        { key: 'haredi', label: 'חרדים', class: 'haredi' },
        { key: 'opposition_right', label: 'ימין אופוזיציוני', class: 'opposition_right', minElection: 21 },
        { key: 'center', label: 'מרכז', class: 'center' },
        { key: 'left', label: 'שמאל', class: 'left' },
        { key: 'arab', label: 'ערבים', class: 'arab' }
    ];

    // Calculate combined blocs
    const fromRightHaredi = (from.right_pct || 0) + (from.haredi_pct || 0);
    const toRightHaredi = (to.right_pct || 0) + (to.haredi_pct || 0);
    const changeRightHaredi = toRightHaredi - fromRightHaredi;
    
    const fromCenterLeftArab = (from.center_pct || 0) + (from.left_pct || 0) + (from.arab_pct || 0) + (from.opposition_right_pct || 0);
    const toCenterLeftArab = (to.center_pct || 0) + (to.left_pct || 0) + (to.arab_pct || 0) + (to.opposition_right_pct || 0);
    const changeCenterLeftArab = toCenterLeftArab - fromCenterLeftArab;

    // Build large bloc summary boxes
    const largeBlocHtml = `
        <div class="large-bloc-container">
            <div class="large-bloc-card right-haredi">
                <div class="large-bloc-title">ימין-חרדים</div>
                <div class="large-bloc-values">
                    <div class="large-bloc-row">
                        <span class="large-bloc-label">כנסת ${fromK}:</span>
                        <span class="large-bloc-value">${fromRightHaredi.toFixed(1)}%</span>
                    </div>
                    <div class="large-bloc-row">
                        <span class="large-bloc-label">כנסת ${toK}:</span>
                        <span class="large-bloc-value">${toRightHaredi.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="large-bloc-change">${renderChange(changeRightHaredi)}</div>
            </div>
            <div class="large-bloc-card center-left-arab">
                <div class="large-bloc-title">מרכז-שמאל-ערבים</div>
                <div class="large-bloc-values">
                    <div class="large-bloc-row">
                        <span class="large-bloc-label">כנסת ${fromK}:</span>
                        <span class="large-bloc-value">${fromCenterLeftArab.toFixed(1)}%</span>
                    </div>
                    <div class="large-bloc-row">
                        <span class="large-bloc-label">כנסת ${toK}:</span>
                        <span class="large-bloc-value">${toCenterLeftArab.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="large-bloc-change">${renderChange(changeCenterLeftArab)}</div>
            </div>
        </div>
    `;

    // Build bloc cards - filter by minElection
    const activeGroups = groups.filter(g => {
        if (!g.minElection) return true;
        return fromK >= g.minElection || toK >= g.minElection;
    });
    
    const blocHtml = activeGroups.map(g => {
        const fromVal = from[g.key + '_pct'] || 0;
        const toVal = to[g.key + '_pct'] || 0;
        const change = toVal - fromVal;
        
        return `
            <div class="subgroup-card">
                <div class="subgroup-title ${g.class}">${g.label}</div>
                <div class="subgroup-row">
                    <span class="subgroup-election">כנסת ${fromK}:</span>
                    <span class="subgroup-value ${g.class}">${fromVal.toFixed(1)}%</span>
                </div>
                <div class="subgroup-row">
                    <span class="subgroup-election">כנסת ${toK}:</span>
                    <span class="subgroup-value ${g.class}">${toVal.toFixed(1)}%</span>
                </div>
                <div class="subgroup-row">
                    ${renderChange(change)}
                </div>
            </div>
        `;
    }).join('');

    // Build party cards if data available for selected elections
    let partyHtml = '';
    const fromParties = DATA.parties?.[String(fromK)];
    const toParties = DATA.parties?.[String(toK)];
    
    if ((fromParties || toParties) && localityName) {
        const blocColors = {
            'right': 'var(--color-right)',
            'haredi': 'var(--color-haredi)',
            'center': 'var(--color-center)',
            'opposition_right': 'var(--color-opposition-right)',
            'left': 'var(--color-left)',
            'arab': 'var(--color-arab)'
        };
        
        // Get locality party data
        const fromLocParties = fromParties?.by_locality?.[localityName] || {};
        const toLocParties = toParties?.by_locality?.[localityName] || {};
        
        // Skip if no data for this locality
        if (Object.keys(fromLocParties).length === 0 && Object.keys(toLocParties).length === 0) {
            document.getElementById(containerId).innerHTML = largeBlocHtml + blocHtml;
            return;
        }
        
        const earlierK = Math.min(fromK, toK);
        const laterK = Math.max(fromK, toK);
        const earlierParties = DATA.parties?.[String(earlierK)];
        const laterParties = DATA.parties?.[String(laterK)];
        const earlierLocData = earlierK === fromK ? fromLocParties : toLocParties;
        const laterLocData = laterK === fromK ? fromLocParties : toLocParties;
        
        // Same comparison logic as renderPartyTable
        const comparableSameCode = {
            'מחל': true, 'שס': true, 'ג': true,
            'כן': false, 'ד': false, 'ב': false, 'עם': false,
            'פה': false, 'אמת': false, 'מרצ': false, 'טב': false,
        };
        
        const crossElectionMappings = {
            '14-15': { 'מרצ': 'מרץ', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'כן': 'כן', 'ב': 'ב', 'הד': 'הד', 'אמת': 'אמת' },
            '14-16': { 'מרצ': 'מרץ', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'כן': 'כן', 'ב': 'ב', 'אמת': 'אמת' },
            '14-17': { 'מרצ': 'מרץ', 'שס': 'שס', 'מחל': 'מחל', 'אמת': 'אמת' },
            '14-18': { 'מרצ': 'מרץ', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'אמת': 'אמת' },
            '14-19': { 'ג': 'ג', 'שס': 'שס', 'אמת': 'אמת', 'מרץ': 'מרץ' },
            '14-20': { 'מרצ': 'מרץ' },
            '14-21': { 'מרצ': 'מרץ', 'אמת': 'אמת' },
            '14-22': { 'מרצ': 'מרץ', 'אמת': 'אמת' },
            '14-23': {},
            '14-24': { 'מרצ': 'מרץ', 'אמת': 'אמת' },
            '14-25': { 'מרצ': 'מרץ', 'אמת': 'אמת' },
            '15-16': { 'מרצ': 'מרצ', 'ד': 'ד', 'עם': 'עם', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'כן': 'כן', 'ב': 'ב', 'ם': 'ם', 'יש': 'יש', 'אמת': 'אמת' },
            '15-17': { 'מרצ': 'מרצ', 'ד': 'ד', 'ו': 'ו', 'שס': 'שס', 'מחל': 'מחל', 'אמת': 'אמת' },
            '15-18': { 'מרצ': 'מרצ', 'ד': 'ד', 'ו': 'ו', 'עם': 'עם', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'אמת': 'אמת' },
            '15-19': { 'ד': 'ד', 'ו': 'ו', 'עם': 'עם', 'ג': 'ג', 'שס': 'שס', 'אמת': 'אמת' },
            '15-20': { 'מרצ': 'מרצ' },
            '15-21': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '15-22': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '15-23': {},
            '15-24': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '15-25': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '16-17': { 'מרצ': 'מרצ', 'ד': 'ד', 'אמת': 'אמת' },
            '16-18': { 'מרצ': 'מרצ', 'ד': 'ד', 'עם': 'עם', 'ג': 'ג', 'שס': 'שס', 'מחל': 'מחל', 'אמת': 'אמת' },
            '16-19': { 'ד': 'ד', 'עם': 'עם', 'ג': 'ג', 'שס': 'שס', 'אמת': 'אמת' },
            '16-20': { 'מרצ': 'מרצ' },
            '16-21': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '16-22': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '16-23': {},
            '16-24': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '16-25': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '17-18': { 'מרצ': 'מרצ', 'אמת': 'אמת', 'ד': 'ד', 'ו': 'ו', 'עם': 'עם', 'כן': 'כן', 'ל': 'ל', 'זך': 'זך' },
            '17-19': { 'מרץ': 'מרצ', 'אמת': 'אמת', 'ד': 'ד' },
            '17-20': { 'מרצ': 'מרצ' },
            '17-21': { 'אמת': 'אמת', 'מרצ': 'מרצ' },
            '17-22': { 'אמת': 'אמת', 'מרצ': 'מרצ' },
            '17-23': {},
            '17-24': { 'אמת': 'אמת', 'מרצ': 'מרצ' },
            '17-25': { 'ד': 'ד', 'אמת': 'אמת', 'מרצ': 'מרצ' },
            '18-19': { 'אמת': 'אמת', 'ד': 'ד', 'ו': 'ו', 'עם': 'עם', 'כן': 'כן', 'שס': 'שס', 'ג': 'ג', 'מרץ': 'מרצ' },
            '18-20': { 'מרצ': 'מרצ' },
            '18-21': { 'מרצ': 'מרצ' },
            '18-22': { 'מרצ': 'מרצ' },
            '18-23': {},
            '18-24': { 'מרצ': 'מרצ' },
            '18-25': { 'מרצ': 'מרצ' },
            '19-20': { 'פה': 'פה', 'טב': 'טב', 'מרצ': 'מרץ' },
            '19-21': {},
            '19-22': {},
            '19-23': {},
            '19-24': { 'פה': 'פה' },
            '19-25': { 'פה': 'פה', 'מרצ': 'מרץ', 'אמת': 'אמת', 'ד': 'ד' },
            '20-21': { 'מרצ': 'מרצ', 'ודעם': 'ודעם' },
            '20-22': { 'מרצ': 'מרצ', 'ודעם': 'ודעם' },
            '20-23': { 'ודעם': 'ודעם' },
            '20-24': { 'מרצ': 'מרצ', 'ודעם': 'ודעם' },
            '20-25': { 'מרצ': 'מרצ', 'אמת': 'אמת', 'ל': 'ל' },
            '21-22': { 'פה': 'פה', 'מרצ': 'מרצ', 'ל': 'ל' },
            '21-23': { 'פה': 'פה' },
            '21-24': { 'מרצ': 'מרצ' },
            '21-25': { 'מרצ': 'מרצ', 'אמת': 'אמת' },
            '22-23': { 'פה': 'פה', 'ודעם': 'ודעם', 'ל': 'ל' },
            '22-24': { 'מרצ': 'מרצ', 'ודעם': 'ודעם', 'ל': 'ל', 'אמת': 'אמת' },
            '22-25': { 'מרצ': 'מרצ', 'ל': 'ל', 'אמת': 'אמת' },
            '23-24': { 'ל': 'ל' },
            '23-25': { 'ל': 'ל' },
            '24-25': { 'עם': 'עם', 'פה': 'פה', 'אמת': 'אמת', 'מרצ': 'מרצ', 'ל': 'ל' }
        };
        
        // Title
        let titleText = 'מפלגות';
        if (fromParties && toParties && fromK !== toK) {
            titleText = `מפלגות (כנסת ${earlierK} ו-${laterK})`;
        } else if (fromParties) {
            titleText = `מפלגות (כנסת ${fromK})`;
        } else {
            titleText = `מפלגות (כנסת ${toK})`;
        }
        
        partyHtml = `<div class="parties-section"><div class="parties-title">${titleText}</div><div class="parties-grid">`;
        
        // If both elections have party data, use comparison logic
        if (fromParties && toParties && fromK !== toK && earlierParties && laterParties) {
            const earlierPartyInfo = {};
            const laterPartyInfo = {};
            earlierParties.party_list.forEach(p => { earlierPartyInfo[p.code] = p; });
            laterParties.party_list.forEach(p => { laterPartyInfo[p.code] = p; });
            
            const mappingKey = `${earlierK}-${laterK}`;
            const crossMapping = crossElectionMappings[mappingKey] || {};
            
            const comparablePartyCodes = [];
            const earlierOnlyCodes = [];
            const laterOnlyCodes = [];
            const processedEarlierCodes = new Set();
            const processedLaterCodes = new Set();
            
            // Cross-mapping parties (like בל"ד)
            for (const [laterCode, earlierCode] of Object.entries(crossMapping)) {
                if (earlierPartyInfo[earlierCode] && laterPartyInfo[laterCode]) {
                    comparablePartyCodes.push({ earlierCode, laterCode, party: laterPartyInfo[laterCode] });
                    processedEarlierCodes.add(earlierCode);
                    processedLaterCodes.add(laterCode);
                }
            }
            
            // Same-code comparable parties
            for (const p of earlierParties.party_list) {
                if (processedEarlierCodes.has(p.code)) continue;
                if (laterPartyInfo[p.code] && comparableSameCode[p.code] === true) {
                    comparablePartyCodes.push({ earlierCode: p.code, laterCode: p.code, party: laterPartyInfo[p.code] });
                    processedEarlierCodes.add(p.code);
                    processedLaterCodes.add(p.code);
                } else {
                    earlierOnlyCodes.push(p.code);
                }
            }
            
            for (const p of laterParties.party_list) {
                if (!processedLaterCodes.has(p.code)) {
                    laterOnlyCodes.push(p.code);
                }
            }
            
            // Comparable parties
            for (const {earlierCode, laterCode, party} of comparablePartyCodes) {
                const earlierPct = earlierLocData?.[earlierCode];
                const laterPct = laterLocData?.[laterCode];
                if (earlierPct === undefined && laterPct === undefined) continue;
                
                const change = (laterPct || 0) - (earlierPct || 0);
                const hasEarlier = earlierPct !== undefined;
                const hasLater = laterPct !== undefined;
                
                partyHtml += `
                    <div class="party-card" style="border-right: 3px solid ${blocColors[party.bloc]}">
                        <div class="party-name">${party.name}</div>
                        ${hasEarlier ? `<div class="party-row"><span class="party-election">כנסת ${earlierK}:</span><span class="party-value">${earlierPct.toFixed(1)}%</span></div>` : ''}
                        ${hasLater ? `<div class="party-row"><span class="party-election">כנסת ${laterK}:</span><span class="party-value">${laterPct.toFixed(1)}%</span></div>` : ''}
                        ${hasEarlier && hasLater ? `<div class="party-row">${renderChange(change)}</div>` : ''}
                    </div>
                `;
            }
            
            // Earlier-only parties
            for (const code of earlierOnlyCodes) {
                const party = earlierPartyInfo[code];
                const pct = earlierLocData?.[code];
                if (pct === undefined) continue;
                
                partyHtml += `
                    <div class="party-card" style="border-right: 3px solid ${blocColors[party.bloc]}">
                        <div class="party-name">${party.name}</div>
                        <div class="party-row"><span class="party-election">כנסת ${earlierK}:</span><span class="party-value">${pct.toFixed(1)}%</span></div>
                    </div>
                `;
            }
            
            // Later-only parties
            for (const code of laterOnlyCodes) {
                const party = laterPartyInfo[code];
                const pct = laterLocData?.[code];
                if (pct === undefined) continue;
                
                partyHtml += `
                    <div class="party-card" style="border-right: 3px solid ${blocColors[party.bloc]}">
                        <div class="party-name">${party.name}</div>
                        <div class="party-row"><span class="party-election">כנסת ${laterK}:</span><span class="party-value">${pct.toFixed(1)}%</span></div>
                    </div>
                `;
            }
        } else {
            // Single election - show all parties
            const activeParties = fromParties || toParties;
            const activeK = fromParties ? fromK : toK;
            const activeLocData = fromParties ? fromLocParties : toLocParties;
            
            for (const party of activeParties.party_list) {
                const pct = activeLocData[party.code];
                if (pct === undefined) continue;
                
                partyHtml += `
                    <div class="party-card" style="border-right: 3px solid ${blocColors[party.bloc]}">
                        <div class="party-name">${party.name}</div>
                        <div class="party-row"><span class="party-election">כנסת ${activeK}:</span><span class="party-value">${pct.toFixed(1)}%</span></div>
                    </div>
                `;
            }
        }
        
        partyHtml += '</div></div>';
    }

    document.getElementById(containerId).innerHTML = largeBlocHtml + blocHtml + partyHtml;
}

function renderChange(change) {
    const sign = change >= 0 ? '+' : '';
    const cls = change >= 0 ? 'positive' : 'negative';
    return `<span class="metric-change ${cls}">${sign}${change.toFixed(1)}%</span>`;
}

function renderNationalTrendsChart() {
    const ctx = document.getElementById('national-trends-chart').getContext('2d');
    
    if (charts.nationalTrends) charts.nationalTrends.destroy();
    
    const elections = Object.keys(DATA.national.elections).map(Number).sort((a, b) => a - b);
    
    charts.nationalTrends = new Chart(ctx, {
        type: 'line',
        data: {
            labels: elections.map(k => k.toString()),
            datasets: [
                {
                    label: 'ימין',
                    data: elections.map(k => DATA.national.elections[k].right_pct),
                    borderColor: '#4a9eff',
                    backgroundColor: 'rgba(74, 158, 255, 0.1)',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'חרדים',
                    data: elections.map(k => DATA.national.elections[k].haredi_pct),
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'מרכז',
                    data: elections.map(k => DATA.national.elections[k].center_pct),
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'ימין אופוזיציוני',
                    data: elections.map(k => DATA.national.elections[k].opposition_right_pct || null),
                    borderColor: '#00bcd4',
                    backgroundColor: 'rgba(0, 188, 212, 0.1)',
                    tension: 0.3,
                    fill: false,
                    borderDash: [5, 3]
                },
                {
                    label: 'שמאל',
                    data: elections.map(k => DATA.national.elections[k].left_pct),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'ערבים',
                    data: elections.map(k => DATA.national.elections[k].arab_pct),
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { family: 'Heebo' } }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8ba3c7' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    beginAtZero: true,
                    max: 50,
                    ticks: { 
                        color: '#8ba3c7',
                        callback: (v) => v + '%'
                    },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderNationalComparisonChart() {
    const ctx = document.getElementById('national-comparison-chart').getContext('2d');
    
    if (charts.nationalComparison) charts.nationalComparison.destroy();
    
    const from = DATA.national.elections[state.fromElection];
    const to = DATA.national.elections[state.toElection];
    
    charts.nationalComparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [`כנסת ${state.fromElection}`, `כנסת ${state.toElection}`],
            datasets: [
                {
                    label: 'ימין',
                    data: [from.right_pct, to.right_pct],
                    backgroundColor: '#4a9eff'
                },
                {
                    label: 'חרדים',
                    data: [from.haredi_pct, to.haredi_pct],
                    backgroundColor: '#9b59b6'
                },
                {
                    label: 'מרכז',
                    data: [from.center_pct, to.center_pct],
                    backgroundColor: '#2ecc71'
                },
                {
                    label: 'ימין אופוזיציוני',
                    data: [from.opposition_right_pct || 0, to.opposition_right_pct || 0],
                    backgroundColor: '#00bcd4'
                },
                {
                    label: 'שמאל',
                    data: [from.left_pct, to.left_pct],
                    backgroundColor: '#e74c3c'
                },
                {
                    label: 'ערבים',
                    data: [from.arab_pct, to.arab_pct],
                    backgroundColor: '#f39c12'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { family: 'Heebo' } }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#8ba3c7' },
                    grid: { display: false }
                },
                y: {
                    stacked: true,
                    max: 100,
                    ticks: { 
                        color: '#8ba3c7',
                        callback: (v) => v + '%'
                    },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderNationalTurnoutTrendChart() {
    const ctx = document.getElementById('national-turnout-trend-chart').getContext('2d');
    
    if (charts.nationalTurnoutTrend) charts.nationalTurnoutTrend.destroy();
    
    const elections = Object.keys(DATA.national.elections).map(Number).sort((a, b) => a - b);
    const labels = elections.map(k => 'כנסת ' + k + ' (' + DATA.national.elections[k].year + ')');
    const turnoutData = elections.map(k => DATA.national.elections[k].turnout_pct);
    
    charts.nationalTurnoutTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'שיעור הצבעה ארצי',
                data: turnoutData,
                borderColor: '#4a9eff',
                backgroundColor: 'rgba(74, 158, 255, 0.15)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: elections.map(k => {
                    if (k.toString() === state.fromElection || k.toString() === state.toElection) return '#fff';
                    return '#4a9eff';
                }),
                pointRadius: elections.map(k => {
                    if (k.toString() === state.fromElection || k.toString() === state.toElection) return 6;
                    return 3;
                }),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `שיעור הצבעה: ${ctx.raw.toFixed(1)}%`
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8ba3c7', font: { size: 9, family: 'Heebo' } },
                    grid: { display: false }
                },
                y: {
                    min: 55,
                    max: 85,
                    ticks: { color: '#8ba3c7', callback: v => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderLocalityTurnoutGapChart(locality) {
    const ctx = document.getElementById('locality-turnout-gap-chart').getContext('2d');
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    
    // Calculate turnout gap for each election (local - national)
    const labels = [];
    const gapData = [];
    const localData = [];
    const nationalData = [];
    
    for (const k of elections) {
        const locData = locality.data[k];
        const natData = DATA.national.elections[k];
        
        if (locData && natData && natData.turnout_pct) {
            // Get local turnout
            let localTurnout = locData.turnout_pct;
            if (!localTurnout && locData.voters && locData.bzb && locData.bzb > 0) {
                localTurnout = Math.round(locData.voters / locData.bzb * 1000) / 10;
            }
            if (localTurnout == null) continue;
            
            const nationalTurnout = natData.turnout_pct;
            const gap = localTurnout - nationalTurnout;
            
            labels.push(`כנסת ${k}`);
            gapData.push(gap);
            localData.push(localTurnout);
            nationalData.push(nationalTurnout);
        }
    }
    
    if (gapData.length < 2) return;
    
    if (charts.localityTurnoutGap) charts.localityTurnoutGap.destroy();
    
    // Calculate total trend
    const totalTrend = gapData[gapData.length - 1] - gapData[0];
    const direction = totalTrend > 0.5 ? 'עלייה' : (totalTrend < -0.5 ? 'ירידה' : 'יציב');
    
    charts.localityTurnoutGap = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'פער הצבעה מהארץ (%)',
                data: gapData,
                backgroundColor: gapData.map(v => v >= 0 ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)'),
                borderColor: gapData.map(v => v >= 0 ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const gap = gapData[idx];
                            const local = localData[idx];
                            const national = nationalData[idx];
                            const sign = gap >= 0 ? '+' : '';
                            return [
                                `יישוב: ${local.toFixed(1)}%`,
                                `ארץ: ${national.toFixed(1)}%`,
                                `פער: ${sign}${gap.toFixed(1)}%`
                            ];
                        }
                    }
                },
                title: {
                    display: true,
                    text: `מגמה כוללת: ${totalTrend >= 0 ? '+' : ''}${totalTrend.toFixed(1)}% (${direction})`,
                    color: totalTrend > 0.5 ? '#2ecc71' : (totalTrend < -0.5 ? '#e74c3c' : '#8ba3c7'),
                    font: { size: 14, weight: 'bold' }
                }
            },
            scales: {
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: {
                        color: '#8ba3c7',
                        callback: function(value) {
                            return (value >= 0 ? '+' : '') + value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'פער שיעור הצבעה מהארץ',
                        color: '#8ba3c7'
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#8ba3c7' }
                }
            }
        }
    });
}

// ==================== LOCALITIES SECTION ====================
function renderLocalitiesSection() {
    document.getElementById('loc-selected-election').textContent = state.locToElection;
    
    // Update filter counts dynamically - based on selected election
    const k = state.locToElection;
    const withElection = DATA.localities.filter(loc => loc.data[k]);
    const full = withElection.filter(loc => loc.elections_count === 12).length;
    const partial = withElection.length - full;
    document.getElementById('localities-count').textContent = withElection.length.toLocaleString();
    document.getElementById('count-all').textContent = withElection.length.toLocaleString();
    document.getElementById('count-full').textContent = full.toLocaleString();
    document.getElementById('count-partial').textContent = partial.toLocaleString();
    
    renderLocalitiesTable();
    renderTopMovers();
    
    // If a locality is selected, refresh its detail view with new election data
    if (state.selectedLocality) {
        showLocalityDetail(state.selectedLocality.name);
    }
}

function renderLocalitiesTable(searchTerm = '') {
    const k = state.locToElection;
    let localities = DATA.localities.filter(loc => {
        // Filter by data availability
        if (state.localityFilter === 'full' && loc.elections_count !== 12) return false;
        if (state.localityFilter === 'partial' && loc.elections_count === 12) return false;
        
        // Filter by search term
        if (searchTerm && !loc.name.includes(searchTerm)) return false;
        
        // Must have data for selected election
        if (!loc.data[k]) return false;
        
        return true;
    });

    // Sort by selected column
    const sortCol = state.sortColumn;
    const sortDir = state.sortDirection === 'desc' ? 1 : -1;  // desc = largest first
    
    localities.sort((a, b) => {
        let aVal, bVal;
        if (sortCol === 'kosher_votes') {
            // Fallback to eligible if kosher_votes not available
            aVal = a.data[k]?.kosher_votes || a.data[k]?.eligible || 0;
            bVal = b.data[k]?.kosher_votes || b.data[k]?.eligible || 0;
        } else {
            aVal = a.data[k]?.[sortCol] || 0;
            bVal = b.data[k]?.[sortCol] || 0;
        }
        return (bVal - aVal) * sortDir;
    });

    // Limit to 150 for performance
    const displayLocalities = localities.slice(0, 150);
    
    document.getElementById('localities-count').textContent = localities.length.toLocaleString();

    const html = displayLocalities.map(loc => {
        const d = loc.data[k];
        const kosherVotes = d.kosher_votes?.toLocaleString() || d.eligible?.toLocaleString() || '-';
        const turnout = d.turnout_pct ? `${d.turnout_pct.toFixed(1)}%` : '-';
        return `
            <tr data-locality="${loc.name}">
                <td>${loc.name}</td>
                <td>${loc.elections_count}/12</td>
                <td>${kosherVotes}</td>
                <td>${turnout}</td>
                <td style="color: var(--color-right-haredi)">${d.right_haredi_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-right)">${d.right_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-haredi)">${d.haredi_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-center-left-arab)">${d.center_left_arab_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-center)">${d.center_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-opposition-right)">${d.opposition_right_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-left)">${d.left_pct?.toFixed(1) || '-'}%</td>
                <td style="color: var(--color-arab)">${d.arab_pct?.toFixed(1) || '-'}%</td>
            </tr>
        `;
    }).join('');

    document.getElementById('localities-table-body').innerHTML = html;

    // Update sort indicators
    document.querySelectorAll('#localities-table th.sortable').forEach(th => {
        th.classList.remove('active', 'asc', 'desc');
        if (th.dataset.sort === state.sortColumn) {
            th.classList.add('active', state.sortDirection);
        }
    });

    // Add click listeners
    document.querySelectorAll('#localities-table-body tr').forEach(tr => {
        tr.addEventListener('click', () => {
            showLocalityDetail(tr.dataset.locality);
        });
    });
}

function showLocalityDetail(name) {
    const locality = DATA.localities.find(l => l.name === name);
    if (!locality) return;

    state.selectedLocality = locality;
    document.getElementById('locality-name').textContent = name;
    document.getElementById('locality-detail').classList.add('active');

    // Get from/to data
    const fromData = locality.data[state.locFromElection] || {};
    const toData = locality.data[state.locToElection] || {};

    // Render subgroups (blocs + parties if available)
    renderSubgroups('locality-subgroups', fromData, toData, state.locFromElection, state.locToElection, name);

    // Render K17 party table if K17 is selected
    renderPartyTable(name, state.locFromElection, state.locToElection);

    // Render charts
    renderLocalityBlocsChart(locality);
    renderLocalityTrendsChart(locality);
    renderLocalityTrendGapChart(locality);
    renderLocalityTurnoutGapChart(locality);
}

let localityTrendGapChart = null;

function renderLocalityTrendGapChart(locality) {
    const ctx = document.getElementById('locality-trend-chart').getContext('2d');
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    const nationalBlocs = DATA.national_bloc_totals;
    
    if (!nationalBlocs) return;
    
    // Calculate gap for each election (local - national)
    const labels = [];
    const gapData = [];
    const localData = [];
    const nationalData = [];
    
    for (const k of elections) {
        const locData = locality.data[k];
        const natData = nationalBlocs[k];
        
        if (locData && natData) {
            // Calculate local center-left-arab (use pre-calculated field)
            const localCLA = locData.center_left_arab_pct || ((locData.center_pct || 0) + (locData.opposition_right_pct || 0) + (locData.left_pct || 0) + (locData.arab_pct || 0));
            const nationalCLA = natData.center_left_arab || 0;
            const gap = localCLA - nationalCLA;
            
            labels.push(`כנסת ${k}`);
            gapData.push(gap);
            localData.push(localCLA);
            nationalData.push(nationalCLA);
        }
    }
    
    if (gapData.length < 2) return;
    
    // Destroy existing chart
    if (localityTrendGapChart) {
        localityTrendGapChart.destroy();
    }
    
    // Calculate total trend for annotation
    const totalTrend = gapData[gapData.length - 1] - gapData[0];
    const direction = totalTrend > 0.5 ? 'שמאלה' : (totalTrend < -0.5 ? 'ימינה' : 'יציב');
    
    localityTrendGapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'פער מהארץ (%)',
                data: gapData,
                backgroundColor: gapData.map(v => v >= 0 ? 'rgba(231, 76, 60, 0.7)' : 'rgba(74, 158, 255, 0.7)'),
                borderColor: gapData.map(v => v >= 0 ? 'rgba(231, 76, 60, 1)' : 'rgba(74, 158, 255, 1)'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const gap = gapData[idx];
                            const local = localData[idx];
                            const national = nationalData[idx];
                            const sign = gap >= 0 ? '+' : '';
                            return [
                                `יישוב: ${local.toFixed(1)}%`,
                                `ארץ: ${national.toFixed(1)}%`,
                                `פער: ${sign}${gap.toFixed(1)}%`
                            ];
                        }
                    }
                },
                title: {
                    display: true,
                    text: `מגמה כוללת: ${totalTrend >= 0 ? '+' : ''}${totalTrend.toFixed(1)}% (${direction})`,
                    color: totalTrend > 0.5 ? '#e74c3c' : (totalTrend < -0.5 ? '#4a9eff' : '#8ba3c7'),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#8ba3c7',
                        callback: function(value) {
                            return (value >= 0 ? '+' : '') + value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'פער מהארץ (מרכז-שמאל-ערבים)',
                        color: '#8ba3c7'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#8ba3c7'
                    }
                }
            }
        }
    });
}

function renderPartyTable(localityName, fromK, toK) {
    const container = document.getElementById('party-table-container');
    const tbody = document.getElementById('party-table-body');
    const titleEl = container.querySelector('.party-table-title');
    const theadRow = container.querySelector('thead tr');
    
    // Check which selected elections have party data
    const fromParties = DATA.parties?.[String(fromK)];
    const toParties = DATA.parties?.[String(toK)];
    
    if (!fromParties && !toParties) {
        container.style.display = 'none';
        return;
    }
    
    // Get locality data for each election
    const fromLocParties = fromParties?.by_locality?.[localityName];
    const toLocParties = toParties?.by_locality?.[localityName];
    
    if (!fromLocParties && !toLocParties) {
        container.style.display = 'none';
        return;
    }
    
    // Show container
    container.style.display = 'block';
    
    // Determine which elections we're showing
    const showBoth = fromLocParties && toLocParties && fromK !== toK;
    const earlierK = Math.min(fromK, toK);
    const laterK = Math.max(fromK, toK);
    
    // Build table rows
    const blocNames = {
        'right': 'ימין',
        'haredi': 'חרדים', 
        'center': 'מרכז',
        'opposition_right': 'ימין אופוזיציוני',
        'left': 'שמאל',
        'arab': 'ערבים'
    };
    
    // Define which party codes are TRULY comparable across elections (same code)
    // Note: Some codes changed meaning between elections
    const comparableSameCode = {
        'מחל': true,  // ליכוד - always the same
        'שס': true,   // ש"ס - always the same
        'ג': true,    // יהדות התורה - always the same
        'ט': false,   // האיחוד הלאומי (K18) vs הציונות הדתית (K24, K25) - different parties
        // These codes were REUSED for different parties - NOT comparable by default:
        'ל': false,   // ישראל ביתנו - different configurations across elections
        'כן': false,  // קדימה (K17) vs כחול לבן (K24) vs המחנה הממלכתי (K25)
        'ד': false,   // בל"ד (K17) vs חד"ש-תע"ל (K25)
        'ב': false,   // נעם/הבית היהודי (K17,K25) vs תקווה חדשה (K24)
        'עם': false,  // רע"מ-תע"ל (K17) vs רע"מ (K24, K25) - different configurations
        'פה': false,  // כחול לבן (K23) vs יש עתיד (K24, K25) - different parties!
        'אמת': false, // עבודה-גשר-מרצ (K23) vs עבודה (K17, K24, K25) - different configurations
        'מרצ': false, // מרצ separate (K17,K24,K25) but part of אמת in K23
        'טב': false,  // ימינה (K23) vs different parties in other elections
    };
    
    // Cross-election party mappings (same party, different codes)
    // Format: { laterCode: earlierCode } for each election pair
    const crossElectionMappings = {
        '14-15': {
            'מרצ': 'מרץ', // מרצ comparable K14-K15 (מרץ K14 vs מרצ K15)
            'ג': 'ג', // יהדות התורה comparable K14-K15
            'שס': 'שס', // ש"ס comparable K14-K15
            'מחל': 'מחל', // הליכוד comparable K14-K15
            'כן': 'כן', // ישראל בעלייה comparable K14-K15
            'ב': 'ב', // מפד"ל comparable K14-K15
            'הד': 'הד', // הדרך השלישית comparable K14-K15
            'אמת': 'אמת', // העבודה comparable K14-K15
            // ו NOT comparable: חד"ש-בל"ד K14 vs חד"ש K15
        },
        '14-16': {
            'מרצ': 'מרץ', // מרצ comparable K14-K16
            'ג': 'ג', // יהדות התורה comparable K14-K16
            'שס': 'שס', // ש"ס comparable K14-K16
            'מחל': 'מחל', // הליכוד comparable K14-K16
            'כן': 'כן', // ישראל בעלייה comparable K14-K16
            'ב': 'ב', // מפד"ל comparable K14-K16
            'אמת': 'אמת', // העבודה comparable K14-K16
            // ו NOT comparable: חד"ש-בל"ד K14 vs חד"ש-תע"ל K16
        },
        '14-17': {
            'מרצ': 'מרץ', // מרצ comparable K14-K17
            'שס': 'שס', // ש"ס comparable K14-K17
            'מחל': 'מחל', // הליכוד comparable K14-K17
            'אמת': 'אמת', // העבודה comparable K14-K17
            // ו NOT comparable: חד"ש-בל"ד K14 vs חד"ש K17
        },
        '14-18': {
            'מרצ': 'מרץ', // מרצ comparable K14-K18
            'ג': 'ג', // יהדות התורה comparable K14-K18
            'שס': 'שס', // ש"ס comparable K14-K18
            'מחל': 'מחל', // הליכוד comparable K14-K18
            'אמת': 'אמת', // העבודה comparable K14-K18
            // ו NOT comparable: חד"ש-בל"ד K14 vs חד"ש K18
        },
        '14-19': {
            'מרץ': 'מרץ', // מרצ comparable K14-K19 (both use מרץ)
            'ג': 'ג', // יהדות התורה comparable K14-K19
            'שס': 'שס', // ש"ס comparable K14-K19
            'אמת': 'אמת', // העבודה comparable K14-K19
            // ו NOT comparable: חד"ש-בל"ד K14 vs חד"ש K19
        },
        '14-20': {
            'מרצ': 'מרץ', // מרצ comparable K14-K20
        },
        '14-21': {
            'מרצ': 'מרץ', // מרצ comparable K14-K21
            'אמת': 'אמת', // העבודה comparable K14-K21
        },
        '14-22': {
            'מרצ': 'מרץ', // מרצ comparable K14-K22
            'אמת': 'אמת', // העבודה comparable K14-K22
        },
        '14-23': {
            // Limited comparisons
        },
        '14-24': {
            'מרצ': 'מרץ', // מרצ comparable K14-K24
            'אמת': 'אמת', // העבודה comparable K14-K24
        },
        '14-25': {
            'מרצ': 'מרץ', // מרצ comparable K14-K25
            'אמת': 'אמת', // העבודה comparable K14-K25
        },
        '15-16': {
            'מרצ': 'מרצ', // מרצ comparable K15-K16
            'ד': 'ד', // בל"ד comparable K15-K16
            'עם': 'עם', // רע"מ comparable K15-K16
            'ג': 'ג', // יהדות התורה comparable K15-K16
            'שס': 'שס', // ש"ס comparable K15-K16
            'מחל': 'מחל', // הליכוד comparable K15-K16
            'כן': 'כן', // ישראל בעלייה comparable K15-K16
            'ב': 'ב', // מפד"ל comparable K15-K16
            'ם': 'ם', // עם אחד comparable K15-K16
            'יש': 'יש', // שינוי comparable K15-K16
            'אמת': 'אמת', // העבודה comparable K15-K16
            // ו NOT comparable: חד"ש K15 vs חד"ש-תע"ל K16
            // ל (ישראל ביתנו) K15 NOT comparable - merged with האיחוד הלאומי in K16
        },
        '15-17': {
            'מרצ': 'מרצ', // מרצ comparable K15-K17
            'ד': 'ד', // בל"ד comparable K15-K17
            'ו': 'ו', // חד"ש comparable K15-K17
            'שס': 'שס', // ש"ס comparable K15-K17
            'מחל': 'מחל', // הליכוד comparable K15-K17
            'אמת': 'אמת', // העבודה comparable K15-K17
            // ל (ישראל ביתנו) NOT comparable - different configuration in K17
        },
        '15-18': {
            'מרצ': 'מרצ', // מרצ comparable K15-K18
            'ד': 'ד', // בל"ד comparable K15-K18
            'ו': 'ו', // חד"ש comparable K15-K18
            'עם': 'עם', // רע"מ comparable K15-K18
            'ג': 'ג', // יהדות התורה comparable K15-K18
            'שס': 'שס', // ש"ס comparable K15-K18
            'מחל': 'מחל', // הליכוד comparable K15-K18
            'אמת': 'אמת', // העבודה comparable K15-K18
            // ל NOT comparable
        },
        '15-19': {
            'ד': 'ד', // בל"ד comparable K15-K19
            'ו': 'ו', // חד"ש comparable K15-K19
            'עם': 'עם', // רע"מ comparable K15-K19
            'ג': 'ג', // יהדות התורה comparable K15-K19
            'שס': 'שס', // ש"ס comparable K15-K19
            'אמת': 'אמת', // העבודה comparable K15-K19
        },
        '15-20': {
            'מרצ': 'מרצ', // מרצ comparable K15-K20
        },
        '15-21': {
            'מרצ': 'מרצ', // מרצ comparable K15-K21
            'אמת': 'אמת', // העבודה comparable K15-K21
        },
        '15-22': {
            'מרצ': 'מרצ', // מרצ comparable K15-K22
            'אמת': 'אמת', // העבודה comparable K15-K22
        },
        '15-23': {
            // Limited comparisons
        },
        '15-24': {
            'מרצ': 'מרצ', // מרצ comparable K15-K24
            'אמת': 'אמת', // העבודה comparable K15-K24
        },
        '15-25': {
            'מרצ': 'מרצ', // מרצ comparable K15-K25
            'אמת': 'אמת', // העבודה comparable K15-K25
        },
        '16-17': {
            'מרצ': 'מרצ', // מרצ comparable K16-K17
            'ד': 'ד', // בל"ד comparable K16-K17
            'אמת': 'אמת', // עבודה comparable K16-K17 (עבודה-מימד K16 vs עבודה K17)
            // ו NOT comparable: חד"ש-תע"ל K16 vs חד"ש K17
            // ל in K16 (ישראל ביתנו-האיחוד הלאומי) split in K17 - NOT comparable
        },
        '16-18': {
            'מרצ': 'מרצ', // מרצ comparable K16-K18
            'ד': 'ד', // בל"ד comparable K16-K18
            'עם': 'עם', // רע"מ comparable K16-K18
            'ג': 'ג', // יהדות התורה comparable K16-K18
            'שס': 'שס', // ש"ס comparable K16-K18
            'מחל': 'מחל', // הליכוד comparable K16-K18
            'אמת': 'אמת', // עבודה comparable K16-K18
            // ו NOT comparable: חד"ש-תע"ל K16 vs חד"ש K18
            // ל in K16 NOT comparable to ל in K18 (different composition)
        },
        '16-19': {
            'ד': 'ד', // בל"ד comparable K16-K19
            'עם': 'עם', // רע"מ comparable K16-K19
            'ג': 'ג', // יהדות התורה comparable K16-K19
            'שס': 'שס', // ש"ס comparable K16-K19
            'אמת': 'אמת', // עבודה comparable K16-K19
            // ו NOT comparable: חד"ש-תע"ל K16 vs חד"ש K19
            // מרצ NOT comparable: מרצ K16 vs מרץ K19 (different spelling)
        },
        '16-20': {
            'מרצ': 'מרצ', // מרצ comparable K16-K20
        },
        '16-21': {
            'מרצ': 'מרצ', // מרצ comparable K16-K21
            'אמת': 'אמת', // עבודה comparable K16-K21
        },
        '16-22': {
            'מרצ': 'מרצ', // מרצ comparable K16-K22
            'אמת': 'אמת', // עבודה comparable K16-K22
        },
        '16-23': {
            // Limited comparisons
        },
        '16-24': {
            'מרצ': 'מרצ', // מרצ comparable K16-K24
            'אמת': 'אמת', // עבודה comparable K16-K24
        },
        '16-25': {
            'מרצ': 'מרצ', // מרצ comparable K16-K25
            'אמת': 'אמת', // עבודה comparable K16-K25
        },
        '17-18': {
            'מרצ': 'מרצ', // מרצ comparable K17-K18
            'אמת': 'אמת', // עבודה comparable K17-K18
            'ד': 'ד', // בל"ד comparable K17-K18
            'ו': 'ו', // חד"ש comparable K17-K18
            'עם': 'עם', // רע"מ-תע"ל comparable K17-K18
            'כן': 'כן', // קדימה comparable K17-K18
            'ל': 'ל', // ישראל ביתנו comparable K17-K18
            'זך': 'זך', // גמלאים comparable K17-K18
        },
        '17-19': {
            'מרץ': 'מרצ', // מרצ: מרצ in K17, מרץ in K19
            'אמת': 'אמת', // עבודה comparable K17-K19
            'ד': 'ד', // בל"ד comparable K17-K19
        },
        '17-20': {
            'מרצ': 'מרצ', // מרצ comparable K17-K20
            // אמת NOT comparable: עבודה K17 vs המחנה הציוני K20 (different configs)
        },
        '17-21': {
            'אמת': 'אמת', // עבודה comparable K17-K21
            'מרצ': 'מרצ', // מרצ comparable K17-K21
        },
        '17-22': {
            'אמת': 'אמת', // עבודה comparable K17-K22
            'מרצ': 'מרצ', // מרצ comparable K17-K22
        },
        '17-23': {
            // K23 had merged lists, very few direct comparisons
        },
        '17-24': {
            'אמת': 'אמת', // עבודה comparable K17-K24
            'מרצ': 'מרצ', // מרצ comparable K17-K24
        },
        '17-25': {
            'ד': 'ד',  // בל"ד: ד in K17, ד in K25
            'אמת': 'אמת', // עבודה comparable K17-K25
            'מרצ': 'מרצ', // מרצ comparable K17-K25
        },
        '18-19': {
            'אמת': 'אמת', // עבודה comparable K18-K19
            'ד': 'ד', // בל"ד comparable K18-K19
            'ו': 'ו', // חד"ש comparable K18-K19
            'עם': 'עם', // רע"מ-תע"ל comparable K18-K19
            'כן': 'כן', // קדימה comparable K18-K19
            'שס': 'שס', // ש"ס comparable K18-K19
            'ג': 'ג', // יהדות התורה comparable K18-K19
            'מרץ': 'מרצ', // מרצ: מרצ in K18, מרץ in K19
            // מחל + ל in K18 merged into מחל (הליכוד-ישראל ביתנו) in K19
            // ב + ט in K18 merged into טב in K19
        },
        '18-20': {
            'מרצ': 'מרצ', // מרצ comparable K18-K20
            // ב + ט in K18 → טב in K20 (via K19)
        },
        '18-21': {
            'מרצ': 'מרצ', // מרצ comparable K18-K21
        },
        '18-22': {
            'מרצ': 'מרצ', // מרצ comparable K18-K22
        },
        '18-23': {
            // Limited comparisons
        },
        '18-24': {
            'מרצ': 'מרצ', // מרצ comparable K18-K24
        },
        '18-25': {
            'מרצ': 'מרצ', // מרצ comparable K18-K25
        },
        '19-20': {
            'פה': 'פה', // יש עתיד comparable K19-K20
            'טב': 'טב', // הבית היהודי comparable K19-K20
            'מרצ': 'מרץ', // מרצ: מרץ in K19, מרצ in K20
            // מחל NOT comparable: ליכוד-ישראל ביתנו K19 vs ליכוד K20
            // אמת + צפ merged into המחנה הציוני (אמת) in K20
            // ו + עם + ד merged into הרשימה המשותפת (ודעם) in K20
        },
        '19-21': {
            // מחל NOT comparable: ליכוד-ישראל ביתנו K19 vs various in K21
        },
        '19-22': {
            // Limited comparisons due to party restructuring
        },
        '19-23': {
            // Limited comparisons
        },
        '19-24': {
            'פה': 'פה', // יש עתיד comparable K19-K24
        },
        '19-25': {
            'פה': 'פה', // יש עתיד comparable K19-K25
            'מרצ': 'מרץ', // מרצ comparable K19-K25 (מרץ in K19, מרצ in K25)
            'אמת': 'אמת', // העבודה comparable K19-K25
            'ד': 'ד', // בל"ד comparable K19-K25
        },
        '20-21': {
            'מרצ': 'מרצ', // מרצ comparable K20-K21
            // אמת NOT comparable: המחנה הציוני K20 vs העבודה K21
            // פה NOT comparable: יש עתיד K20 vs כחול לבן K21
        },
        '20-22': {
            'מרצ': 'מרצ', // מרצ comparable K20-K22
            'ודעם': 'ודעם', // הרשימה המשותפת comparable K20-K22
        },
        '20-23': {
            'ודעם': 'ודעם', // הרשימה המשותפת comparable K20-K23
            // אמת NOT comparable: המחנה הציוני K20 vs עבודה-גשר-מרצ K23
        },
        '20-24': {
            'מרצ': 'מרצ', // מרצ comparable K20-K24
            'ודעם': 'ודעם', // הרשימה המשותפת comparable K20-K24
        },
        '20-25': {
            'מרצ': 'מרצ', // מרצ comparable K20-K25
            'אמת': 'אמת', // המחנה הציוני K20 vs העבודה K25 - comparable
            'ל': 'ל', // ישראל ביתנו comparable K20-K25
        },
        '21-22': {
            'פה': 'פה',   // כחול לבן - comparable K21-K22
            'מרצ': 'מרצ', // מרצ comparable K21-K22
            'ל': 'ל',     // ישראל ביתנו comparable K21-K22
            // אמת NOT comparable: עבודה K21 vs עבודה-גשר K22 (different configs)
        },
        '21-23': {
            'פה': 'פה',   // כחול לבן - comparable K21-K23
            // Arab parties: K21 had ום (חד"ש-תע"ל) + דעם (רע"מ-בל"ד) vs K23 ודעם (הרשימה המשותפת)
        },
        '21-24': {
            'מרצ': 'מרצ', // מרצ comparable K21-K24
            // כחול לבן (פה) split in K24 to יש עתיד (פה) + כחול לבן (כן)
        },
        '21-25': {
            'מרצ': 'מרצ', // מרצ comparable K21-K25
            'אמת': 'אמת', // העבודה comparable K21-K25
        },
        '22-23': {
            // K22 כחול לבן (פה) same as K23 - comparable
            'פה': 'פה',   // כחול לבן - comparable K22-K23
            'ל': 'ל',     // ישראל ביתנו - comparable K22-K23
            // K22 העבודה-גשר (אמת) vs K23 העבודה-גשר-מרצ (אמת) - different configs
            // K22 מרצ separate vs K23 merged into אמת - not comparable
            'ודעם': 'ודעם', // הרשימה המשותפת - comparable K22-K23
        },
        '22-24': {
            // K22 כחול לבן (פה) split in K24 to יש עתיד (פה) + כחול לבן (כן)
            'מרצ': 'מרצ', // מרצ - comparable K22-K24
            'ל': 'ל',     // ישראל ביתנו - comparable K22-K24
            'אמת': 'אמת', // העבודה - comparable K22-K24 (עבודה-גשר K22 vs עבודה K24)
            'ודעם': 'ודעם', // הרשימה המשותפת - comparable K22-K24
            // Split comparison: ודעם in K22 -> ודעם + עם in K24
        },
        '22-25': {
            'מרצ': 'מרצ', // מרצ - comparable K22-K25
            'ל': 'ל',     // ישראל ביתנו - comparable K22-K25
            'אמת': 'אמת', // העבודה - comparable K22-K25
            // ודעם split in K25 to חד"ש-תע"ל (ד) + בל"ד (ום) + רע"מ (עם)
            // פה (כחול לבן) split in K25 to יש עתיד (פה) + המחנה הממלכתי (כן)
        },
        '23-24': {
            'ל': 'ל',     // ישראל ביתנו - comparable K23-K24
            // כחול לבן (פה) split into יש עתיד (פה) + כחול לבן (כן) - not comparable
            // עבודה-גשר-מרצ (אמת) split - not comparable
        },
        '23-25': {
            'ל': 'ל',     // ישראל ביתנו - comparable K23-K25
            // Similar issues - merged lists in K23
        },
        '24-25': {
            'עם': 'עם',   // רע"מ - comparable between K24 and K25
            'פה': 'פה',   // יש עתיד - comparable between K24 and K25
            'אמת': 'אמת', // העבודה - comparable between K24 and K25
            'מרצ': 'מרצ', // מרצ - comparable between K24 and K25
            'ל': 'ל',     // ישראל ביתנו - comparable between K24 and K25
        }
    };
    
    let html = '';
    
    if (showBoth) {
        // Show both elections side by side
        const earlierParties = DATA.parties[String(earlierK)];
        const laterParties = DATA.parties[String(laterK)];
        const earlierLocData = earlierK === fromK ? fromLocParties : toLocParties;
        const laterLocData = laterK === fromK ? fromLocParties : toLocParties;
        
        // Create party info maps
        const earlierPartyInfo = {};
        const laterPartyInfo = {};
        earlierParties.party_list.forEach(p => { earlierPartyInfo[p.code] = p; });
        laterParties.party_list.forEach(p => { laterPartyInfo[p.code] = p; });
        
        // Get cross-election mapping for this pair
        const mappingKey = `${earlierK}-${laterK}`;
        const crossMapping = crossElectionMappings[mappingKey] || {};
        const reverseCrossMapping = {};
        for (const [laterCode, earlierCode] of Object.entries(crossMapping)) {
            reverseCrossMapping[earlierCode] = laterCode;
        }
        
        // Find comparable parties
        const comparablePartyCodes = [];  // Will store {earlierCode, laterCode, party}
        const earlierOnlyCodes = [];
        const laterOnlyCodes = [];
        const processedEarlierCodes = new Set();
        const processedLaterCodes = new Set();
        
        // First, handle cross-mapping parties (like בל"ד)
        for (const [laterCode, earlierCode] of Object.entries(crossMapping)) {
            if (earlierPartyInfo[earlierCode] && laterPartyInfo[laterCode]) {
                comparablePartyCodes.push({
                    earlierCode,
                    laterCode,
                    party: laterPartyInfo[laterCode]  // Use later party info for display
                });
                processedEarlierCodes.add(earlierCode);
                processedLaterCodes.add(laterCode);
            }
        }
        
        // Then handle same-code comparable parties
        for (const p of earlierParties.party_list) {
            if (processedEarlierCodes.has(p.code)) continue;
            
            if (laterPartyInfo[p.code] && comparableSameCode[p.code] === true) {
                comparablePartyCodes.push({
                    earlierCode: p.code,
                    laterCode: p.code,
                    party: laterPartyInfo[p.code]
                });
                processedEarlierCodes.add(p.code);
                processedLaterCodes.add(p.code);
            } else {
                earlierOnlyCodes.push(p.code);
            }
        }
        
        // Find later-only parties
        for (const p of laterParties.party_list) {
            if (!processedLaterCodes.has(p.code)) {
                laterOnlyCodes.push(p.code);
            }
        }
        
        // Update title and header
        titleEl.textContent = `תוצאות לפי מפלגה - כנסת ${earlierK} ו-${laterK}`;
        theadRow.innerHTML = `
            <th>מפלגה</th>
            <th>גוש</th>
            <th>כנסת ${earlierK}</th>
            <th>כנסת ${laterK}</th>
            <th>שינוי</th>
            <th>שינוי יחסי</th>
        `;
        
        // 1. Comparable parties
        for (const {earlierCode, laterCode, party} of comparablePartyCodes) {
            const earlierPct = earlierLocData?.[earlierCode];
            const laterPct = laterLocData?.[laterCode];
            
            if (earlierPct === undefined && laterPct === undefined) continue;
            
            const blocDisplay = party.bloc_display || blocNames[party.bloc];
            const earlierStr = earlierPct !== undefined ? `${earlierPct.toFixed(1)}%` : '-';
            const laterStr = laterPct !== undefined ? `${laterPct.toFixed(1)}%` : '-';
            
            let changeStr = '-';
            let relChangeStr = '-';
            if (earlierPct !== undefined && laterPct !== undefined) {
                const change = laterPct - earlierPct;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                changeStr = `<span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span>`;
                
                // Relative change
                if (earlierPct > 0) {
                    const relChange = ((laterPct - earlierPct) / earlierPct) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
            }
            
            html += `
                <tr>
                    <td>${party.name}</td>
                    <td class="bloc-${party.bloc}">${blocDisplay}</td>
                    <td>${earlierStr}</td>
                    <td>${laterStr}</td>
                    <td>${changeStr}</td>
                    <td>${relChangeStr}</td>
                </tr>
            `;
        }
        
        // 2. Earlier-only parties
        if (earlierOnlyCodes.length > 0) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">מפלגות כנסת ${earlierK} בלבד</td></tr>`;
            for (const code of earlierOnlyCodes) {
                const party = earlierPartyInfo[code];
                const pct = earlierLocData?.[code];
                if (pct === undefined) continue;
                
                const blocDisplay = party.bloc_display || blocNames[party.bloc];
                html += `
                    <tr>
                        <td>${party.name}</td>
                        <td class="bloc-${party.bloc}">${blocDisplay}</td>
                        <td>${pct.toFixed(1)}%</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
        }
        
        // 3. Later-only parties
        if (laterOnlyCodes.length > 0) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">מפלגות כנסת ${laterK} בלבד</td></tr>`;
            for (const code of laterOnlyCodes) {
                const party = laterPartyInfo[code];
                const pct = laterLocData?.[code];
                if (pct === undefined) continue;
                
                const blocDisplay = party.bloc_display || blocNames[party.bloc];
                html += `
                    <tr>
                        <td>${party.name}</td>
                        <td class="bloc-${party.bloc}">${blocDisplay}</td>
                        <td>-</td>
                        <td>${pct.toFixed(1)}%</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
        }
        
        // 4. Special merged parties comparison (K24 → K25)
        if (earlierK === 24 && laterK === 25) {
            // תקווה חדשה (ת) + כחול לבן (כן) in K24 → המחנה הממלכתי (כן) in K25
            const tikvaHadasha = earlierLocData?.['ת'] || 0;
            const kacholLavan = earlierLocData?.['כן'] || 0;
            const machaneMamlachti = laterLocData?.['כן'] || 0;
            
            const combinedK24 = tikvaHadasha + kacholLavan;
            const change = machaneMamlachti - combinedK24;
            const sign = change >= 0 ? '+' : '';
            const changeClass = change >= 0 ? 'positive' : 'negative';
            
            // Relative change
            let relChangeStr = '-';
            if (combinedK24 > 0) {
                const relChange = ((machaneMamlachti - combinedK24) / combinedK24) * 100;
                const relSign = relChange >= 0 ? '+' : '';
                const relClass = relChange >= 0 ? 'positive' : 'negative';
                relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
            }
            
            if (combinedK24 > 0 || machaneMamlachti > 0) {
                html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
                html += `
                    <tr>
                        <td>תקווה חדשה + כחול לבן ← המחנה הממלכתי</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${combinedK24.toFixed(1)}%</td>
                        <td>${machaneMamlachti.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // הציונות הדתית (ט) + ימינה (ב) in K24 vs הציונות הדתית (ט) + הבית היהודי (ב) in K25
            const tzionutK24 = earlierLocData?.['ט'] || 0;
            const yaminaK24 = earlierLocData?.['ב'] || 0;
            const combinedRightK24 = tzionutK24 + yaminaK24;
            const tzionutK25 = laterLocData?.['ט'] || 0;
            const bayitK25 = laterLocData?.['ב'] || 0;
            const combinedRightK25 = tzionutK25 + bayitK25;
            
            if (combinedRightK24 > 0 || combinedRightK25 > 0) {
                html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות</td></tr>`;
                
                const changeRight = combinedRightK25 - combinedRightK24;
                const signRight = changeRight >= 0 ? '+' : '';
                const changeClassRight = changeRight >= 0 ? 'positive' : 'negative';
                
                let relChangeStrRight = '-';
                if (combinedRightK24 > 0) {
                    const relChangeRight = ((combinedRightK25 - combinedRightK24) / combinedRightK24) * 100;
                    const relSignRight = relChangeRight >= 0 ? '+' : '';
                    const relClassRight = relChangeRight >= 0 ? 'positive' : 'negative';
                    relChangeStrRight = `<span class="metric-change ${relClassRight}">${relSignRight}${relChangeRight.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הציונות הדתית + ימינה ← הציונות הדתית + הבית היהודי</td>
                        <td class="bloc-right">ימין</td>
                        <td>${combinedRightK24.toFixed(1)}%</td>
                        <td>${combinedRightK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassRight}">${signRight}${changeRight.toFixed(1)}%</span></td>
                        <td>${relChangeStrRight}</td>
                    </tr>
                `;
            }
        }
        
        // 5. Special split parties comparison (K23 → K24)
        if (earlierK === 23 && laterK === 24) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            // העבודה-גשר-מרצ (אמת) in K23 split into העבודה (אמת) + מרצ (מרצ) in K24
            const avodaGesherMeretz = earlierLocData?.['אמת'] || 0;
            const avodaK24 = laterLocData?.['אמת'] || 0;
            const meretzK24 = laterLocData?.['מרצ'] || 0;
            const combinedLeftK24 = avodaK24 + meretzK24;
            
            if (avodaGesherMeretz > 0 || combinedLeftK24 > 0) {
                const changeLeft = combinedLeftK24 - avodaGesherMeretz;
                const signLeft = changeLeft >= 0 ? '+' : '';
                const changeClassLeft = changeLeft >= 0 ? 'positive' : 'negative';
                
                let relChangeStrLeft = '-';
                if (avodaGesherMeretz > 0) {
                    const relChangeLeft = ((combinedLeftK24 - avodaGesherMeretz) / avodaGesherMeretz) * 100;
                    const relSignLeft = relChangeLeft >= 0 ? '+' : '';
                    const relClassLeft = relChangeLeft >= 0 ? 'positive' : 'negative';
                    relChangeStrLeft = `<span class="metric-change ${relClassLeft}">${relSignLeft}${relChangeLeft.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה-גשר-מרצ ← העבודה + מרצ</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${avodaGesherMeretz.toFixed(1)}%</td>
                        <td>${combinedLeftK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassLeft}">${signLeft}${changeLeft.toFixed(1)}%</span></td>
                        <td>${relChangeStrLeft}</td>
                    </tr>
                `;
            }
            
            // כחול לבן (פה) in K23 split into יש עתיד (פה) + כחול לבן (כן) in K24
            const kacholLavanK23 = earlierLocData?.['פה'] || 0;
            const yeshAtidK24 = laterLocData?.['פה'] || 0;
            const kacholLavanK24 = laterLocData?.['כן'] || 0;
            const combinedCenterK24 = yeshAtidK24 + kacholLavanK24;
            
            if (kacholLavanK23 > 0 || combinedCenterK24 > 0) {
                const changeCenter = combinedCenterK24 - kacholLavanK23;
                const signCenter = changeCenter >= 0 ? '+' : '';
                const changeClassCenter = changeCenter >= 0 ? 'positive' : 'negative';
                
                let relChangeStrCenter = '-';
                if (kacholLavanK23 > 0) {
                    const relChangeCenter = ((combinedCenterK24 - kacholLavanK23) / kacholLavanK23) * 100;
                    const relSignCenter = relChangeCenter >= 0 ? '+' : '';
                    const relClassCenter = relChangeCenter >= 0 ? 'positive' : 'negative';
                    relChangeStrCenter = `<span class="metric-change ${relClassCenter}">${relSignCenter}${relChangeCenter.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← כחול לבן + יש עתיד</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK23.toFixed(1)}%</td>
                        <td>${combinedCenterK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassCenter}">${signCenter}${changeCenter.toFixed(1)}%</span></td>
                        <td>${relChangeStrCenter}</td>
                    </tr>
                `;
            }
            
            // הרשימה המשותפת (ודעם) in K23 split into רע"מ (עם) + הרשימה המשותפת (ודעם) in K24
            const jointListK23 = earlierLocData?.['ודעם'] || 0;
            const raamK24 = laterLocData?.['עם'] || 0;
            const jointListK24 = laterLocData?.['ודעם'] || 0;
            const combinedArabK24 = raamK24 + jointListK24;
            
            if (jointListK23 > 0 || combinedArabK24 > 0) {
                const changeArab = combinedArabK24 - jointListK23;
                const signArab = changeArab >= 0 ? '+' : '';
                const changeClassArab = changeArab >= 0 ? 'positive' : 'negative';
                
                let relChangeStrArab = '-';
                if (jointListK23 > 0) {
                    const relChangeArab = ((combinedArabK24 - jointListK23) / jointListK23) * 100;
                    const relSignArab = relChangeArab >= 0 ? '+' : '';
                    const relClassArab = relChangeArab >= 0 ? 'positive' : 'negative';
                    relChangeStrArab = `<span class="metric-change ${relClassArab}">${relSignArab}${relChangeArab.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הרשימה המשותפת ← רע"מ + הרשימה המשותפת</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${jointListK23.toFixed(1)}%</td>
                        <td>${combinedArabK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassArab}">${signArab}${changeArab.toFixed(1)}%</span></td>
                        <td>${relChangeStrArab}</td>
                    </tr>
                `;
            }
        }
        
        // 6. Special split parties comparison (K23 → K25)
        if (earlierK === 23 && laterK === 25) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            // העבודה-גשר-מרצ (אמת) in K23 split into העבודה (אמת) + מרצ (מרצ) in K25
            const avodaGesherMeretzK23 = earlierLocData?.['אמת'] || 0;
            const avodaK25 = laterLocData?.['אמת'] || 0;
            const meretzK25 = laterLocData?.['מרצ'] || 0;
            const combinedLeftK25 = avodaK25 + meretzK25;
            
            if (avodaGesherMeretzK23 > 0 || combinedLeftK25 > 0) {
                const changeLeft = combinedLeftK25 - avodaGesherMeretzK23;
                const signLeft = changeLeft >= 0 ? '+' : '';
                const changeClassLeft = changeLeft >= 0 ? 'positive' : 'negative';
                
                let relChangeStrLeft = '-';
                if (avodaGesherMeretzK23 > 0) {
                    const relChangeLeft = ((combinedLeftK25 - avodaGesherMeretzK23) / avodaGesherMeretzK23) * 100;
                    const relSignLeft = relChangeLeft >= 0 ? '+' : '';
                    const relClassLeft = relChangeLeft >= 0 ? 'positive' : 'negative';
                    relChangeStrLeft = `<span class="metric-change ${relClassLeft}">${relSignLeft}${relChangeLeft.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה-גשר-מרצ ← העבודה + מרצ</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${avodaGesherMeretzK23.toFixed(1)}%</td>
                        <td>${combinedLeftK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassLeft}">${signLeft}${changeLeft.toFixed(1)}%</span></td>
                        <td>${relChangeStrLeft}</td>
                    </tr>
                `;
            }
            
            // כחול לבן (פה) in K23 to יש עתיד (פה) + המחנה הממלכתי (כן) in K25
            const kacholLavanK23 = earlierLocData?.['פה'] || 0;
            const yeshAtidK25 = laterLocData?.['פה'] || 0;
            const machaneMamlachtiK25 = laterLocData?.['כן'] || 0;
            const combinedCenterK25 = yeshAtidK25 + machaneMamlachtiK25;
            
            if (kacholLavanK23 > 0 || combinedCenterK25 > 0) {
                const changeCenter = combinedCenterK25 - kacholLavanK23;
                const signCenter = changeCenter >= 0 ? '+' : '';
                const changeClassCenter = changeCenter >= 0 ? 'positive' : 'negative';
                
                let relChangeStrCenter = '-';
                if (kacholLavanK23 > 0) {
                    const relChangeCenter = ((combinedCenterK25 - kacholLavanK23) / kacholLavanK23) * 100;
                    const relSignCenter = relChangeCenter >= 0 ? '+' : '';
                    const relClassCenter = relChangeCenter >= 0 ? 'positive' : 'negative';
                    relChangeStrCenter = `<span class="metric-change ${relClassCenter}">${relSignCenter}${relChangeCenter.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← יש עתיד + המחנה הממלכתי</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK23.toFixed(1)}%</td>
                        <td>${combinedCenterK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassCenter}">${signCenter}${changeCenter.toFixed(1)}%</span></td>
                        <td>${relChangeStrCenter}</td>
                    </tr>
                `;
            }
            
            // הרשימה המשותפת (ודעם) in K23 to רע"מ (עם) + חד"ש-תע"ל (ום) + בל"ד (ד) in K25
            const jointListK23 = earlierLocData?.['ודעם'] || 0;
            const raamK25 = laterLocData?.['עם'] || 0;
            const hadashTaalK25 = laterLocData?.['ום'] || 0;
            const baladK25 = laterLocData?.['ד'] || 0;
            const combinedArabK25 = raamK25 + hadashTaalK25 + baladK25;
            
            if (jointListK23 > 0 || combinedArabK25 > 0) {
                const changeArab = combinedArabK25 - jointListK23;
                const signArab = changeArab >= 0 ? '+' : '';
                const changeClassArab = changeArab >= 0 ? 'positive' : 'negative';
                
                let relChangeStrArab = '-';
                if (jointListK23 > 0) {
                    const relChangeArab = ((combinedArabK25 - jointListK23) / jointListK23) * 100;
                    const relSignArab = relChangeArab >= 0 ? '+' : '';
                    const relClassArab = relChangeArab >= 0 ? 'positive' : 'negative';
                    relChangeStrArab = `<span class="metric-change ${relClassArab}">${relSignArab}${relChangeArab.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הרשימה המשותפת ← רע"מ + חד"ש-תע"ל + בל"ד</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${jointListK23.toFixed(1)}%</td>
                        <td>${combinedArabK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassArab}">${signArab}${changeArab.toFixed(1)}%</span></td>
                        <td>${relChangeStrArab}</td>
                    </tr>
                `;
            }
        }
        
        // 7. Special merge comparison (K22 → K23): העבודה-גשר + מרצ merged into העבודה-גשר-מרצ
        if (earlierK === 22 && laterK === 23) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
            
            const avodaGesherK22 = earlierLocData?.['אמת'] || 0;
            const meretzK22 = earlierLocData?.['מרצ'] || 0;
            const combinedK22 = avodaGesherK22 + meretzK22;
            const avodaGesherMeretzK23 = laterLocData?.['אמת'] || 0;
            
            if (combinedK22 > 0 || avodaGesherMeretzK23 > 0) {
                const change = avodaGesherMeretzK23 - combinedK22;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedK22 > 0) {
                    const relChange = ((avodaGesherMeretzK23 - combinedK22) / combinedK22) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה-גשר + מרצ ← העבודה-גשר-מרצ</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${combinedK22.toFixed(1)}%</td>
                        <td>${avodaGesherMeretzK23.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 8. Special split comparison (K22 → K24): כחול לבן split into יש עתיד + כחול לבן
        if (earlierK === 22 && laterK === 24) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            const kacholLavanK22 = earlierLocData?.['פה'] || 0;
            const yeshAtidK24 = laterLocData?.['פה'] || 0;
            const kacholLavanK24 = laterLocData?.['כן'] || 0;
            const combinedCenterK24 = yeshAtidK24 + kacholLavanK24;
            
            if (kacholLavanK22 > 0 || combinedCenterK24 > 0) {
                const change = combinedCenterK24 - kacholLavanK22;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (kacholLavanK22 > 0) {
                    const relChange = ((combinedCenterK24 - kacholLavanK22) / kacholLavanK22) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← יש עתיד + כחול לבן</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK22.toFixed(1)}%</td>
                        <td>${combinedCenterK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // הרשימה המשותפת (ודעם) in K22 split into הרשימה המשותפת (ודעם) + רע"מ (עם) in K24
            const jointListK22 = earlierLocData?.['ודעם'] || 0;
            const jointListK24 = laterLocData?.['ודעם'] || 0;
            const raamK24 = laterLocData?.['עם'] || 0;
            const combinedArabK24 = jointListK24 + raamK24;
            
            if (jointListK22 > 0 || combinedArabK24 > 0) {
                const change = combinedArabK24 - jointListK22;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (jointListK22 > 0) {
                    const relChange = ((combinedArabK24 - jointListK22) / jointListK22) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הרשימה המשותפת ← הרשימה המשותפת + רע"מ</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${jointListK22.toFixed(1)}%</td>
                        <td>${combinedArabK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 8b. Special split comparison (K22 → K25): Multiple splits
        if (earlierK === 22 && laterK === 25) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            // הרשימה המשותפת (ודעם) in K22 split into רע"מ (עם) + חד"ש-תע"ל (ום) + בל"ד (ד) in K25
            const jointListK22 = earlierLocData?.['ודעם'] || 0;
            const raamK25 = laterLocData?.['עם'] || 0;
            const hadashTaalK25 = laterLocData?.['ום'] || 0;
            const baladK25 = laterLocData?.['ד'] || 0;
            const combinedArabK25 = raamK25 + hadashTaalK25 + baladK25;
            
            if (jointListK22 > 0 || combinedArabK25 > 0) {
                const change = combinedArabK25 - jointListK22;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (jointListK22 > 0) {
                    const relChange = ((combinedArabK25 - jointListK22) / jointListK22) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הרשימה המשותפת ← רע"מ + חד"ש-תע"ל + בל"ד</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${jointListK22.toFixed(1)}%</td>
                        <td>${combinedArabK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // כחול לבן (פה) in K22 split into יש עתיד (פה) + המחנה הממלכתי (כן) in K25
            const kacholLavanK22 = earlierLocData?.['פה'] || 0;
            const yeshAtidK25 = laterLocData?.['פה'] || 0;
            const machaneK25 = laterLocData?.['כן'] || 0;
            const combinedCenterK25 = yeshAtidK25 + machaneK25;
            
            if (kacholLavanK22 > 0 || combinedCenterK25 > 0) {
                const change = combinedCenterK25 - kacholLavanK22;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (kacholLavanK22 > 0) {
                    const relChange = ((combinedCenterK25 - kacholLavanK22) / kacholLavanK22) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← יש עתיד + המחנה הממלכתי</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK22.toFixed(1)}%</td>
                        <td>${combinedCenterK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 9. Special merge comparison (K18 → K19): Religious-right parties merged
        if (earlierK === 18 && laterK === 19) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
            
            // Religious-right: הבית היהודי (ב) + האיחוד הלאומי (ט) in K18 → הבית היהודי (טב) in K19
            const bayitK18 = earlierLocData?.['ב'] || 0;
            const ichudK18 = earlierLocData?.['ט'] || 0;
            const combinedReligiousK18 = bayitK18 + ichudK18;
            const bayitYehudiK19 = laterLocData?.['טב'] || 0;
            
            if (combinedReligiousK18 > 0 || bayitYehudiK19 > 0) {
                const change = bayitYehudiK19 - combinedReligiousK18;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedReligiousK18 > 0) {
                    const relChange = ((bayitYehudiK19 - combinedReligiousK18) / combinedReligiousK18) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הבית היהודי + האיחוד הלאומי ← הבית היהודי</td>
                        <td class="bloc-right">ימין</td>
                        <td>${combinedReligiousK18.toFixed(1)}%</td>
                        <td>${bayitYehudiK19.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Likud merge: הליכוד (מחל) + ישראל ביתנו (ל) in K18 ran together as ליכוד-ישראל ביתנו (מחל) in K19
            const likudK18 = earlierLocData?.['מחל'] || 0;
            const yisraelBeitenuK18 = earlierLocData?.['ל'] || 0;
            const combinedLikudK18 = likudK18 + yisraelBeitenuK18;
            const likudYBK19 = laterLocData?.['מחל'] || 0;
            
            if (combinedLikudK18 > 0 || likudYBK19 > 0) {
                const change = likudYBK19 - combinedLikudK18;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedLikudK18 > 0) {
                    const relChange = ((likudYBK19 - combinedLikudK18) / combinedLikudK18) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הליכוד ← הליכוד-ישראל ביתנו</td>
                        <td class="bloc-right">ימין</td>
                        <td>${combinedLikudK18.toFixed(1)}%</td>
                        <td>${likudYBK19.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 9b. Special comparison (K18 → K25): Religious-right parties
        if (earlierK === 18 && laterK === 25) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות</td></tr>`;
            
            // האיחוד הלאומי (ט) + הבית היהודי (ב) in K18 vs הציונות הדתית (ט) + הבית היהודי (ב) in K25
            const ichudK18 = earlierLocData?.['ט'] || 0;
            const bayitK18 = earlierLocData?.['ב'] || 0;
            const combinedRightK18 = ichudK18 + bayitK18;
            const tzionutK25 = laterLocData?.['ט'] || 0;
            const bayitK25 = laterLocData?.['ב'] || 0;
            const combinedRightK25 = tzionutK25 + bayitK25;
            
            if (combinedRightK18 > 0 || combinedRightK25 > 0) {
                const change = combinedRightK25 - combinedRightK18;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedRightK18 > 0) {
                    const relChange = ((combinedRightK25 - combinedRightK18) / combinedRightK18) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>האיחוד הלאומי + הבית היהודי ← הציונות הדתית + הבית היהודי</td>
                        <td class="bloc-right">ימין</td>
                        <td>${combinedRightK18.toFixed(1)}%</td>
                        <td>${combinedRightK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 10. Special merge comparison (K19 → K20): Left parties and Arab parties merged
        if (earlierK === 19 && laterK === 20) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
            
            // Left parties: העבודה (אמת) + התנועה (צפ) in K19 → המחנה הציוני (אמת) in K20
            const avodaK19 = earlierLocData?.['אמת'] || 0;
            const hatnuaK19 = earlierLocData?.['צפ'] || 0;
            const combinedLeftK19 = avodaK19 + hatnuaK19;
            const zionistCampK20 = laterLocData?.['אמת'] || 0;
            
            if (combinedLeftK19 > 0 || zionistCampK20 > 0) {
                const change = zionistCampK20 - combinedLeftK19;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedLeftK19 > 0) {
                    const relChange = ((zionistCampK20 - combinedLeftK19) / combinedLeftK19) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה + התנועה ← המחנה הציוני</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${combinedLeftK19.toFixed(1)}%</td>
                        <td>${zionistCampK20.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Arab parties: חד"ש (ו) + רע"מ-תע"ל (עם) + בל"ד (ד) in K19 → הרשימה המשותפת (ודעם) in K20
            const hadashK19 = earlierLocData?.['ו'] || 0;
            const raamTaalK19 = earlierLocData?.['עם'] || 0;
            const baladK19 = earlierLocData?.['ד'] || 0;
            const combinedArabK19 = hadashK19 + raamTaalK19 + baladK19;
            const jointListK20 = laterLocData?.['ודעם'] || 0;
            
            if (combinedArabK19 > 0 || jointListK20 > 0) {
                const change = jointListK20 - combinedArabK19;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedArabK19 > 0) {
                    const relChange = ((jointListK20 - combinedArabK19) / combinedArabK19) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>חד"ש + רע"מ-תע"ל + בל"ד ← הרשימה המשותפת</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${combinedArabK19.toFixed(1)}%</td>
                        <td>${jointListK20.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 10b. Special comparison (K19 → K25): Religious-right parties
        if (earlierK === 19 && laterK === 25) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות</td></tr>`;
            
            // הבית היהודי (טב) + עוצמה לישראל (נץ) in K19 vs הבית היהודי (ב) + עוצמה יהודית (ט) in K25
            const bayitYehudiK19 = earlierLocData?.['טב'] || 0;
            const otzmaK19 = earlierLocData?.['נץ'] || 0;
            const combinedRightK19 = bayitYehudiK19 + otzmaK19;
            const bayitYehudiK25 = laterLocData?.['ב'] || 0;
            const otzmaK25 = laterLocData?.['ט'] || 0;
            const combinedRightK25 = bayitYehudiK25 + otzmaK25;
            
            if (combinedRightK19 > 0 || combinedRightK25 > 0) {
                const change = combinedRightK25 - combinedRightK19;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedRightK19 > 0) {
                    const relChange = ((combinedRightK25 - combinedRightK19) / combinedRightK19) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>הבית היהודי + עוצמה לישראל ← הבית היהודי + עוצמה יהודית</td>
                        <td class="bloc-right">ימין</td>
                        <td>${combinedRightK19.toFixed(1)}%</td>
                        <td>${combinedRightK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 10. Special merge comparison (K21 → K22): Arab parties merged, Labor+Gesher merged
        if (earlierK === 21 && laterK === 22) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
            
            // Arab parties: חד"ש-תע"ל (ום) + רע"מ-בל"ד (דעם) in K21 → הרשימה המשותפת (ודעם) in K22
            const hadashTaalK21 = earlierLocData?.['ום'] || 0;
            const raamBaladK21 = earlierLocData?.['דעם'] || 0;
            const combinedArabK21 = hadashTaalK21 + raamBaladK21;
            const jointListK22 = laterLocData?.['ודעם'] || 0;
            
            if (combinedArabK21 > 0 || jointListK22 > 0) {
                const change = jointListK22 - combinedArabK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedArabK21 > 0) {
                    const relChange = ((jointListK22 - combinedArabK21) / combinedArabK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>חד"ש-תע"ל + רע"מ-בל"ד ← הרשימה המשותפת</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${combinedArabK21.toFixed(1)}%</td>
                        <td>${jointListK22.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Labor merge: עבודה (אמת) + גשר (נר) in K21 → עבודה-גשר (אמת) in K22
            const avodaK21 = earlierLocData?.['אמת'] || 0;
            const gesherK21 = earlierLocData?.['נר'] || 0;
            const combinedLaborK21 = avodaK21 + gesherK21;
            const avodaGesherK22 = laterLocData?.['אמת'] || 0;
            
            if (combinedLaborK21 > 0 || avodaGesherK22 > 0) {
                const change = avodaGesherK22 - combinedLaborK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedLaborK21 > 0) {
                    const relChange = ((avodaGesherK22 - combinedLaborK21) / combinedLaborK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה + גשר ← העבודה-גשר</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${combinedLaborK21.toFixed(1)}%</td>
                        <td>${avodaGesherK22.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 12. Special merge comparison (K21 → K23): Arab parties + Left parties merged
        if (earlierK === 21 && laterK === 23) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתמזגו</td></tr>`;
            
            // Arab parties: חד"ש-תע"ל (ום) + רע"מ-בל"ד (דעם) in K21 → הרשימה המשותפת (ודעם) in K23
            const hadashTaalK21 = earlierLocData?.['ום'] || 0;
            const raamBaladK21 = earlierLocData?.['דעם'] || 0;
            const combinedArabK21 = hadashTaalK21 + raamBaladK21;
            const jointListK23 = laterLocData?.['ודעם'] || 0;
            
            if (combinedArabK21 > 0 || jointListK23 > 0) {
                const change = jointListK23 - combinedArabK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedArabK21 > 0) {
                    const relChange = ((jointListK23 - combinedArabK21) / combinedArabK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>חד"ש-תע"ל + רע"מ-בל"ד ← הרשימה המשותפת</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${combinedArabK21.toFixed(1)}%</td>
                        <td>${jointListK23.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Left parties: עבודה (אמת) + מרצ + גשר (נר) in K21 → עבודה-גשר-מרצ (אמת) in K23
            const avodaK21 = earlierLocData?.['אמת'] || 0;
            const meretzK21 = earlierLocData?.['מרצ'] || 0;
            const gesherK21 = earlierLocData?.['נר'] || 0;
            const combinedLeftK21 = avodaK21 + meretzK21 + gesherK21;
            const avodaGesherMeretzK23 = laterLocData?.['אמת'] || 0;
            
            if (combinedLeftK21 > 0 || avodaGesherMeretzK23 > 0) {
                const change = avodaGesherMeretzK23 - combinedLeftK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (combinedLeftK21 > 0) {
                    const relChange = ((avodaGesherMeretzK23 - combinedLeftK21) / combinedLeftK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>העבודה + מרצ + גשר ← העבודה-גשר-מרצ</td>
                        <td class="bloc-left">שמאל</td>
                        <td>${combinedLeftK21.toFixed(1)}%</td>
                        <td>${avodaGesherMeretzK23.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Center parties: כולנו (כ) in K21 merged into Likud in later elections
            const kulanuK21 = earlierLocData?.['כ'] || 0;
            if (kulanuK21 > 0) {
                html += `
                    <tr>
                        <td>כולנו (התמזגה לליכוד)</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kulanuK21.toFixed(1)}%</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
        }
        
        // 13. Special split comparison (K21 → K24): כחול לבן split
        if (earlierK === 21 && laterK === 24) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            const kacholLavanK21 = earlierLocData?.['פה'] || 0;
            const yeshAtidK24 = laterLocData?.['פה'] || 0;
            const kacholLavanK24 = laterLocData?.['כן'] || 0;
            const combinedCenterK24 = yeshAtidK24 + kacholLavanK24;
            
            if (kacholLavanK21 > 0 || combinedCenterK24 > 0) {
                const change = combinedCenterK24 - kacholLavanK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (kacholLavanK21 > 0) {
                    const relChange = ((combinedCenterK24 - kacholLavanK21) / kacholLavanK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← יש עתיד + כחול לבן</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK21.toFixed(1)}%</td>
                        <td>${combinedCenterK24.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
        }
        
        // 11b. Special split comparison (K21 → K25): כחול לבן split
        if (earlierK === 21 && laterK === 25) {
            html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות שהתפצלו</td></tr>`;
            
            // כחול לבן (פה) in K21 split into יש עתיד (פה) + המחנה הממלכתי (כן) in K25
            const kacholLavanK21 = earlierLocData?.['פה'] || 0;
            const yeshAtidK25 = laterLocData?.['פה'] || 0;
            const machaneK25 = laterLocData?.['כן'] || 0;
            const combinedCenterK25 = yeshAtidK25 + machaneK25;
            
            if (kacholLavanK21 > 0 || combinedCenterK25 > 0) {
                const change = combinedCenterK25 - kacholLavanK21;
                const sign = change >= 0 ? '+' : '';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                let relChangeStr = '-';
                if (kacholLavanK21 > 0) {
                    const relChange = ((combinedCenterK25 - kacholLavanK21) / kacholLavanK21) * 100;
                    const relSign = relChange >= 0 ? '+' : '';
                    const relClass = relChange >= 0 ? 'positive' : 'negative';
                    relChangeStr = `<span class="metric-change ${relClass}">${relSign}${relChange.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>כחול לבן ← יש עתיד + המחנה הממלכתי</td>
                        <td class="bloc-center">מרכז</td>
                        <td>${kacholLavanK21.toFixed(1)}%</td>
                        <td>${combinedCenterK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClass}">${sign}${change.toFixed(1)}%</span></td>
                        <td>${relChangeStr}</td>
                    </tr>
                `;
            }
            
            // Arab parties: חד"ש-תע"ל (ום) + רע"מ-בל"ד (דעם) in K21 vs חד"ש-תע"ל (ום) + רע"מ (עם) + בל"ד (ד) in K25
            const hadashTaalK21 = earlierLocData?.['ום'] || 0;
            const raamBaladK21 = earlierLocData?.['דעם'] || 0;
            const combinedArabK21 = hadashTaalK21 + raamBaladK21;
            
            const hadashTaalK25 = laterLocData?.['ום'] || 0;
            const raamK25 = laterLocData?.['עם'] || 0;
            const baladK25 = laterLocData?.['ד'] || 0;
            const combinedArabK25 = hadashTaalK25 + raamK25 + baladK25;
            
            if (combinedArabK21 > 0 || combinedArabK25 > 0) {
                html += `<tr class="section-divider"><td colspan="6" style="background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; padding: 0.5rem;">השוואת מפלגות</td></tr>`;
                
                const changeArab = combinedArabK25 - combinedArabK21;
                const signArab = changeArab >= 0 ? '+' : '';
                const changeClassArab = changeArab >= 0 ? 'positive' : 'negative';
                
                let relChangeStrArab = '-';
                if (combinedArabK21 > 0) {
                    const relChangeArab = ((combinedArabK25 - combinedArabK21) / combinedArabK21) * 100;
                    const relSignArab = relChangeArab >= 0 ? '+' : '';
                    const relClassArab = relChangeArab >= 0 ? 'positive' : 'negative';
                    relChangeStrArab = `<span class="metric-change ${relClassArab}">${relSignArab}${relChangeArab.toFixed(0)}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>חד"ש-תע"ל + רע"מ-בל"ד ← חד"ש-תע"ל + רע"מ + בל"ד</td>
                        <td class="bloc-arab">ערבים</td>
                        <td>${combinedArabK21.toFixed(1)}%</td>
                        <td>${combinedArabK25.toFixed(1)}%</td>
                        <td><span class="metric-change ${changeClassArab}">${signArab}${changeArab.toFixed(1)}%</span></td>
                        <td>${relChangeStrArab}</td>
                    </tr>
                `;
            }
        }
    } else {
        // Single election view
        const activeElection = fromParties && fromLocParties ? fromK : toK;
        const partiesData = DATA.parties[String(activeElection)];
        const locParties = activeElection === fromK ? fromLocParties : toLocParties;
        
        titleEl.textContent = `תוצאות לפי מפלגה - ${partiesData.election_name}`;
        theadRow.innerHTML = `
            <th>מפלגה</th>
            <th>גוש</th>
            <th>אחוז</th>
        `;
        
        for (const party of partiesData.party_list) {
            const pct = locParties[party.code];
            if (pct !== undefined) {
                const blocDisplay = party.bloc_display || blocNames[party.bloc];
                html += `
                    <tr>
                        <td>${party.name}</td>
                        <td class="bloc-${party.bloc}">${blocDisplay}</td>
                        <td>${pct.toFixed(1)}%</td>
                    </tr>
                `;
            }
        }
    }
    
    tbody.innerHTML = html;
}

function closeLocalityDetail() {
    state.selectedLocality = null;
    document.getElementById('locality-detail').classList.remove('active');
}

function renderLocalityBlocsChart(locality) {
    const ctx = document.getElementById('locality-blocs-chart').getContext('2d');
    
    if (charts.localityBlocs) charts.localityBlocs.destroy();
    
    const elections = Object.keys(locality.data).map(Number).sort((a, b) => a - b);
    
    charts.localityBlocs = new Chart(ctx, {
        type: 'line',
        data: {
            labels: elections.map(k => k.toString()),
            datasets: [
                {
                    label: 'ימין-חרדים',
                    data: elections.map(k => locality.data[k]?.right_haredi_pct),
                    borderColor: '#4a9eff',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'מרכז-שמאל-ערבים',
                    data: elections.map(k => locality.data[k]?.center_left_arab_pct),
                    borderColor: '#ff6b6b',
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { family: 'Heebo' } }
                }
            },
            scales: {
                x: { ticks: { color: '#8ba3c7' }, grid: { color: 'rgba(74, 158, 255, 0.1)' } },
                y: { 
                    beginAtZero: true, 
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderLocalityTrendsChart(locality) {
    const ctx = document.getElementById('locality-trends-chart').getContext('2d');
    
    if (charts.localityTrends) charts.localityTrends.destroy();
    
    const elections = Object.keys(locality.data).map(Number).sort((a, b) => a - b);
    
    charts.localityTrends = new Chart(ctx, {
        type: 'line',
        data: {
            labels: elections.map(k => k.toString()),
            datasets: [
                {
                    label: 'ימין',
                    data: elections.map(k => locality.data[k]?.right_pct),
                    borderColor: '#4a9eff',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'חרדים',
                    data: elections.map(k => locality.data[k]?.haredi_pct),
                    borderColor: '#9b59b6',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'מרכז',
                    data: elections.map(k => locality.data[k]?.center_pct),
                    borderColor: '#2ecc71',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'ימין אופוזיציוני',
                    data: elections.map(k => locality.data[k]?.opposition_right_pct || (k >= 21 ? 0 : null)),
                    borderColor: '#00bcd4',
                    tension: 0.3,
                    fill: false,
                    borderDash: [5, 3]
                },
                {
                    label: 'שמאל',
                    data: elections.map(k => locality.data[k]?.left_pct),
                    borderColor: '#e74c3c',
                    tension: 0.3,
                    fill: false
                },
                {
                    label: 'ערבים',
                    data: elections.map(k => locality.data[k]?.arab_pct),
                    borderColor: '#f39c12',
                    tension: 0.3,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { family: 'Heebo' } }
                }
            },
            scales: {
                x: { ticks: { color: '#8ba3c7' }, grid: { color: 'rgba(74, 158, 255, 0.1)' } },
                y: { 
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderTopMovers() {
    const fromK = state.locFromElection;
    const toK = state.locToElection;
    
    // Get localities with both elections and 10k+ voters
    const movers = DATA.localities.filter(loc => {
        const fromData = loc.data[fromK];
        const toData = loc.data[toK];
        return fromData && toData && toData.eligible >= 10000;
    }).map(loc => {
        const fromData = loc.data[fromK];
        const toData = loc.data[toK];
        return {
            name: loc.name,
            rightHarediChange: (toData.right_haredi_pct || 0) - (fromData.right_haredi_pct || 0),
            centerLeftChange: (toData.center_left_arab_pct || 0) - (fromData.center_left_arab_pct || 0)
        };
    });

    // Top center-left gains
    const topCenterLeft = [...movers].sort((a, b) => b.centerLeftChange - a.centerLeftChange).slice(0, 7);
    document.getElementById('movers-center-left').innerHTML = topCenterLeft.map(m => `
        <div class="mover-row">
            <span class="mover-name">${m.name}</span>
            <span class="mover-change positive">+${m.centerLeftChange.toFixed(1)}%</span>
        </div>
    `).join('');

    // Top right-haredi gains
    const topRightHaredi = [...movers].sort((a, b) => b.rightHarediChange - a.rightHarediChange).slice(0, 7);
    document.getElementById('movers-right-haredi').innerHTML = topRightHaredi.map(m => `
        <div class="mover-row">
            <span class="mover-name">${m.name}</span>
            <span class="mover-change ${m.rightHarediChange >= 0 ? 'positive' : 'negative'}">${m.rightHarediChange >= 0 ? '+' : ''}${m.rightHarediChange.toFixed(1)}%</span>
        </div>
    `).join('');
}

// ==================== SOCIOECONOMIC SECTION ====================
function renderSocioeconomicSection() {
    const k = state.socioElection;
    const demoYear = getDemoYear(k);
    
    // Use all municipalities with socio data - individual charts will filter as needed
    const data = DATA.socioeconomic.filter(m => m.socio_cluster_2021 || m.socio_cluster || getSocioCluster(m, demoYear));
    
    // Count those with election data for selected election
    const withElectionData = data.filter(m => 
        m.election_data && 
        m.election_data[k] &&
        m.election_data[k].right_haredi_pct !== null
    );

    // Update count in nav button (show total socio municipalities)
    document.getElementById('socio-count').textContent = data.length;
    
    // Show which demographic year is being used
    const demoYearLabel = document.getElementById('demo-year-label');
    if (demoYearLabel) {
        demoYearLabel.textContent = `נתונים דמוגרפיים: קובץ רשויות ${demoYear}`;
    }

    renderScatterIncome(data, k, demoYear);
    renderScatterAcademic(data, k, demoYear);
    renderClusterBarChart(data, k, demoYear);
    renderScatterAbroad(data, k, demoYear);
    renderScatterChildren(data, k, demoYear);
    renderScatterChildrenCapped(data, k, demoYear);
    renderScatterRussians(data, k, demoYear);
    renderCorrelationMatrix(data, k, demoYear);
    renderCorrelationTrends(data);
    renderGeoSorting(data, demoYear);
    renderRegressionModel(data, k, demoYear);
}

function getClusterColor(cluster) {
    if (cluster <= 3) return '#e74c3c';
    if (cluster <= 6) return '#f1c40f';
    return '#2ecc71';
}

function isArabLocality(m) {
    return m.religion && m.religion.pct_arabs >= 60;
}

function isDruzeLocality(m) {
    return m.religion && m.religion.pct_druze >= 55;
}

function getPointStyle(m, demoYear) {
    if (isDruzeLocality(m)) return { bg: 'rgba(128, 128, 128, 0.1)', border: '#888888', width: 2, label: 'דרוזי' };
    if (isArabLocality(m)) return { bg: 'rgba(255, 255, 255, 0.1)', border: '#ffffff', width: 2, label: 'ערבי' };
    const cluster = demoYear ? getSocioCluster(m, demoYear) : (m.socio_cluster_2021 || m.socio_cluster);
    return { bg: getClusterColor(cluster) + '99', border: getClusterColor(cluster), width: 1, label: '' };
}

function renderScatterIncome(data, k, demoYear) {
    const ctx = document.getElementById('scatter-income').getContext('2d');
    
    if (charts.scatterIncome) charts.scatterIncome.destroy();
    
    const points = data.filter(m => 
        getDemoValue(m, 'avg_monthly_income_per_capita', demoYear) && 
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => {
        const style = getPointStyle(m, demoYear);
        return {
            x: getDemoValue(m, 'avg_monthly_income_per_capita', demoYear),
            y: m.election_data[k].right_haredi_pct,
            r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
            name: m.name,
            style: style
        };
    });

    charts.scatterIncome = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.style.bg),
                borderColor: points.map(p => p.style.border),
                borderWidth: points.map(p => p.style.width)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: הכנסה ₪${p.x.toLocaleString()}, ימין-חרדים ${p.y.toFixed(1)}%${p.style.label ? ' (' + p.style.label + ')' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'הכנסה חודשית לנפש (₪)', color: '#8ba3c7' },
                    ticks: { color: '#8ba3c7', callback: (v) => '₪' + (v/1000).toFixed(0) + 'K' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderScatterAcademic(data, k, demoYear) {
    const ctx = document.getElementById('scatter-academic').getContext('2d');
    
    if (charts.scatterAcademic) charts.scatterAcademic.destroy();
    
    const points = data.filter(m => 
        getDemoValue(m, 'pct_academic_degree', demoYear) && 
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => {
        const style = getPointStyle(m, demoYear);
        return {
            x: getDemoValue(m, 'pct_academic_degree', demoYear),
            y: m.election_data[k].right_haredi_pct,
            r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
            name: m.name,
            style: style
        };
    });

    charts.scatterAcademic = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.style.bg),
                borderColor: points.map(p => p.style.border),
                borderWidth: points.map(p => p.style.width)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: אקדמאים ${p.x.toFixed(1)}%, ימין-חרדים ${p.y.toFixed(1)}%${p.style.label ? ' (' + p.style.label + ')' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: '% בעלי תואר אקדמי (גילאי 27-54)', color: '#8ba3c7' },
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderClusterBarChart(data, k, demoYear) {
    const ctx = document.getElementById('cluster-bar-chart').getContext('2d');
    
    if (charts.clusterBar) charts.clusterBar.destroy();
    
    // Group by cluster - weighted by eligible voters
    const clusters = {};
    for (let i = 1; i <= 10; i++) clusters[i] = { rightSum: 0, centerSum: 0, weight: 0 };
    
    data.forEach(m => {
        const c = getSocioCluster(m, demoYear);
        if (c >= 1 && c <= 10 && m.election_data?.[k]) {
            const w = m.election_data[k].eligible || 0;
            if (w > 0 && m.election_data[k].right_haredi_pct !== undefined) {
                clusters[c].rightSum += m.election_data[k].right_haredi_pct * w;
                clusters[c].centerSum += m.election_data[k].center_left_arab_pct * w;
                clusters[c].weight += w;
            }
        }
    });

    const avgRightHaredi = [];
    const avgCenterLeftArab = [];
    
    for (let i = 1; i <= 10; i++) {
        avgRightHaredi.push(clusters[i].weight > 0 ? clusters[i].rightSum / clusters[i].weight : 0);
        avgCenterLeftArab.push(clusters[i].weight > 0 ? clusters[i].centerSum / clusters[i].weight : 0);
    }

    charts.clusterBar = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['אשכול 1', 'אשכול 2', 'אשכול 3', 'אשכול 4', 'אשכול 5', 'אשכול 6', 'אשכול 7', 'אשכול 8', 'אשכול 9', 'אשכול 10'],
            datasets: [
                {
                    label: 'ימין-חרדים',
                    data: avgRightHaredi,
                    backgroundColor: '#4a9eff'
                },
                {
                    label: 'מרכז-שמאל-ערבים',
                    data: avgCenterLeftArab,
                    backgroundColor: '#ff6b6b'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { family: 'Heebo' } }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8ba3c7' },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderScatterAbroad(data, k, demoYear) {
    const ctx = document.getElementById('scatter-abroad').getContext('2d');
    
    if (charts.scatterAbroad) charts.scatterAbroad.destroy();
    
    // This field doesn't exist in 2008
    const abroadValue = m => getDemoValue(m, 'avg_days_abroad', demoYear);
    
    const points = data.filter(m => 
        abroadValue(m) && 
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => {
        const style = getPointStyle(m, demoYear);
        return {
            x: abroadValue(m),
            y: m.election_data[k].right_haredi_pct,
            r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
            name: m.name,
            style: style
        };
    });
    
    // If no data (e.g., 2008), hide the chart container
    const container = document.getElementById('scatter-abroad')?.closest('.chart-container');
    if (container) {
        container.style.display = points.length > 0 ? 'block' : 'none';
    }
    
    if (points.length === 0) return;

    charts.scatterAbroad = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.style.bg),
                borderColor: points.map(p => p.style.border),
                borderWidth: points.map(p => p.style.width)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: ימי חו"ל ${p.x.toFixed(1)}, ימין-חרדים ${p.y.toFixed(1)}%${p.style.label ? ' (' + p.style.label + ')' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'ממוצע ימי שהייה בחו״ל', color: '#8ba3c7' },
                    ticks: { color: '#8ba3c7' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderScatterChildren(data, k, demoYear) {
    const ctx = document.getElementById('scatter-children').getContext('2d');
    
    if (charts.scatterChildren) charts.scatterChildren.destroy();
    
    const childrenValue = m => getDemoValue(m, 'pct_families_4plus_children', demoYear);
    
    const points = data.filter(m => 
        childrenValue(m) && 
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => {
        const style = getPointStyle(m, demoYear);
        return {
            x: childrenValue(m),
            y: m.election_data[k].right_haredi_pct,
            r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
            name: m.name,
            style: style
        };
    });
    
    // If no data (e.g., 2008), hide the chart container
    const container = document.getElementById('scatter-children')?.closest('.chart-container');
    if (container) {
        container.style.display = points.length > 0 ? 'block' : 'none';
    }
    
    if (points.length === 0) return;

    charts.scatterChildren = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.style.bg),
                borderColor: points.map(p => p.style.border),
                borderWidth: points.map(p => p.style.width)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: משפחות 4+ ילדים ${p.x.toFixed(1)}%, ימין-חרדים ${p.y.toFixed(1)}%${p.style.label ? ' (' + p.style.label + ')' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: '% משפחות עם 4 ילדים ומעלה', color: '#8ba3c7' },
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

function renderScatterChildrenCapped(data, k, demoYear) {
    const ctx = document.getElementById('scatter-children-capped').getContext('2d');
    
    if (charts.scatterChildrenCapped) charts.scatterChildrenCapped.destroy();
    
    const childrenValue = m => getDemoValue(m, 'pct_families_4plus_children', demoYear);
    
    // Filter to only include municipalities with <= 20% families with 4+ children
    const points = data.filter(m => 
        childrenValue(m) && 
        childrenValue(m) <= 20 &&
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => {
        const style = getPointStyle(m, demoYear);
        return {
            x: childrenValue(m),
            y: m.election_data[k].right_haredi_pct,
            r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
            name: m.name,
            style: style
        };
    });
    
    // If no data (e.g., 2008), hide the chart container
    const container = document.getElementById('scatter-children-capped')?.closest('.chart-container');
    if (container) {
        container.style.display = points.length > 0 ? 'block' : 'none';
    }
    
    if (points.length === 0) return;

    charts.scatterChildrenCapped = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.style.bg),
                borderColor: points.map(p => p.style.border),
                borderWidth: points.map(p => p.style.width)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: משפחות 4+ ילדים ${p.x.toFixed(1)}%, ימין-חרדים ${p.y.toFixed(1)}%${p.style.label ? ' (' + p.style.label + ')' : ''}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: '% משפחות עם 4 ילדים ומעלה', color: '#8ba3c7' },
                    min: 0,
                    max: 20,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

// ==================== START ====================
// ==================== DISCLOSURES ====================
function renderDisclosures() {
    const container = document.getElementById('bloc-details');
    if (!container || !DATA.parties) return;
    
    const blocNames = {
        'right': 'ימין',
        'haredi': 'חרדים',
        'center': 'מרכז',
        'opposition_right': 'ימין אופוזיציוני',
        'left': 'שמאל',
        'arab': 'ערבים'
    };
    
    const blocColors = {
        'right': '#4a9eff',
        'haredi': '#9b59b6',
        'center': '#2ecc71',
        'opposition_right': '#00bcd4',
        'left': '#e74c3c',
        'arab': '#f39c12'
    };
    
    let html = '';
    
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    
    for (const k of elections) {
        if (!DATA.parties[k]) continue;
        
        const electionData = DATA.parties[k];
        const electionName = electionData.election_name || `כנסת ${k}`;
        
        html += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">`;
        html += `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.75rem;">${electionName}</div>`;
        
        // Group parties by bloc
        const blocs = { right: [], haredi: [], opposition_right: [], center: [], left: [], arab: [] };
        for (const party of electionData.party_list) {
            if (blocs[party.bloc]) {
                blocs[party.bloc].push(`${party.name} (${party.code})`);
            }
        }
        
        // Render each bloc
        for (const [bloc, parties] of Object.entries(blocs)) {
            if (parties.length > 0) {
                html += `<div style="margin-bottom: 0.5rem;">`;
                html += `<span style="color: ${blocColors[bloc]}; font-weight: 500;">${blocNames[bloc]}:</span> `;
                html += `<span style="color: var(--text-muted);">${parties.join(', ')}</span>`;
                html += `</div>`;
            }
        }
        
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', init);

// ==================== CORRELATION MATRIX ====================
function renderCorrelationMatrix(data, k, demoYear) {
    // Render both matrices with dynamic demographic year
    renderSingleCorrelationMatrix(data, k, 'correlation-matrix', 'all', demoYear);
    
    // Filter for Jewish-only municipalities (exclude Arab 60%+ and Druze 55%+)
    const jewishData = data.filter(m => !isArabLocality(m) && !isDruzeLocality(m));
    renderSingleCorrelationMatrix(jewishData, k, 'correlation-matrix-jewish', 'jewish', demoYear);
}

function renderSingleCorrelationMatrix(data, k, containerId, matrixType, demoYear) {
    const container = document.getElementById(containerId);
    
    // Define variables for correlation matrix
    // Use dynamic demographic year for socio fields
    // Russians excluded for pre-K21 (no religion data)
    const allVariables = [
        { key: 'income', label: 'הכנסה לנפש', getValue: m => getDemoValue(m, 'avg_monthly_income_per_capita', demoYear) },
        { key: 'academic', label: '% אקדמאים', getValue: m => getDemoValue(m, 'pct_academic_degree', demoYear) },
        { key: 'cluster', label: 'אשכול', getValue: m => getSocioCluster(m, demoYear) },
        { key: 'children', label: '% 4+ ילדים', getValue: m => getDemoValue(m, 'pct_families_4plus_children', demoYear), minElection: 19 },
        { key: 'russians', label: '% "רוסים"', getValue: m => m.religion?.pct_russians, minElection: 21 },
        { key: 'jews', label: '% יהודים', getValue: m => m.religion?.pct_jews, excludeFor: 'jewish', minElection: 21 },
        { key: 'arabs', label: '% ערבים', getValue: m => m.religion?.pct_arabs, excludeFor: 'jewish', minElection: 21 },
        { key: 'right_haredi', label: '% ימין-חרדים', getValue: m => m.election_data?.[k]?.right_haredi_pct },
        { key: 'haredi', label: '% חרדים', getValue: m => m.election_data?.[k]?.haredi_pct },
        { key: 'center_left', label: '% מרכז-שמאל', getValue: m => m.election_data?.[k]?.center_left_arab_pct },
    ];
    
    // Filter variables based on matrix type and data availability
    let variables = allVariables;
    
    // Exclude Jewish-only fields
    if (matrixType === 'jewish') {
        variables = variables.filter(v => v.excludeFor !== 'jewish');
    }
    
    // Exclude fields not available in 2008 (also applies to 1999/2003/2006 which fall back to 2008)
    if (demoYear === '2008' || demoYear === '2006' || demoYear === '2003' || demoYear === '1999') {
        variables = variables.filter(v => !v.notIn2008);
    }
    
    // Exclude religion fields for pre-K21
    const electionNum = parseInt(k);
    variables = variables.filter(v => !v.minElection || electionNum >= v.minElection);
    
    // Calculate WEIGHTED Pearson correlation
    function weightedPearsonCorrelation(v1, v2, dataset) {
        const pairs = [];
        for (let i = 0; i < dataset.length; i++) {
            const xVal = v1.getValue(dataset[i]);
            const yVal = v2.getValue(dataset[i]);
            // Weight by number of eligible voters in election k
            const weight = dataset[i].election_data?.[k]?.eligible || 0;
            
            if (xVal !== null && xVal !== undefined && !isNaN(xVal) && 
                yVal !== null && yVal !== undefined && !isNaN(yVal) && weight > 0) {
                pairs.push([xVal, yVal, weight]);
            }
        }
        
        if (pairs.length < 3) return null;
        
        // Weighted means
        const totalWeight = pairs.reduce((a, p) => a + p[2], 0);
        const meanX = pairs.reduce((a, p) => a + p[0] * p[2], 0) / totalWeight;
        const meanY = pairs.reduce((a, p) => a + p[1] * p[2], 0) / totalWeight;
        
        // Weighted covariance and standard deviations
        let covXY = 0, varX = 0, varY = 0;
        for (const [x, y, w] of pairs) {
            covXY += w * (x - meanX) * (y - meanY);
            varX += w * (x - meanX) * (x - meanX);
            varY += w * (y - meanY) * (y - meanY);
        }
        
        const den = Math.sqrt(varX * varY);
        return den === 0 ? 0 : covXY / den;
    }
    
    // Calculate all correlations
    const correlations = {};
    variables.forEach(v1 => {
        correlations[v1.key] = {};
        variables.forEach(v2 => {
            if (v1.key === v2.key) {
                correlations[v1.key][v2.key] = 1;
            } else {
                correlations[v1.key][v2.key] = weightedPearsonCorrelation(v1, v2, data);
            }
        });
    });
    
    // Get color for correlation value
    function getCorrelationColor(r) {
        if (r === null) return 'var(--bg-secondary)';
        if (r < 0) {
            const intensity = Math.min(Math.abs(r), 1);
            return `rgba(231, 76, 60, ${0.2 + intensity * 0.8})`;
        } else {
            const intensity = Math.min(Math.abs(r), 1);
            return `rgba(46, 204, 113, ${0.2 + intensity * 0.8})`;
        }
    }
    
    // Build the matrix HTML
    const n = variables.length;
    container.style.gridTemplateColumns = `80px repeat(${n}, 50px)`;
    
    let html = '';
    
    // Header row
    html += '<div class="correlation-cell row-header"></div>';
    variables.forEach(v => {
        html += `<div class="correlation-cell header">${v.label}</div>`;
    });
    
    // Data rows
    variables.forEach((v1, i) => {
        html += `<div class="correlation-cell row-header">${v1.label}</div>`;
        
        variables.forEach((v2, j) => {
            const r = correlations[v1.key][v2.key];
            const color = getCorrelationColor(r);
            const textColor = r !== null && Math.abs(r) > 0.5 ? '#fff' : 'var(--text-primary)';
            const displayValue = r !== null ? r.toFixed(2) : '-';
            const isDiagonal = i === j;
            
            html += `<div class="correlation-cell ${isDiagonal ? 'diagonal' : ''}" 
                         style="background: ${color}; color: ${textColor};"
                         data-var1="${v1.label}" data-var2="${v2.label}" data-value="${r !== null ? r.toFixed(3) : 'N/A'}"
                         onclick="showCorrelationTooltip(event, this)">
                        ${isDiagonal ? '1.00' : displayValue}
                    </div>`;
        });
    });
    
    container.innerHTML = html;
}

// Tooltip for correlation details
function showCorrelationTooltip(event, cell) {
    // Remove existing tooltip
    const existing = document.querySelector('.correlation-tooltip');
    if (existing) existing.remove();
    
    const var1 = cell.dataset.var1;
    const var2 = cell.dataset.var2;
    const value = parseFloat(cell.dataset.value);
    
    if (var1 === var2) return; // Don't show for diagonal
    
    const tooltip = document.createElement('div');
    tooltip.className = 'correlation-tooltip active';
    
    let interpretation = '';
    let valueClass = 'neutral';
    if (!isNaN(value)) {
        if (value > 0.7) { interpretation = 'מתאם חיובי חזק מאוד'; valueClass = 'positive'; }
        else if (value > 0.5) { interpretation = 'מתאם חיובי חזק'; valueClass = 'positive'; }
        else if (value > 0.3) { interpretation = 'מתאם חיובי בינוני'; valueClass = 'positive'; }
        else if (value > 0.1) { interpretation = 'מתאם חיובי חלש'; valueClass = 'positive'; }
        else if (value > -0.1) { interpretation = 'אין מתאם משמעותי'; valueClass = 'neutral'; }
        else if (value > -0.3) { interpretation = 'מתאם שלילי חלש'; valueClass = 'negative'; }
        else if (value > -0.5) { interpretation = 'מתאם שלילי בינוני'; valueClass = 'negative'; }
        else if (value > -0.7) { interpretation = 'מתאם שלילי חזק'; valueClass = 'negative'; }
        else { interpretation = 'מתאם שלילי חזק מאוד'; valueClass = 'negative'; }
    }
    
    tooltip.innerHTML = `
        <h4>${var1} ↔ ${var2}</h4>
        <div class="value ${valueClass}">${isNaN(value) ? 'N/A' : value.toFixed(3)}</div>
        <p>${interpretation}</p>
    `;
    
    document.body.appendChild(tooltip);
    
    // Position tooltip
    const rect = cell.getBoundingClientRect();
    tooltip.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
    tooltip.style.top = (rect.bottom + 10) + 'px';
    
    // Close on click outside
    setTimeout(() => {
        document.addEventListener('click', function closeTooltip(e) {
            if (!tooltip.contains(e.target) && e.target !== cell) {
                tooltip.remove();
                document.removeEventListener('click', closeTooltip);
            }
        });
    }, 100);
}

// ==================== GEOGRAPHIC SORTING ====================
function renderGeoSorting(socioData, demoYear) {
    // Filter to localities with education data (any year)
    const dataWithEdu = socioData.filter(m => m.election_data);
    
    renderSingleGeoSorting(dataWithEdu, 'sorting-all', 'all');
    
    // Jewish only
    const jewishData = dataWithEdu.filter(m => !isArabLocality(m) && !isDruzeLocality(m));
    renderSingleGeoSorting(jewishData, 'sorting-jewish', 'jewish');
}

function renderSingleGeoSorting(data, canvasId, chartKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts['sorting_' + chartKey]) charts['sorting_' + chartKey].destroy();
    
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    const electionLabels = elections.map(k => 'כנסת ' + k);
    
    // Get academic degree for a locality using the appropriate year
    function getAcademicForElection(m, k) {
        const year = getDemoYear(k);
        return getDemoValue(m, 'pct_academic_degree', year);
    }
    
    // Calculate mean and std dev for a given election's demographic year
    function calcMeanAndStd(dataSet, k) {
        const values = [];
        for (const m of dataSet) {
            const academic = getAcademicForElection(m, k);
            if (academic !== null && academic !== undefined && !isNaN(academic)) {
                values.push(academic);
            }
        }
        if (values.length === 0) return { mean: 0, std: 1 };
        
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / values.length;
        const std = Math.sqrt(variance);
        return { mean, std };
    }
    
    // Check if municipality is "educated" (more than 0.5 std above mean)
    function isHighEdu(m, k, stats) {
        const academic = getAcademicForElection(m, k);
        if (academic === null || academic === undefined) return null;
        const zScore = (academic - stats.mean) / stats.std;
        return zScore > 0.5;
    }
    
    // Calculate weighted average for each group per election
    // Groups are determined dynamically based on z-score threshold
    function weightedAvgByGroup(dataSet, k, highEduGroup) {
        const stats = calcMeanAndStd(dataSet, k);
        let totalWeight = 0, weightedSum = 0;
        
        for (const m of dataSet) {
            const isHigh = isHighEdu(m, k, stats);
            if (isHigh === null) continue;
            
            const inGroup = highEduGroup ? isHigh : !isHigh;
            if (!inGroup) continue;
            
            const elData = m.election_data?.[k];
            if (elData && elData.center_left_arab_pct !== undefined && elData.eligible > 0) {
                weightedSum += elData.center_left_arab_pct * elData.eligible;
                totalWeight += elData.eligible;
            }
        }
        return totalWeight > 0 ? weightedSum / totalWeight : null;
    }
    
    // Count group sizes for each election
    function countGroup(dataSet, k, highEduGroup) {
        const stats = calcMeanAndStd(dataSet, k);
        let count = 0;
        for (const m of dataSet) {
            const isHigh = isHighEdu(m, k, stats);
            if (isHigh === null) continue;
            const inGroup = highEduGroup ? isHigh : !isHigh;
            if (inGroup) count++;
        }
        return count;
    }
    
    const highEduData = elections.map(k => weightedAvgByGroup(data, k, true));
    const lowEduData = elections.map(k => weightedAvgByGroup(data, k, false));
    const gapData = elections.map((k, i) => 
        highEduData[i] !== null && lowEduData[i] !== null 
            ? highEduData[i] - lowEduData[i] 
            : null
    );
    
    // Get counts for each election for labels
    const highCounts = elections.map(k => countGroup(data, k, true));
    const lowCounts = elections.map(k => countGroup(data, k, false));
    const validHighCounts = highCounts.filter(c => c > 0);
    const validLowCounts = lowCounts.filter(c => c > 0);
    const highMin = Math.min(...validHighCounts);
    const highMax = Math.max(...validHighCounts);
    const lowMin = Math.min(...validLowCounts);
    const lowMax = Math.max(...validLowCounts);
    const highLabel = highMin === highMax ? `n=${highMin}` : `n=${highMin}-${highMax}`;
    const lowLabel = lowMin === lowMax ? `n=${lowMin}` : `n=${lowMin}-${lowMax}`;
    
    charts['sorting_' + chartKey] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: electionLabels,
            datasets: [
                {
                    label: `משכילים (>0.5 סטיות תקן, ${highLabel})`,
                    data: highEduData,
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c33',
                    tension: 0.3,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: `פחות משכילים (≤0.5 סטיות תקן, ${lowLabel})`,
                    data: lowEduData,
                    borderColor: '#3498db',
                    backgroundColor: '#3498db33',
                    tension: 0.3,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'הפער',
                    data: gapData,
                    borderColor: '#f1c40f',
                    backgroundColor: '#f1c40f33',
                    borderDash: [5, 5],
                    tension: 0.3,
                    pointRadius: 4,
                    yAxisID: 'y2'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { size: 10 } }
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${ctx.raw !== null ? ctx.raw.toFixed(1) + '%' : 'N/A'}`
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8ba3c7', font: { size: 9 } },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: '% מרכז-שמאל-ערבים', color: '#8ba3c7' },
                    min: 0,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: v => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'הפער', color: '#f1c40f' },
                    min: 0,
                    max: 50,
                    ticks: { color: '#f1c40f', callback: v => v + '%' },
                    grid: { display: false }
                }
            }
        }
    });
}

// ==================== CORRELATION TRENDS OVER TIME ====================
function renderCorrelationTrends(data) {
    // Render both charts
    renderSingleCorrelationTrends(data, 'correlation-trends-all', 'all');
    
    // Filter for Jewish-only municipalities
    const jewishData = data.filter(m => !isArabLocality(m) && !isDruzeLocality(m));
    renderSingleCorrelationTrends(jewishData, 'correlation-trends-jewish', 'jewish');
}

function renderSingleCorrelationTrends(data, canvasId, chartKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts['correlationTrends_' + chartKey]) charts['correlationTrends_' + chartKey].destroy();
    
    // Elections to analyze (all 12)
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    const electionLabels = elections.map(k => 'כנסת ' + k);
    
    // Variables to correlate with center-left
    // Russians only available for K21+
    // Income and academic use dynamic year per election
    const correlationPairs = [
        { key: 'income', label: 'הכנסה לנפש', getValueForElection: (m, k) => getDemoValue(m, 'avg_monthly_income_per_capita', getDemoYear(k)), color: '#2ecc71' },
        { key: 'academic', label: '% אקדמאים', getValueForElection: (m, k) => getDemoValue(m, 'pct_academic_degree', getDemoYear(k)), color: '#3498db' },
        { key: 'russians', label: '% "רוסים"', getValueForElection: (m, k) => m.religion?.pct_russians, color: '#9b59b6', minElection: 21 }
    ];
    
    // Calculate weighted correlation for a specific election
    function calcWeightedCorrelation(v1GetValue, v2GetValue, dataset, k) {
        const pairs = [];
        for (const m of dataset) {
            const xVal = v1GetValue(m);
            const yVal = v2GetValue(m);
            const weight = m.election_data?.[k]?.eligible || 0;
            
            if (xVal !== null && xVal !== undefined && !isNaN(xVal) && 
                yVal !== null && yVal !== undefined && !isNaN(yVal) && weight > 0) {
                pairs.push([xVal, yVal, weight]);
            }
        }
        
        if (pairs.length < 3) return null;
        
        const totalWeight = pairs.reduce((a, p) => a + p[2], 0);
        const meanX = pairs.reduce((a, p) => a + p[0] * p[2], 0) / totalWeight;
        const meanY = pairs.reduce((a, p) => a + p[1] * p[2], 0) / totalWeight;
        
        let covXY = 0, varX = 0, varY = 0;
        for (const [x, y, w] of pairs) {
            covXY += w * (x - meanX) * (y - meanY);
            varX += w * (x - meanX) * (x - meanX);
            varY += w * (y - meanY) * (y - meanY);
        }
        
        const den = Math.sqrt(varX * varY);
        return den === 0 ? 0 : covXY / den;
    }
    
    // Build datasets for each correlation pair
    const datasets = correlationPairs.map(pair => {
        const correlations = elections.map(k => {
            // Skip if election is below minimum for this variable
            if (pair.minElection && parseInt(k) < pair.minElection) {
                return null;
            }
            // Filter data to only include municipalities with data for this election
            const validData = data.filter(m => m.election_data?.[k]);
            return calcWeightedCorrelation(
                m => pair.getValueForElection(m, k),
                m => m.election_data?.[k]?.center_left_arab_pct,
                validData,
                k
            );
        });
        
        return {
            label: pair.label,
            data: correlations,
            borderColor: pair.color,
            backgroundColor: pair.color + '33',
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: false
        };
    });
    
    charts['correlationTrends_' + chartKey] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: electionLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#8ba3c7', font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${ctx.raw !== null ? ctx.raw.toFixed(3) : 'N/A'}`
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8ba3c7', font: { size: 10 } },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'מקדם מתאם', color: '#8ba3c7' },
                    min: -1,
                    max: 1,
                    ticks: { 
                        color: '#8ba3c7',
                        callback: (v) => v.toFixed(1)
                    },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}


function renderScatterRussians(data, k, demoYear) {
    const ctx = document.getElementById('scatter-russians').getContext('2d');
    
    if (charts.scatterRussians) charts.scatterRussians.destroy();
    
    // Hide for elections before K21 (no religion data available)
    const container = document.getElementById('scatter-russians')?.closest('.chart-container');
    if (parseInt(k) < 21) {
        if (container) container.style.display = 'none';
        return;
    }
    if (container) container.style.display = 'block';
    
    // Filter: has religion data, has meaningful Russian population (>1%)
    // Note: Russian data comes from religion field (2019), not socio-economic year
    // Cluster colors use socio_cluster_2021
    const points = data.filter(m => 
        m.religion && 
        m.religion.pct_russians !== undefined &&
        (m.socio_cluster_2021 || m.socio_cluster) &&  // Must have cluster data for coloring
        m.religion.pct_jews > 50 &&  // Only Jewish-majority cities for this analysis
        m.election_data?.[k]?.right_haredi_pct !== undefined
    ).map(m => ({
        x: m.religion.pct_russians,
        y: m.election_data[k].right_haredi_pct,
        r: Math.sqrt(m.election_data[k].eligible || 1000) / 15,
        name: m.name,
        cluster: m.socio_cluster_2021 || m.socio_cluster  // Use 2021 cluster
    }));

    charts.scatterRussians = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => getClusterColor(p.cluster) + '99'),
                borderColor: points.map(p => getClusterColor(p.cluster)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const p = ctx.raw;
                            return `${p.name}: "רוסים" ${p.x.toFixed(1)}%, ימין-חרדים ${p.y.toFixed(1)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: '% ללא סיווג דת ("רוסים")', color: '#8ba3c7' },
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '% ימין-חרדים', color: '#8ba3c7' },
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#8ba3c7', callback: (v) => v + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        }
    });
}

// ==================== COALITION BUILDER ====================
let coalitionState = {
    election: '25',
    selected: new Set()
};

function initCoalitionBuilder() {
    const select = document.getElementById('coalition-election-select');
    select.addEventListener('change', (e) => {
        coalitionState.election = e.target.value;
        coalitionState.selected.clear();
        renderCoalitionParties();
        updateCoalitionCounter();
    });
    
    renderCoalitionParties();
}

function renderCoalitionParties() {
    const container = document.getElementById('coalition-parties');
    const election = coalitionState.election;
    const parties = DATA.parties?.[election];
    
    if (!parties || !parties.seats) {
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 1rem;">אין נתונים</div>';
        return;
    }
    
    const seats = parties.seats;
    const partyList = parties.party_list || [];
    
    // Build code to info mapping
    const partyInfo = {};
    for (const p of partyList) {
        partyInfo[p.code] = { name: p.name, bloc: p.bloc };
    }
    
    // Sort by seats descending
    const sortedParties = Object.entries(seats)
        .sort((a, b) => b[1] - a[1])
        .map(([code, seatCount]) => ({
            code,
            seats: seatCount,
            name: partyInfo[code]?.name || code,
            bloc: partyInfo[code]?.bloc || 'other'
        }));
    
    const blocColors = {
        'right': 'var(--color-right)',
        'haredi': 'var(--color-haredi)',
        'center': 'var(--color-center)',
        'opposition_right': 'var(--color-opposition-right)',
        'left': 'var(--color-left)',
        'arab': 'var(--color-arab)',
        'other': 'var(--text-muted)'
    };
    
    container.innerHTML = sortedParties.map(p => `
        <div class="coalition-party ${coalitionState.selected.has(p.code) ? 'selected' : ''}" 
             data-code="${p.code}" onclick="toggleCoalitionParty('${p.code}')">
            <div class="coalition-party-color" style="background: ${blocColors[p.bloc]}"></div>
            <div class="coalition-party-info">
                <div class="coalition-party-name">${p.name}</div>
            </div>
            <div class="coalition-party-seats">${p.seats}</div>
        </div>
    `).join('');
}

function toggleCoalitionParty(code) {
    if (coalitionState.selected.has(code)) {
        coalitionState.selected.delete(code);
    } else {
        coalitionState.selected.add(code);
    }
    
    // Update UI
    document.querySelectorAll('.coalition-party').forEach(el => {
        if (el.dataset.code === code) {
            el.classList.toggle('selected');
        }
    });
    
    updateCoalitionCounter();
}

function updateCoalitionCounter() {
    const seats = DATA.parties?.[coalitionState.election]?.seats || {};
    let total = 0;
    
    for (const code of coalitionState.selected) {
        total += seats[code] || 0;
    }
    
    document.getElementById('coalition-count').textContent = total;
    
    const progressBar = document.getElementById('coalition-progress-bar');
    const percentage = Math.min((total / 120) * 100, 100);
    progressBar.style.width = percentage + '%';
    
    const statusEl = document.getElementById('coalition-status');
    if (total >= 61) {
        statusEl.textContent = `קואליציה! (${total} מנדטים)`;
        statusEl.className = 'coalition-status success';
        progressBar.classList.add('success');
    } else {
        statusEl.textContent = `חסרים ${61 - total} מנדטים`;
        statusEl.className = 'coalition-status pending';
        progressBar.classList.remove('success');
    }
}

function resetCoalition() {
    coalitionState.selected.clear();
    renderCoalitionParties();
    updateCoalitionCounter();
}

// ==================== REGRESSION MODEL ====================

function showModelPanel(panel) {
    document.querySelectorAll('.model-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.model-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-' + panel).classList.add('active');
    document.querySelector(`.model-tab[data-panel="${panel}"]`).classList.add('active');
}

// Feature definitions for the model
const MODEL_FEATURES = [
    { key: 'avg_monthly_income_per_capita', label: 'הכנסה חודשית לנפש', short: 'הכנסה', color: '#4a9eff' },
    { key: 'pct_academic_degree', label: '% אקדמאים', short: 'אקדמאים', color: '#2ecc71' },
    { key: 'pct_families_4plus_children', label: '% משפחות 4+ ילדים', short: '4+ ילדים', color: '#9b59b6' },
    { key: 'median_age', label: 'גיל חציוני', short: 'גיל חציוני', color: '#1abc9c' },
    { key: 'dependency_ratio', label: 'יחס תלות', short: 'יחס תלות', color: '#e74c3c' },
    { key: 'pct_below_min_wage', label: '% מתחת לשכר מינימום', short: 'מתחת למינימום', color: '#f39c12' },
    { key: 'avg_days_abroad', label: 'ימי שהייה בחו״ל', short: 'ימים בחו״ל', color: '#3498db' },
    { key: 'vehicles_per_100_residents', label: 'רכבים ל-100 תושבים', short: 'רכבים/100', color: '#00bcd4' },
    { key: 'pct_income_support', label: '% נתמכי הבטחת הכנסה', short: 'הבטחת הכנסה', color: '#ff6b6b' },
    { key: 'pct_arabs', label: '% ערבים', short: 'ערבים', color: '#c0392b',
      minElection: 21,
      getValue: (m, demoYear) => {
          if (!m.religion || m.religion.pct_arabs == null) return null;
          // Jerusalem: ~38% Arab but Arab turnout in Knesset elections is ~1-2%
          // due to political boycott over East Jerusalem status
          if (m.name === 'ירושלים') return 2;
          return m.religion.pct_arabs;
      } },
    { key: 'pct_druze', label: '% דרוזים', short: 'דרוזים', color: '#7f8c8d',
      minElection: 21,
      getValue: (m, demoYear) => m.religion && m.religion.pct_druze != null ? m.religion.pct_druze : null },
    { key: 'pct_russians', label: '% "רוסים" (ללא סיווג דת)', short: 'רוסים', color: '#e67e22',
      minElection: 21,
      getValue: (m, demoYear) => m.religion && m.religion.pct_russians != null ? m.religion.pct_russians : null },
    { key: 'beyond_green_line', label: 'מעבר לקו הירוק', short: 'קו ירוק', color: '#27ae60',
      getValue: (m, demoYear) => m.beyond_green_line != null ? m.beyond_green_line : null }
];

// Helper: get feature value — uses custom getValue if defined, else getDemoValue
function getFeatureValue(m, feature, demoYear) {
    if (feature.getValue) return feature.getValue(m, demoYear);
    return getDemoValue(m, feature.key, demoYear);
}

// ==================== RIDGE LOGIT REGRESSION ENGINE ====================
// Logit transformation for bounded [0,100] vote shares +
// Ridge (L2) regularization to handle multicollinearity +
// Weighted by eligible voters + Cross-validation for lambda.
//
// Ridge solves: min Σ wᵢ(yᵢ - Xᵢβ)² + λΣβⱼ²
// This prevents correlated features (income ↔ academics) from
// producing unstable, sign-flipping coefficients.

function logit(p) {
    const q = Math.max(0.001, Math.min(0.999, p));
    return Math.log(q / (1 - q));
}

function sigmoid(z) {
    if (z > 20) return 1;
    if (z < -20) return 0;
    return 1 / (1 + Math.exp(-z));
}

// Core Ridge solver: standardized inputs, returns raw beta on standardized scale
// Xa: n×(p+1) with intercept column, wN: normalized weights, yLogit: transformed y
// lambda: penalty (applied to all but intercept)
function ridgeSolve(Xa, yLogit, wN, lambda) {
    const n = Xa.length;
    const pa = Xa[0].length;
    
    // X^T W X + λI (no penalty on intercept)
    const XtWX = Array.from({ length: pa }, (_, i) =>
        Array.from({ length: pa }, (_, j) => {
            let val = Xa.reduce((s, row, idx) => s + wN[idx] * row[i] * row[j], 0);
            if (i === j && i > 0) val += lambda; // L2 penalty
            return val;
        })
    );
    
    const XtWy = Array.from({ length: pa }, (_, i) =>
        Xa.reduce((s, row, idx) => s + wN[idx] * row[i] * yLogit[idx], 0)
    );
    
    // Gaussian elimination
    const aug = XtWX.map((row, i) => [...row, XtWy[i]]);
    for (let col = 0; col < pa; col++) {
        let maxRow = col;
        for (let row = col + 1; row < pa; row++) {
            if (Math.abs(aug[row][col]) > Math.abs(aug[maxRow][col])) maxRow = row;
        }
        [aug[col], aug[maxRow]] = [aug[maxRow], aug[col]];
        if (Math.abs(aug[col][col]) < 1e-12) continue;
        for (let row = 0; row < pa; row++) {
            if (row === col) continue;
            const factor = aug[row][col] / aug[col][col];
            for (let j = col; j <= pa; j++) aug[row][j] -= factor * aug[col][j];
        }
    }
    return aug.map((row, i) => row[pa] / row[i]);
}

// K-fold cross-validation to select best lambda
function cvRidge(X, yPct, w, lambdas, kFolds) {
    const n = X.length;
    const p = X[0].length;
    const yLogit = yPct.map(v => logit(v / 100));
    const wSum = w.reduce((a, b) => a + b, 0);
    const wNorm = w.map(v => v * n / wSum);
    
    // Standardize features (needed for fair Ridge penalty)
    const wTotal = wNorm.reduce((a, b) => a + b, 0);
    const xMeans = Array.from({ length: p }, (_, j) =>
        X.reduce((s, row, i) => s + wNorm[i] * row[j], 0) / wTotal
    );
    const xStds = Array.from({ length: p }, (_, j) => {
        const m = xMeans[j];
        return Math.sqrt(X.reduce((s, row, i) => s + wNorm[i] * (row[j] - m) ** 2, 0) / wTotal) || 1;
    });
    const Xstd = X.map(row => row.map((v, j) => (v - xMeans[j]) / xStds[j]));
    const XaStd = Xstd.map(row => [1, ...row]);
    
    // Create fold indices (shuffle deterministically)
    const indices = Array.from({ length: n }, (_, i) => i);
    // Simple deterministic shuffle based on index
    for (let i = n - 1; i > 0; i--) {
        const j = (i * 7 + 3) % (i + 1);
        [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    const foldSize = Math.ceil(n / kFolds);
    
    const cvScores = lambdas.map(lambda => {
        let totalErr = 0;
        let totalW = 0;
        
        for (let fold = 0; fold < kFolds; fold++) {
            const testIdx = new Set();
            for (let i = fold * foldSize; i < Math.min((fold + 1) * foldSize, n); i++) {
                testIdx.add(indices[i]);
            }
            
            const trainXa = [], trainY = [], trainW = [];
            const testXa = [], testY = [], testW = [];
            
            for (let i = 0; i < n; i++) {
                if (testIdx.has(i)) {
                    testXa.push(XaStd[i]);
                    testY.push(yLogit[i]);
                    testW.push(wNorm[i]);
                } else {
                    trainXa.push(XaStd[i]);
                    trainY.push(yLogit[i]);
                    trainW.push(wNorm[i]);
                }
            }
            
            if (trainXa.length < 5 || testXa.length < 2) continue;
            
            const beta = ridgeSolve(trainXa, trainY, trainW, lambda);
            
            // Weighted MSE on test fold (percentage scale)
            for (let i = 0; i < testXa.length; i++) {
                const predLogit = testXa[i].reduce((s, v, j) => s + v * beta[j], 0);
                const predPct = sigmoid(predLogit) * 100;
                const actualPct = (1 / (1 + Math.exp(-testY[i]))) * 100;
                totalErr += testW[i] * (actualPct - predPct) ** 2;
                totalW += testW[i];
            }
        }
        
        return { lambda, mse: totalW > 0 ? totalErr / totalW : Infinity };
    });
    
    // Return lambda with lowest CV MSE
    cvScores.sort((a, b) => a.mse - b.mse);
    return { bestLambda: cvScores[0].lambda, cvScores };
}

// Full Ridge Logit Regression with CV
function logitRidgeRegression(X, yPct, w) {
    const n = X.length;
    const p = X[0].length;
    
    const yLogit = yPct.map(v => logit(v / 100));
    const wSum = w.reduce((a, b) => a + b, 0);
    const wNorm = w.map(v => v * n / wSum);
    const wTotal = wNorm.reduce((a, b) => a + b, 0);
    
    // Standardize features
    const xMeans = Array.from({ length: p }, (_, j) =>
        X.reduce((s, row, i) => s + wNorm[i] * row[j], 0) / wTotal
    );
    const xStds = Array.from({ length: p }, (_, j) => {
        const m = xMeans[j];
        return Math.sqrt(X.reduce((s, row, i) => s + wNorm[i] * (row[j] - m) ** 2, 0) / wTotal) || 1;
    });
    const Xstd = X.map(row => row.map((v, j) => (v - xMeans[j]) / xStds[j]));
    const XaStd = Xstd.map(row => [1, ...row]);
    
    // Cross-validate lambda
    const lambdas = [0.001, 0.01, 0.05, 0.1, 0.25, 0.5, 1, 2, 5, 10, 25, 50, 100];
    const { bestLambda, cvScores } = cvRidge(X, yPct, w, lambdas, 5);
    
    // Fit on full data with best lambda
    const betaStd = ridgeSolve(XaStd, yLogit, wNorm, bestLambda);
    
    // Convert back to original scale: beta_orig[j] = betaStd[j+1] / xStds[j]
    // intercept adjusts for the centering
    const betaOrig = [betaStd[0]];
    for (let j = 0; j < p; j++) {
        betaOrig.push(betaStd[j + 1] / xStds[j]);
        betaOrig[0] -= betaStd[j + 1] * xMeans[j] / xStds[j];
    }
    
    // Predictions
    const yHatLogit = X.map(row => {
        let z = betaOrig[0];
        row.forEach((v, j) => z += betaOrig[j + 1] * v);
        return z;
    });
    const yHat = yHatLogit.map(z => sigmoid(z) * 100);
    
    // R² on percentage scale
    const yWMean = yPct.reduce((s, v, i) => s + wNorm[i] * v, 0) / wTotal;
    const ssTot = yPct.reduce((s, v, i) => s + wNorm[i] * (v - yWMean) ** 2, 0);
    const ssRes = yPct.reduce((s, v, i) => s + wNorm[i] * (v - yHat[i]) ** 2, 0);
    const r2 = ssTot > 0 ? 1 - ssRes / ssTot : 0;
    const r2adj = 1 - (1 - r2) * (n - 1) / Math.max(n - p - 1, 1);
    
    // Standardized beta weights (betaStd[1..p] are already on standardized scale)
    const yLogitWMean = yLogit.reduce((s, v, i) => s + wNorm[i] * v, 0) / wTotal;
    const yLogitWStd = Math.sqrt(yLogit.reduce((s, v, i) => s + wNorm[i] * (v - yLogitWMean) ** 2, 0) / wTotal) || 1;
    const betaStdNorm = betaStd.slice(1).map(b => b / yLogitWStd);
    
    const residuals = yPct.map((v, i) => v - yHat[i]);
    
    return { beta: betaOrig, yHat, yHatLogit, r2, r2adj, betaStd: betaStdNorm, residuals, bestLambda, cvScores };
}

// Weighted R² for single feature (logit-transformed, weighted — no ridge needed for univariate)
function singleFeatureR2(x, yPct, w) {
    const n = x.length;
    if (n < 3) return 0;
    const wSum = w.reduce((a, b) => a + b, 0);
    const wN = w.map(v => v * n / wSum);
    
    const yLogit = yPct.map(v => logit(v / 100));
    
    const wTotal = wN.reduce((a, b) => a + b, 0);
    const xM = x.reduce((s, v, i) => s + wN[i] * v, 0) / wTotal;
    const yM = yLogit.reduce((s, v, i) => s + wN[i] * v, 0) / wTotal;
    
    const ssxy = x.reduce((s, v, i) => s + wN[i] * (v - xM) * (yLogit[i] - yM), 0);
    const ssx = x.reduce((s, v, i) => s + wN[i] * (v - xM) ** 2, 0);
    if (ssx === 0) return 0;
    
    const bSlope = ssxy / ssx;
    const bIntercept = yM - bSlope * xM;
    const yHat = x.map(v => sigmoid(bIntercept + bSlope * v) * 100);
    
    const yPctWMean = yPct.reduce((s, v, i) => s + wN[i] * v, 0) / wTotal;
    const ssTot = yPct.reduce((s, v, i) => s + wN[i] * (v - yPctWMean) ** 2, 0);
    const ssRes = yPct.reduce((s, v, i) => s + wN[i] * (v - yHat[i]) ** 2, 0);
    return ssTot > 0 ? Math.max(0, 1 - ssRes / ssTot) : 0;
}

// Prepare data for model
function prepareModelData(data, k, demoYear, jewishOnly) {
    const kNum = parseInt(k);
    return data.filter(m => {
        if (!m.election_data || !m.election_data[k]) return false;
        const pct = m.election_data[k].right_haredi_pct;
        if (pct === null || pct === undefined) return false;
        // For Jewish-only model: exclude majority-Arab and majority-Druze localities
        // but INCLUDE mixed cities (Jerusalem, Haifa, Lod, etc.)
        // The model uses pct_arabs as a control variable to adjust for Arab population share
        if (jewishOnly) {
            if (m.religion && m.religion.pct_arabs != null) {
                if (m.religion.pct_arabs >= 50 || m.religion.pct_druze >= 50) return false;
            } else {
                if (isArabLocality(m) || isDruzeLocality(m)) return false;
            }
        }
        let hasFeatures = 0;
        MODEL_FEATURES.forEach(f => {
            if (f.minElection && kNum < f.minElection) return;
            const v = getFeatureValue(m, f, demoYear);
            if (v !== null && v !== undefined) hasFeatures++;
        });
        return hasFeatures >= 4;
    });
}

function buildModel(data, k, demoYear, jewishOnly) {
    const kNum = parseInt(k);
    const filtered = prepareModelData(data, k, demoYear, jewishOnly);
    if (filtered.length < 10) return null;
    
    // Filter MODEL_FEATURES by minElection, then by availability (≥50%)
    const eligibleFeatures = MODEL_FEATURES.filter(f => !f.minElection || kNum >= f.minElection);
    
    const availableFeatures = eligibleFeatures.filter(f => {
        const count = filtered.filter(m => {
            const v = getFeatureValue(m, f, demoYear);
            return v !== null && v !== undefined && !isNaN(v);
        }).length;
        return count >= filtered.length * 0.5;
    });
    
    if (availableFeatures.length < 2) return null;
    
    // Keep only entries with ALL available features
    const complete = filtered.filter(m =>
        availableFeatures.every(f => {
            const v = getFeatureValue(m, f, demoYear);
            return v !== null && v !== undefined && !isNaN(v);
        })
    );
    
    if (complete.length < 10) return null;
    
    const X = complete.map(m => availableFeatures.map(f => getFeatureValue(m, f, demoYear)));
    const y = complete.map(m => m.election_data[k].right_haredi_pct);
    const weights = complete.map(m => m.election_data[k].eligible || 1000);
    const names = complete.map(m => m.name);
    
    const result = logitRidgeRegression(X, y, weights);
    
    // Individual feature R²
    const individualR2 = availableFeatures.map((f, j) => {
        const xj = complete.map(m => getFeatureValue(m, f, demoYear));
        return { feature: f, r2: singleFeatureR2(xj, y, weights) };
    });
    
    // Feature ranges for prediction sliders
    const ranges = availableFeatures.map((f, j) => {
        const vals = X.map(row => row[j]).slice().sort((a, b) => a - b);
        return {
            min: vals[0],
            max: vals[vals.length - 1],
            mean: vals.reduce((a, b) => a + b, 0) / vals.length,
            median: vals[Math.floor(vals.length / 2)]
        };
    });
    
    return {
        ...result,
        features: availableFeatures,
        individualR2,
        names,
        y,
        X,
        weights,
        ranges,
        n: complete.length,
        entries: complete,
        jewishOnly
    };
}

function renderRegressionModel(data, k, demoYear) {
    const modelAll = buildModel(data, k, demoYear, false);
    const modelJewish = buildModel(data, k, demoYear, true);
    
    if (!modelAll) return;
    
    // Store both models globally for cross-panel use
    window._modelAll = modelAll;
    window._modelJewish = modelJewish;
    
    renderR2Box(modelAll, modelJewish);
    renderFeatureImportance(modelAll, 'importance-all');
    if (modelJewish) renderFeatureImportance(modelJewish, 'importance-jewish');
    renderPredictedVsActual(modelAll, modelJewish);
    renderOutliers(modelAll, modelJewish);
    renderResiduals(modelAll);
    renderPredictorSliders(modelAll, modelJewish);
    renderTimeTrends(data);
}

function renderR2Box(modelAll, modelJewish) {
    const box = document.getElementById('model-r2-box');
    box.innerHTML = `
        <div class="r2-card">
            <div class="label">R² — כל הרשויות (${modelAll.n})</div>
            <div class="value">${(modelAll.r2 * 100).toFixed(1)}%</div>
            <div class="sub">${modelAll.features.length} משתנים · λ=${modelAll.bestLambda}</div>
        </div>
        <div class="r2-card">
            <div class="label">R² מתואם — כל הרשויות</div>
            <div class="value">${(modelAll.r2adj * 100).toFixed(1)}%</div>
            <div class="sub">Ridge + logit + משוקלל</div>
        </div>
        ${modelJewish ? `
        <div class="r2-card">
            <div class="label">R² — רוב יהודי (${modelJewish.n})</div>
            <div class="value">${(modelJewish.r2 * 100).toFixed(1)}%</div>
            <div class="sub">λ=${modelJewish.bestLambda}</div>
        </div>
        <div class="r2-card">
            <div class="label">R² מתואם — רוב יהודי</div>
            <div class="value">${(modelJewish.r2adj * 100).toFixed(1)}%</div>
            <div class="sub">ללא רשויות ערביות/דרוזיות</div>
        </div>` : ''}
    `;
}

function renderFeatureImportance(model, containerId) {
    const container = document.getElementById(containerId);
    
    // Sort by absolute standardized beta
    const sorted = model.features.map((f, i) => ({
        feature: f,
        betaStd: model.betaStd[i],
        r2: model.individualR2[i].r2
    })).sort((a, b) => Math.abs(b.betaStd) - Math.abs(a.betaStd));
    
    const maxAbs = Math.max(...sorted.map(s => Math.abs(s.betaStd)), 0.01);
    
    container.innerHTML = sorted.map(s => {
        const pct = (Math.abs(s.betaStd) / maxAbs * 100).toFixed(0);
        const sign = s.betaStd > 0 ? '+' : '−';
        const color = s.betaStd > 0 ? 'var(--color-right)' : 'var(--color-negative)';
        return `
            <div class="feature-bar-item">
                <div class="feature-bar-label">
                    <span>${s.feature.label}</span>
                    <span class="val" style="color: ${color}">${sign}${Math.abs(s.betaStd).toFixed(3)} (R²=${(s.r2 * 100).toFixed(1)}%)</span>
                </div>
                <div class="feature-bar-track">
                    <div class="feature-bar-fill" style="width: ${pct}%; background: ${color};"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderPredictedVsActual(modelAll, modelJewish) {
    const demoYear = getDemoYear(state.socioElection);
    
    const renderScatter = (model, canvasId, chartKey) => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[chartKey]) charts[chartKey].destroy();
        
        if (!model) return;
        
        const points = model.y.map((actual, i) => ({
            x: model.yHat[i],
            y: actual,
            name: model.names[i],
            r: Math.max(3, Math.sqrt(model.weights[i]) / 30)
        }));
        
        const allVals = [...model.y, ...model.yHat];
        const minV = Math.min(...allVals, 0);
        const maxV = Math.max(...allVals, 100);
        
        charts[chartKey] = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [
                    {
                        data: points,
                        backgroundColor: points.map((_, i) => getPointStyle(model.entries[i], demoYear).bg),
                        borderColor: points.map((_, i) => getPointStyle(model.entries[i], demoYear).border),
                        borderWidth: 1
                    },
                    {
                        type: 'line',
                        label: 'קו מושלם',
                        data: [{ x: minV, y: minV }, { x: maxV, y: maxV }],
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        rtl: true,
                        textDirection: 'rtl',
                        callbacks: {
                            label: (ctx) => {
                                if (ctx.datasetIndex >= 1) return '';
                                const p = ctx.raw;
                                const resid = p.y - p.x;
                                const sign = resid >= 0 ? '+' : '';
                                return [`${p.name}`, `בפועל: ${p.y.toFixed(1)}% | צפוי: ${p.x.toFixed(1)}%`, `שארית: ${sign}${resid.toFixed(1)}%`];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: '% ימין-חרדים — תחזית (Ridge logit)', color: '#8ba3c7' },
                        ticks: { color: '#5a7194' },
                        grid: { color: 'rgba(74, 158, 255, 0.08)' }
                    },
                    y: {
                        title: { display: true, text: '% ימין-חרדים — בפועל', color: '#8ba3c7' },
                        ticks: { color: '#5a7194' },
                        grid: { color: 'rgba(74, 158, 255, 0.08)' }
                    }
                }
            }
        });
    };
    
    renderScatter(modelAll, 'model-predicted-vs-actual', 'modelPredVsActual');
    renderScatter(modelJewish, 'model-predicted-vs-actual-jewish', 'modelPredVsActualJewish');
}

function renderOutliers(modelAll, modelJewish) {
    const demoYear = getDemoYear(state.socioElection);
    
    const makeOutlierList = (model) => {
        return model.names.map((name, i) => ({
            name,
            actual: model.y[i],
            predicted: model.yHat[i],
            residual: model.residuals[i],
            eligible: model.weights[i],
            entry: model.entries[i]
        })).sort((a, b) => b.residual - a.residual);
    };
    
    const makeTable = (items, tableId) => {
        const table = document.getElementById(tableId);
        table.innerHTML = `
            <thead><tr>
                <th>רשות</th>
                <th>% בפועל</th>
                <th>% צפוי</th>
                <th>הפרש</th>
                <th>אשכול</th>
                <th>בוחרים</th>
            </tr></thead>
            <tbody>
                ${items.map(item => {
                    const cluster = getSocioCluster(item.entry, demoYear);
                    const cls = item.residual > 0 ? 'residual-positive' : 'residual-negative';
                    const sign = item.residual > 0 ? '+' : '';
                    return `<tr>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.actual.toFixed(1)}%</td>
                        <td>${item.predicted.toFixed(1)}%</td>
                        <td class="${cls}">${sign}${item.residual.toFixed(1)}%</td>
                        <td>${cluster || '—'}</td>
                        <td>${Math.round(item.eligible).toLocaleString()}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        `;
    };
    
    const outliersAll = makeOutlierList(modelAll);
    makeTable(outliersAll.slice(0, 10), 'outlier-table-positive');
    makeTable(outliersAll.slice(-10).reverse(), 'outlier-table-negative');
}

function renderResiduals(model) {
    const ctx = document.getElementById('model-residuals-chart').getContext('2d');
    if (charts.modelResiduals) charts.modelResiduals.destroy();
    
    const sorted = model.names.map((name, i) => ({
        name,
        residual: model.residuals[i],
        entry: model.entries[i]
    })).sort((a, b) => a.residual - b.residual);
    
    charts.modelResiduals = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(s => s.name),
            datasets: [{
                data: sorted.map(s => s.residual),
                backgroundColor: sorted.map(s => s.residual > 0 ? 'rgba(74, 158, 255, 0.6)' : 'rgba(231, 76, 60, 0.6)'),
                borderColor: sorted.map(s => s.residual > 0 ? '#4a9eff' : '#e74c3c'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: (ctx) => {
                            const sign = ctx.raw > 0 ? '+' : '';
                            return `שארית: ${sign}${ctx.raw.toFixed(1)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    title: { display: true, text: 'שארית (בפועל − צפוי)', color: '#8ba3c7' },
                    ticks: { color: '#5a7194' },
                    grid: { color: 'rgba(74, 158, 255, 0.08)' }
                }
            }
        }
    });
}

function renderPredictorSliders(modelAll, modelJewish) {
    const primary = modelJewish || modelAll;
    const secondary = modelJewish ? modelAll : null;
    
    const container = document.getElementById('predictor-sliders');
    container.innerHTML = primary.features.map((f, i) => {
        const range = primary.ranges[i];
        const isBinary = (range.min === 0 && range.max === 1);
        const step = isBinary ? 1 : (range.max - range.min) / 200;
        const displayVal = isBinary ? (range.median >= 0.5 ? '1 (כן)' : '0 (לא)') : range.median.toFixed(1);
        return `
            <div class="pred-input-group">
                <label>${f.label}</label>
                <input type="range" 
                    id="pred-slider-${i}" 
                    min="${isBinary ? '0' : range.min.toFixed(2)}" 
                    max="${isBinary ? '1' : range.max.toFixed(2)}" 
                    step="${isBinary ? '1' : step.toFixed(4)}" 
                    value="${range.median.toFixed(2)}"
                    data-binary="${isBinary ? '1' : '0'}"
                    oninput="updatePrediction()">
                <div class="range-info">
                    <span>${isBinary ? '1 (כן)' : range.max.toFixed(1)}</span>
                    <span class="current" id="pred-val-${i}">${displayVal}</span>
                    <span>${isBinary ? '0 (לא)' : range.min.toFixed(1)}</span>
                </div>
            </div>
        `;
    }).join('');
    
    window._predModel = modelAll;
    updatePrediction();
}

function updatePrediction() {
    const model = window._predModel;
    if (!model) return;
    
    const values = model.features.map((f, i) => {
        const slider = document.getElementById(`pred-slider-${i}`);
        const val = parseFloat(slider.value);
        const isBinary = slider.dataset.binary === '1';
        document.getElementById(`pred-val-${i}`).textContent = isBinary ? (val >= 0.5 ? '1 (כן)' : '0 (לא)') : val.toFixed(1);
        return val;
    });
    
    // Ridge logit prediction: sigmoid(beta[0] + sum(beta[i+1] * x[i])) * 100
    const predictWithModel = (m) => {
        let z = m.beta[0];
        values.forEach((v, i) => z += m.beta[i + 1] * v);
        return sigmoid(z) * 100;
    };
    
    const pred = predictWithModel(model);
    
    document.getElementById('prediction-value').textContent = pred.toFixed(1) + '%';
    document.getElementById('prediction-marker').style.left = pred + '%';
    
    let compareText = '';
    
    // Find closest real locality
    let closestDist = Infinity;
    let closestName = '';
    let closestActual = 0;
    model.entries.forEach((m, idx) => {
        const dist = model.features.reduce((s, f, j) => {
            const range = model.ranges[j].max - model.ranges[j].min;
            if (range === 0) return s;
            return s + ((getFeatureValue(m, f, getDemoYear(state.socioElection)) - values[j]) / range) ** 2;
        }, 0);
        if (dist < closestDist) {
            closestDist = dist;
            closestName = m.name;
            closestActual = model.y[idx];
        }
    });
    
    const parts = [];
    if (closestName) parts.push(`הפרופיל הקרוב ביותר: ${closestName} (בפועל: ${closestActual.toFixed(1)}%)`);
    if (compareText) parts.push(compareText);
    document.getElementById('pred-compare-note').innerHTML = parts.join('<br>');
}

function renderTimeTrends(data) {
    const elections = ['14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25'];
    const elLabels = elections.map(e => 'כנסת ' + e);
    
    const buildTrendData = (jewishOnly) => {
        const datasets = {};
        const fullR2 = [];
        
        MODEL_FEATURES.forEach(f => {
            datasets[f.key] = { label: f.short, data: [], color: f.color };
        });
        
        elections.forEach(k => {
            const demoYear = getDemoYear(k);
            const filtered = prepareModelData(data, k, demoYear, jewishOnly);
            
            MODEL_FEATURES.forEach(f => {
                const kNum = parseInt(k);
                if (f.minElection && kNum < f.minElection) {
                    datasets[f.key].data.push(null);
                    return;
                }
                const valid = filtered.filter(m => {
                    const v = getFeatureValue(m, f, demoYear);
                    return v !== null && v !== undefined && !isNaN(v) && m.election_data[k];
                });
                if (valid.length < 10) {
                    datasets[f.key].data.push(null);
                    return;
                }
                const x = valid.map(m => getFeatureValue(m, f, demoYear));
                const yPct = valid.map(m => m.election_data[k].right_haredi_pct);
                const w = valid.map(m => m.election_data[k].eligible || 1000);
                datasets[f.key].data.push(singleFeatureR2(x, yPct, w));
            });
            
            const model = buildModel(data, k, demoYear, jewishOnly);
            fullR2.push(model ? model.r2 : null);
        });
        
        return { datasets, fullR2 };
    };
    
    const renderTrendChart = (canvasId, trendData, chartKey) => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[chartKey]) charts[chartKey].destroy();
        
        const ds = Object.values(trendData.datasets).filter(d => d.data.some(v => v !== null));
        
        charts[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: elLabels,
                datasets: ds.map(d => ({
                    label: d.label,
                    data: d.data,
                    borderColor: d.color,
                    backgroundColor: d.color + '22',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0.3,
                    spanGaps: true
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        rtl: true,
                        labels: { color: '#8ba3c7', font: { size: 11 }, boxWidth: 12, padding: 8 }
                    },
                    tooltip: {
                        rtl: true,
                        textDirection: 'rtl',
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: R²=${(ctx.raw * 100).toFixed(1)}%`
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: '#5a7194' }, grid: { color: 'rgba(74, 158, 255, 0.08)' } },
                    y: {
                        min: 0, max: 1,
                        title: { display: true, text: 'R²', color: '#8ba3c7' },
                        ticks: { color: '#5a7194', callback: v => (v * 100).toFixed(0) + '%' },
                        grid: { color: 'rgba(74, 158, 255, 0.08)' }
                    }
                }
            }
        });
    };
    
    const trendAll = buildTrendData(false);
    const trendJewish = buildTrendData(true);
    
    renderTrendChart('model-time-trends-all', trendAll, 'modelTimeTrendsAll');
    renderTrendChart('model-time-trends-jewish', trendJewish, 'modelTimeTrendsJewish');
    
    // Full model R² over time — emphasizing both populations
    const ctxR2 = document.getElementById('model-r2-over-time').getContext('2d');
    if (charts.modelR2OverTime) charts.modelR2OverTime.destroy();
    
    charts.modelR2OverTime = new Chart(ctxR2, {
        type: 'line',
        data: {
            labels: elLabels,
            datasets: [
                {
                    label: 'כל הרשויות (' + (window._modelAll ? window._modelAll.n : '') + ')',
                    data: trendAll.fullR2,
                    borderColor: '#4a9eff',
                    backgroundColor: 'rgba(74, 158, 255, 0.1)',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: true,
                    spanGaps: true
                },
                {
                    label: 'רוב יהודי (' + (window._modelJewish ? window._modelJewish.n : '') + ')',
                    data: trendJewish.fullR2,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.3,
                    fill: true,
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    rtl: true,
                    labels: { color: '#8ba3c7', font: { size: 12 } }
                },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: R²=${(ctx.raw * 100).toFixed(1)}%`
                    }
                }
            },
            scales: {
                x: { ticks: { color: '#5a7194' }, grid: { color: 'rgba(74, 158, 255, 0.08)' } },
                y: {
                    min: 0, max: 1,
                    title: { display: true, text: 'R² של המודל המלא (logit, משוקלל)', color: '#8ba3c7' },
                    ticks: { color: '#5a7194', callback: v => (v * 100).toFixed(0) + '%' },
                    grid: { color: 'rgba(74, 158, 255, 0.08)' }
                }
            }
        }
    });
}

    </script>
</body>
</html>
